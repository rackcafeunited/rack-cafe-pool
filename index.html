<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rack Café Utd - Pool League</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-dark: #0a0a14; --bg-card: #151520; --primary-pink: #e94560; --primary-pink-dark: #d63d56; --accent-orange: #f39c12; --gold-primary: #ffd700; --text-primary: #ffffff; --text-secondary: #a0a0b8; --text-muted: #606070; --border-color: #2a2a3a; --success: #2ed573; --danger: #ff4757; --info: #00ffff; --reserve-color: #9b59b6; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1420 100%); color: var(--text-primary); min-height: 100vh; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .sync-indicator { animation: spin 1s linear infinite; }
        
        .maintenance-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0a0a1a 0%, #1a0a20 100%); z-index: 2147483647; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; }
        .maintenance-overlay.active { display: flex !important; animation: fadeIn 0.3s ease; }
        .maintenance-icon { font-size: 80px; color: #ff4757; margin-bottom: 30px; animation: pulse 2s infinite; text-shadow: 0 0 30px rgba(255, 71, 87, 0.5); }
        .maintenance-title { font-size: 36px; font-weight: 900; margin-bottom: 16px; background: linear-gradient(135deg, #ff4757, #ff6348); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .login-screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: radial-gradient(circle at center, #151525 0%, #0a0a14 100%); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999998; }
        .login-screen.show { display: flex; }
        .logo { width: 110px; height: 110px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #e94560 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(233, 69, 96, 0.4); position: relative; cursor: pointer; }
        .logo::before { content: ''; position: absolute; width: 50%; height: 50%; border: 5px solid rgba(255,255,255,0.95); border-radius: 50%; }
        .logo::after { content: ''; position: absolute; width: 22%; height: 22%; background: white; border-radius: 50%; }
        .login-card { background: rgba(21, 21, 32, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px; width: 100%; max-width: 420px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6); animation: slideUp 0.6s ease; }
        .login-header { text-align: center; margin-bottom: 35px; }
        .login-header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 800; }
        .login-header p { color: var(--text-secondary); font-size: 14px; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; font-weight: 700; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 16px 16px 16px 48px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: white; font-size: 15px; transition: all 0.3s; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-pink); background: rgba(255, 255, 255, 0.08); }
        .form-textarea { min-height: 100px; resize: vertical; padding: 16px; }
        .login-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; box-shadow: 0 4px 25px rgba(233, 69, 96, 0.4); transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 35px rgba(233, 69, 96, 0.5); }
        .login-btn.secondary { background: rgba(255,255,255,0.1); margin-top: 10px; }
        .login-error { background: rgba(233, 69, 96, 0.1); border: 1px solid rgba(233, 69, 96, 0.3); color: #ff4757; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; display: none; align-items: center; gap: 8px; }
        .login-error.show { display: flex; }
        
        .dashboard { display: none; min-height: 100vh; padding-bottom: 90px; }
        .dashboard.active { display: block; animation: fadeIn 0.5s; }
        .header { background: rgba(15, 15, 25, 0.98); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 42px; height: 42px; background: linear-gradient(135deg, #ff6b35 0%, #e94560 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; }
        .header-logo::before { content: ''; position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; }
        .header-logo::after { content: ''; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; }
        .header-title h2 { font-size: 17px; font-weight: 800; display: flex; align-items: center; }
        .header-title p { font-size: 12px; color: var(--text-secondary); }
        .header-right { display: flex; align-items: center; gap: 12px; position: relative; }
        .sync-badge { background: rgba(46, 213, 115, 0.15); color: #2ed573; padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(46, 213, 115, 0.3); cursor: pointer; transition: all 0.3s; }
        .sync-badge.syncing { background: rgba(243, 156, 18, 0.15); color: var(--accent-orange); border-color: rgba(243, 156, 18, 0.3); }
        .sync-badge.offline { background: rgba(255, 71, 87, 0.15); color: #ff4757; border-color: rgba(255, 71, 87, 0.3); }
        .profile-container { position: relative; display: none; }
        .profile-container.show { display: block; }
        .avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-orange) 0%, var(--primary-pink) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; overflow: hidden; }
        .avatar:hover { transform: scale(1.05); border-color: rgba(233, 69, 96, 0.5); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dropdown-menu { position: absolute; top: calc(100% + 12px); right: 0; background: rgba(21, 21, 32, 0.98); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 16px; padding: 8px; min-width: 280px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; }
        .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; color: var(--text-primary); font-size: 14px; font-weight: 600; }
        .dropdown-item:hover { background: rgba(255, 255, 255, 0.05); }
        .dropdown-item.system-creator { color: #00ffff; background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.2); margin: 4px 0; }
        .dropdown-divider { height: 1px; background: var(--border-color); margin: 8px 0; }
        .user-info { padding: 12px 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px; }
        .user-name { font-weight: 800; font-size: 15px; margin-bottom: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }
        .user-role { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .main-content { padding: 24px 20px; max-width: 1000px; margin: 0 auto; }
        .page-title { margin-bottom: 24px; }
        .page-title h1 { font-size: 32px; margin-bottom: 6px; font-weight: 800; }
        .page-title p { color: var(--text-secondary); font-size: 15px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        
        .next-match-card { background: linear-gradient(135deg, #e94560 0%, #c73e54 100%); border-radius: 20px; padding: 28px; margin-bottom: 24px; position: relative; overflow: hidden; box-shadow: 0 15px 50px rgba(233, 69, 96, 0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px 10px; text-align: center; transition: all 0.3s; }
        .stat-value { font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #e94560, #f39c12); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 6px; }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        
        .form-panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .form-display { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
        .form-badge { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; }
        .form-w { background: rgba(46, 213, 115, 0.2); color: #2ed573; border: 1px solid rgba(46, 213, 115, 0.3); }
        .form-l { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }
        .form-d { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid rgba(255, 215, 0, 0.3); }
        
        .announcement-card { background: linear-gradient(135deg, rgba(233,69,96,0.1) 0%, rgba(255,215,0,0.05) 100%); border: 1px solid rgba(233,69,96,0.3); border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative; }
        .announcement-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .announcement-date { font-size: 11px; color: var(--text-muted); }
        .announcement-delete { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(255,71,87,0.2); border: none; color: #ff4757; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        
        .training-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
        .training-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .training-date { font-size: 20px; font-weight: 800; color: var(--primary-pink); }
        .training-time { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 12px; }
        .attendee { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; text-align: center; font-size: 12px; border: 1px solid transparent; transition: all 0.3s; cursor: pointer; }
        .attendee:hover { border-color: var(--success); }
        .attendee.confirmed { background: rgba(46, 213, 115, 0.1); border-color: var(--success); color: #2ed573; }
        .attendee.declined { opacity: 0.5; background: rgba(255, 71, 87, 0.1); }
        .attendance-btn { margin-top: 12px; padding: 8px 16px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; margin-right: 8px; }
        .btn-yes { background: rgba(46, 213, 115, 0.2); color: #2ed573; border: 1px solid rgba(46, 213, 115, 0.3); }
        .btn-no { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }
        
        .frame-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 20px 0; }
        @media (max-width: 768px) { .frame-grid { grid-template-columns: repeat(2, 1fr); } }
        .frame-box { background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 16px; text-align: center; position: relative; cursor: pointer; transition: all 0.3s; }
        .frame-box:hover { border-color: var(--primary-pink); }
        .frame-box.won { border-color: var(--success); background: rgba(46, 213, 115, 0.05); }
        .frame-box.lost { border-color: var(--danger); background: rgba(255, 71, 87, 0.05); }
        .frame-number { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--bg-card); padding: 0 8px; font-size: 12px; color: var(--text-muted); font-weight: 700; }
        .frame-result { font-size: 24px; font-weight: 800; margin-bottom: 4px; }
        .frame-player { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.3s ease; }
        .modal-container.wide { max-width: 900px; }
        .modal-header { background: linear-gradient(135deg, rgba(233,69,96,0.2) 0%, rgba(243,156,18,0.1) 100%); padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: rgba(255,255,255,0.2); }
        .modal-body { padding: 24px; }
        .submit-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin-top: 24px; transition: all 0.3s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4); }
        .submit-btn.secondary { background: rgba(255,255,255,0.1); margin-top: 12px; }
        
        .admin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        @media (max-width: 768px) { .admin-grid { grid-template-columns: 1fr; } }
        .admin-btn { background: rgba(212, 175, 55, 0.15); border: 1px solid rgba(212, 175, 55, 0.3); color: var(--gold-primary); padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.3s; font-family: inherit; font-weight: 700; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .admin-btn:hover { background: rgba(212, 175, 55, 0.25); transform: translateY(-2px); }
        
        #systemCreatorModal .modal-container { border: 2px solid rgba(0, 255, 255, 0.3); }
        #systemCreatorModal .modal-title { color: #00ffff; }
        
        .role-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 8px; border: 1px solid; vertical-align: middle; }
        .badge-system-creator { background: rgba(0, 255, 255, 0.15); border-color: #00ffff; color: #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); }
        .badge-captain { background: rgba(255, 215, 0, 0.15); border-color: #ffd700; color: #ffd700; }
        .badge-co-captain { background: rgba(243, 156, 18, 0.15); border-color: #f39c12; color: #f39c12; }
        .badge-player { background: rgba(160, 160, 184, 0.15); border-color: var(--text-secondary); color: var(--text-secondary); }
        
        .fixture-card { background: #151520; border: 1px solid #2a2a3a; border-radius: 16px; padding: 20px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; }
        .fixture-card:hover { border-color: var(--primary-pink); }
        .fixture-date { min-width: 60px; text-align: center; margin-right: 20px; }
        .date-day { font-size: 28px; font-weight: 900; color: #e94560; line-height: 1; }
        
        .delete-fixture-btn { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 12px; transition: all 0.2s; }
        .delete-fixture-btn:hover { background: rgba(255, 71, 87, 0.4); transform: scale(1.1); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 15, 25, 0.98); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 12px 0 20px; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #606070; text-decoration: none; font-size: 10px; font-weight: 700; padding: 8px; border-radius: 16px; flex: 1; max-width: 90px; transition: all 0.3s; cursor: pointer; background: none; border: none; font-family: inherit; }
        .nav-item.active { color: var(--primary-pink); }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--border-color); padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 12px; z-index: 2000; opacity: 0; transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .header-login-btn { background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 10px; color: white; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .header-login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4); }
        .header-login-btn.hidden { display: none !important; }
        
        .player-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color); }
        .player-list-item:hover { border-color: var(--primary-pink); }
        .role-select { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; padding: 6px; border-radius: 6px; font-size: 13px; }
        
        .login-info-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .login-info-table th, .login-info-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .login-info-table th { color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
        .last-login { color: var(--success); font-size: 11px; }
        
        .game-history-item { display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary-pink); }
        .game-history-list { max-height: 400px; overflow-y: auto; }
        
        .notification-badge { position: absolute; top: -5px; right: -5px; background: #ff4757; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; }
        
        .section-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; font-weight: 800; font-size: 18px; }
        .section-title i { color: var(--primary-pink); margin-right: 8px; }
        
        .connection-status { position: fixed; top: 80px; right: 20px; background: rgba(255, 71, 87, 0.9); color: white; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 700; display: none; align-items: center; gap: 8px; z-index: 1001; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); animation: slideUp 0.3s ease; }
        .connection-status.show { display: flex; }
        .connection-status.online { background: rgba(46, 213, 115, 0.9); }
        
        .admin-btn.danger { background: rgba(255, 71, 87, 0.15); border-color: rgba(255, 71, 87, 0.4); color: #ff4757; }
        .admin-btn.danger:hover { background: rgba(255, 71, 87, 0.25); transform: translateY(-2px); box-shadow: 0 0 20px rgba(255, 71, 87, 0.3); }

        /* NEW PROFILE PAGE STYLES */
        .profile-grid { display: grid; grid-template-columns: 320px 1fr; gap: 24px; margin-bottom: 24px; }
        @media (max-width: 768px) { .profile-grid { grid-template-columns: 1fr; } }
        
        .profile-card-main { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 28px; text-align: center; height: fit-content; position: relative; }
        
        .profile-avatar-container { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; cursor: pointer; border-radius: 50%; overflow: hidden; }
        .profile-avatar-container:hover .avatar-overlay { opacity: 1; }
        .profile-avatar-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--primary-pink); }
        .profile-avatar-container .initials-avatar { width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, var(--accent-orange), var(--primary-pink)); display: flex; align-items: center; justify-content: center; font-size: 42px; font-weight: 800; border: 3px solid var(--border-color); transition: all 0.3s; }
        .profile-avatar-container:hover .initials-avatar { border-color: var(--primary-pink); }
        
        .avatar-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; color: white; font-size: 24px; }
        
        .profile-name { font-size: 22px; font-weight: 800; margin-bottom: 4px; color: var(--text-primary); }
        .profile-team { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
        
        .profile-info-rows { text-align: left; margin-top: 20px; }
        .profile-info-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .profile-info-row:last-child { border-bottom: none; }
        .profile-info-label { color: var(--text-muted); font-weight: 600; }
        .profile-info-value { color: var(--text-primary); font-weight: 500; word-break: break-all; flex: 1; text-align: right; margin-left: 12px; }
        
        .edit-field-btn { background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; transition: all 0.2s; }
        .edit-field-btn:hover { background: rgba(0, 255, 255, 0.2); transform: scale(1.1); }
        
        .profile-right-section { display: flex; flex-direction: column; gap: 24px; }
        
        .profile-stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        @media (max-width: 500px) { .profile-stats-row { grid-template-columns: 1fr; } }
        
        .profile-stat-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; text-align: center; transition: all 0.3s; }
        .profile-stat-box:hover { transform: translateY(-2px); border-color: var(--primary-pink); }
        
        .stat-number-lg { font-size: 36px; font-weight: 900; color: var(--primary-pink); line-height: 1; margin-bottom: 8px; }
        .stat-label-small { font-size: 12px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .stat-percentage { font-size: 13px; color: var(--text-muted); }
        
        .profile-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        
        .section-header-green { background: #1a5f3f; color: white; padding: 16px 20px; font-weight: 700; font-size: 14px; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        
        .section-content { padding: 20px; }
        
        .empty-state { border: 2px dashed var(--border-color); border-radius: 8px; padding: 40px 20px; text-align: center; color: var(--text-muted); }
        .empty-state-title { font-weight: 700; color: var(--text-primary); margin-bottom: 8px; font-size: 15px; }
        
        .history-table-wrapper { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; margin-top: 24px; }
        
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { background: #1a5f3f; color: white; padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 700; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); }
        .history-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-size: 14px; }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table tr:hover td { background: rgba(255,255,255,0.03); }
        .history-table tr.editing td { background: rgba(0, 255, 255, 0.05); }
        .text-center { text-align: center; }
        
        .player-selector { background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 24px; }
        .player-selector label { font-size: 12px; color: #00ffff; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; display: block; margin-bottom: 8px; }
        .player-selector select { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0, 255, 255, 0.3); color: white; border-radius: 8px; font-size: 14px; }
        
        .add-season-btn { background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .add-season-btn:hover { background: rgba(0, 255, 255, 0.2); transform: translateY(-1px); }
        
        .season-actions { display: flex; gap: 6px; }
        .season-edit-btn { background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00ffff; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; }
        .season-delete-btn { background: rgba(255, 71, 87, 0.1); border: 1px solid rgba(255, 71, 87, 0.3); color: #ff4757; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; }
        .season-edit-btn:hover { background: rgba(0, 255, 255, 0.2); }
        .season-delete-btn:hover { background: rgba(255, 71, 87, 0.2); }
    </style>
</head>
<body>

    <div id="connectionStatus" class="connection-status">
        <i class="fas fa-wifi"></i>
        <span id="connectionText">Offline - Changes will sync when reconnected</span>
    </div>

    <div id="maintenanceOverlay" class="maintenance-overlay">
        <i class="fas fa-radiation maintenance-icon"></i>
        <div class="maintenance-title">SYSTEM MAINTENANCE</div>
        <div id="maintenanceMessageText" class="maintenance-message">
            The server is currently undergoing scheduled maintenance.<br>
            Only authorized System Administrators may access this platform.
        </div>
        <button onclick="attemptMaintenanceLogin()" class="login-btn" style="width: auto; padding: 12px 32px; background: rgba(0,0,0,0.5); border: 1px solid #00ffff; color: #00ffff; margin-top: 20px;">
            <i class="fas fa-terminal"></i> SYS_ADMIN LOGIN
        </button>
        <div style="position: fixed; bottom: 40px; font-size: 12px; color: rgba(255, 255, 255, 0.3); font-family: monospace;">
            Press <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>M</kbd>
        </div>
    </div>

    <div class="login-screen" id="loginScreen">
        <div class="logo" id="loginLogo"></div>
        <div class="login-card">
            <div class="login-header"><h1>Rack Café Utd</h1><p style="color: var(--text-secondary);">Huddersfield Tuesday Night Pool League</p></div>
            <div class="login-error" id="loginError"><i class="fas fa-exclamation-circle"></i><span id="errorText">Invalid credentials</span></div>
            <form onsubmit="event.preventDefault(); doLogin();">
                <div class="form-group"><label class="form-label">Username</label><div class="input-wrapper"><i class="fas fa-user"></i><input type="text" class="form-input" id="usernameInput" required autocomplete="username"></div></div>
                <div class="form-group"><label class="form-label">Password</label><div class="input-wrapper"><i class="fas fa-lock"></i><input type="password" class="form-input" id="passwordInput" required autocomplete="current-password"></div></div>
                <button type="submit" class="login-btn" id="loginBtn"><i class="fas fa-arrow-right-to-bracket"></i> LOGIN</button>
                <button type="button" class="login-btn secondary" onclick="cancelLogin()"><i class="fas fa-times"></i> Cancel</button>
            </form>
        </div>
    </div>

    <div class="dashboard active" id="dashboard">
        <header class="header">
            <div class="header-left">
                <div class="header-logo"></div>
                <div class="header-title">
                    <h2>Rack Café Utd <span id="headerRoleBadge"></span></h2>
                    <p>Huddersfield Tuesday Night Pool League</p>
                </div>
            </div>
            <div class="header-right">
                <div class="sync-badge" id="syncBadge" onclick="manualSync()">
                    <i class="fas fa-check-circle" id="syncIcon"></i>
                    <span id="syncStatus">Synced</span>
                </div>
                <button id="headerLoginBtn" class="header-login-btn" onclick="showLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
                <div class="profile-container" id="profileContainer">
                    <div class="avatar" id="userAvatar" onclick="toggleDropdown(event)">--</div>
                    <div class="dropdown-menu" id="profileDropdown">
                        <div class="user-info">
                            <div class="user-name" id="dropdownUserName">
                                <span id="userNameText">User</span>
                                <span id="userBadge"></span>
                            </div>
                            <div class="user-role" id="dropdownUserRole"><i class="fas fa-user"></i> <span id="roleText">Player</span></div>
                        </div>
                        <div class="dropdown-item" onclick="switchTab('profileTab'); closeDropdown();"><i class="fas fa-user"></i> My Profile</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="openAdminPanel(); closeDropdown();" id="adminMenuItem" style="display: none; color: var(--gold-primary);">
                            <i class="fas fa-shield-alt"></i> Admin Panel
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="logout()" style="color: #ff4757;"><i class="fas fa-sign-out-alt"></i> Log Out</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="tab-content active" id="homeTab">
                <div class="page-title">
                    <h1>Dashboard</h1>
                    <p id="welcomeText">Welcome to Rack Café Utd</p>
                </div>
                
                <div class="form-panel">
                    <div class="section-title"><span><i class="fas fa-chart-line"></i> Live Form</span></div>
                    <div class="form-display" id="wwldwPanel">
                        <div class="form-badge form-w">W</div>
                        <div class="form-badge form-w">W</div>
                        <div class="form-badge form-l">L</div>
                        <div class="form-badge form-d">D</div>
                        <div class="form-badge form-w">W</div>
                    </div>
                    <div style="text-align: center; margin-top: 12px; font-size: 13px; color: var(--text-muted);">Last 5 Matches</div>
                </div>

                <div class="form-panel" id="announcementsPanel" style="display: none;">
                    <div class="section-title"><span><i class="fas fa-bullhorn"></i> Latest Announcements</span></div>
                    <div id="announcementsList"></div>
                </div>

                <div id="nextMatchCard" class="next-match-card" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9;"><i class="fas fa-calendar-check"></i> Next Match</div>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700;" id="nextMatchVenue">Home</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
                        <div style="text-align: center; flex: 1;"><div style="font-size: 20px; font-weight: 800;">Rack Café Utd</div></div>
                        <div style="font-size: 24px; font-weight: 700; opacity: 0.8;">VS</div>
                        <div style="text-align: center; flex: 1;"><div style="font-size: 20px; font-weight: 800;" id="nextMatchOpponent">TBD</div></div>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                        <div style="text-align: center;"><i class="fas fa-calendar" style="font-size: 24px; margin-bottom: 8px; opacity: 0.8;"></i><div style="font-size: 12px; text-transform: uppercase; opacity: 0.7;">Date</div><div style="font-weight: 700; margin-top: 4px;" id="nextMatchDate">TBC</div></div>
                        <div style="text-align: center;"><i class="fas fa-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.8;"></i><div style="font-size: 12px; text-transform: uppercase; opacity: 0.7;">Kickoff</div><div style="font-weight: 700; margin-top: 4px; color: #ffd700;" id="nextMatchTime">--:--</div></div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="statPosition">--</div><div class="stat-label">Position</div></div>
                    <div class="stat-card"><div class="stat-value" id="statPlayed">0</div><div class="stat-label">Played</div></div>
                    <div class="stat-card"><div class="stat-value" id="statWon">0</div><div class="stat-label">Won</div></div>
                    <div class="stat-card"><div class="stat-value" id="statWinRate">0%</div><div class="stat-label">Win Rate</div></div>
                </div>
            </div>

            <div class="tab-content" id="fixturesTab">
                <div class="page-title"><h1>Fixtures</h1><p>2025/26 Season</p></div>
                <div style="display: flex; gap: 10px; margin-bottom: 24px;">
                    <button class="admin-btn" onclick="filterFixtures('all', this)" style="width: 100%; background: linear-gradient(135deg, #e94560 0%, #d63d56 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 700; cursor: pointer; flex: 1;">All</button>
                    <button class="admin-btn" onclick="filterFixtures('upcoming', this)" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 25px; font-weight: 700; cursor: pointer; flex: 1;">Upcoming</button>
                </div>
                <div id="fixturesList"></div>
            </div>

            <div class="tab-content" id="tableTab">
                <div class="page-title"><h1>League Table</h1><p>Current Standings</p></div>
                <div id="leagueTable"></div>
            </div>

            <div class="tab-content" id="teamTab">
                <div class="page-title"><h1>Squad</h1><p>Team Roster & Roles</p></div>
                <div id="teamList"></div>
            </div>

            <div class="tab-content" id="trainingTab">
                <div class="page-title"><h1>Training</h1><p>Schedule & Attendance</p></div>
                <div id="adminTrainingControls" style="display: none; margin-bottom: 20px;">
                    <button class="admin-btn" onclick="openScheduleTrainingModal()" style="width: 100%; margin-bottom: 16px; background: var(--primary-pink); color: white; border: none;">
                        <i class="fas fa-plus"></i> Schedule Training Session
                    </button>
                </div>
                <div id="trainingList"></div>
            </div>

            <div class="tab-content" id="scorecardTab">
                <div class="page-title"><h1>Scorecards</h1><p>Frame-by-Frame Results</p></div>
                <div id="scorecardList"></div>
            </div>

            <div class="tab-content" id="profileTab">
                <div class="page-title">
                    <h1 id="profilePageTitle">My Profile</h1>
                    <p id="profilePageSubtitle">Player Statistics & History</p>
                </div>
                
                <!-- Player Selector for System Creator -->
                <div id="systemCreatorPlayerSelector" class="player-selector" style="display: none;">
                    <label><i class="fas fa-users-cog" style="margin-right: 6px;"></i>System Creator: Select Player to View/Edit</label>
                    <select id="profilePlayerSelect" onchange="changeProfileView(this.value)">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                
                <div id="profileContent">
                    <!-- Profile content injected by renderProfile() -->
                </div>
                
                <!-- Hidden file input for profile picture -->
                <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicChange(event)">
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('homeTab', this)"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-item" onclick="switchTab('fixturesTab', this)"><i class="fas fa-calendar-days"></i><span>Fixtures</span></button>
            <button class="nav-item" onclick="requireAuth('trainingTab', this)"><i class="fas fa-dumbbell"></i><span>Training</span></button>
            <button class="nav-item" onclick="requireAuth('scorecardTab', this)"><i class="fas fa-table-list"></i><span>Scores</span></button>
            <button class="nav-item" onclick="requireAuth('teamTab', this)"><i class="fas fa-users"></i><span>Team</span></button>
        </nav>
    </div>

    <!-- Edit Profile Field Modal -->
    <div class="modal-overlay" id="editProfileFieldModal">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,255,255,0.05) 100%); border-bottom: 1px solid rgba(0,255,255,0.2);">
                <div class="modal-title" style="color: #00ffff;"><i class="fas fa-edit"></i> Edit <span id="editFieldName"></span></div>
                <button class="modal-close" onclick="closeModal('editProfileFieldModal')" style="color: #00ffff;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" id="editFieldLabel">Value</label>
                    <input type="text" class="form-input" id="editFieldValue" style="padding-left: 16px; width: 100%;" placeholder="Enter value...">
                </div>
                <button class="submit-btn" onclick="saveProfileFieldEdit()" style="background: linear-gradient(135deg, rgba(0,255,255,0.8) 0%, rgba(0,200,255,0.8) 100%);">
                    <i class="fas fa-save" style="margin-right: 8px;"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Season Modal -->
    <div class="modal-overlay" id="editSeasonModal">
        <div class="modal-container">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,255,255,0.05) 100%); border-bottom: 1px solid rgba(0,255,255,0.2);">
                <div class="modal-title" style="color: #00ffff;"><i class="fas fa-calendar-alt"></i> <span id="seasonModalTitle">Edit Season</span></div>
                <button class="modal-close" onclick="closeModal('editSeasonModal')" style="color: #00ffff;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSeasonIndex" value="-1">
                <div class="form-group">
                    <label class="form-label">Season</label>
                    <input type="text" class="form-input" id="editSeasonName" style="padding-left: 16px; width: 100%;" placeholder="e.g., Feb 25">
                </div>
                <div class="form-group">
                    <label class="form-label">Ruleset</label>
                    <input type="text" class="form-input" id="editSeasonRuleset" style="padding-left: 16px; width: 100%;" placeholder="e.g., EPA Rules">
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Pl (Played)</label>
                        <input type="number" class="form-input" id="editSeasonPlayed" style="padding-left: 16px; width: 100%;" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">W (Won)</label>
                        <input type="number" class="form-input" id="editSeasonWon" style="padding-left: 16px; width: 100%;" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">L (Lost)</label>
                        <input type="number" class="form-input" id="editSeasonLost" style="padding-left: 16px; width: 100%;" min="0" value="0">
                    </div>
                </div>
                <button class="submit-btn" onclick="saveSeasonEdit()" style="background: linear-gradient(135deg, rgba(0,255,255,0.8) 0%, rgba(0,200,255,0.8) 100%);">
                    <i class="fas fa-save" style="margin-right: 8px;"></i> Save Season
                </button>
                <button type="button" class="submit-btn secondary" onclick="closeModal('editSeasonModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="adminPanelModal">
        <div class="modal-container">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(212,175,55,0.2) 0%, rgba(243,156,18,0.1) 100%); border-bottom: 1px solid rgba(212, 175, 55, 0.3);">
                <div class="modal-title" style="color: var(--gold-primary);"><i class="fas fa-shield-alt"></i> Admin Panel</div>
                <button class="modal-close" onclick="closeModal('adminPanelModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                    Captain & Co-Captain Controls
                </div>
                <div class="admin-grid">
                    <button class="admin-btn" onclick="closeModal('adminPanelModal'); openAddResultModal()">
                        <i class="fas fa-plus-circle" style="font-size: 24px;"></i> Add Result
                    </button>
                    <button class="admin-btn" onclick="closeModal('adminPanelModal'); openScheduleModal()">
                        <i class="fas fa-calendar-plus" style="font-size: 24px;"></i> Schedule
                    </button>
                    <button class="admin-btn" onclick="closeModal('adminPanelModal'); openAnnouncementModal()">
                        <i class="fas fa-bullhorn" style="font-size: 24px;"></i> Announcement
                    </button>
                    <button class="admin-btn" onclick="closeModal('adminPanelModal'); openRoleManagerModal()" id="adminRoleManagerBtn">
                        <i class="fas fa-user-tag" style="font-size: 24px;"></i> Manage Roles
                    </button>
                </div>
                
                <div id="adminPanelSystemCreatorSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                    <div style="color: #00ffff; margin-bottom: 16px; font-size: 14px; font-weight: 700;">
                        <i class="fas fa-terminal"></i> System Creator Tools
                    </div>
                    <div class="admin-grid">
                        <button class="admin-btn" onclick="closeModal('adminPanelModal'); openPlayerManagerModal()" style="background: rgba(0, 255, 255, 0.1); border-color: rgba(0, 255, 255, 0.3); color: #00ffff;">
                            <i class="fas fa-users-cog" style="font-size: 24px;"></i> Manage Players
                        </button>
                        <button class="admin-btn" onclick="closeModal('adminPanelModal'); openLoginInfoModal()" style="background: rgba(0, 255, 255, 0.1); border-color: rgba(0, 255, 255, 0.3); color: #00ffff;">
                            <i class="fas fa-history" style="font-size: 24px;"></i> Login History
                        </button>
                        <button class="admin-btn" onclick="closeModal('adminPanelModal'); toggleMaintenanceMode()" style="background: rgba(255, 71, 87, 0.1); border-color: rgba(255, 71, 87, 0.3); color: #ff4757;">
                            <i class="fas fa-radiation" style="font-size: 24px;"></i> Maintenance
                        </button>
                        <button class="admin-btn" onclick="closeModal('adminPanelModal'); openSystemCreatorModal()" style="background: rgba(0, 255, 255, 0.1); border-color: rgba(0, 255, 255, 0.3); color: #00ffff;">
                            <i class="fas fa-terminal" style="font-size: 24px;"></i> System Console
                        </button>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="admin-btn danger" onclick="closeModal('adminPanelModal'); resetAllStats()" style="width: 100%; border: 1px solid rgba(255, 71, 87, 0.5);">
                            <i class="fas fa-trash-alt" style="font-size: 24px;"></i> Reset All Stats / Data Wipe
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="systemCreatorModal">
        <div class="modal-container wide" style="border: 2px solid rgba(0, 255, 255, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(147,0,255,0.1) 100%); border-bottom: 1px solid rgba(0,255,255,0.2);">
                <div class="modal-title" style="color: #00ffff;"><i class="fas fa-terminal"></i> SYSTEM_CREATOR_PANEL</div>
                <button class="modal-close" onclick="closeModal('systemCreatorModal')" style="color: #00ffff;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="systemCreatorContent">
                <div style="background: rgba(0,0,0,0.8); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; color: #00ffff; font-size: 12px; height: 200px; overflow-y: auto;" id="systemConsole">
                    <div style="color: #00ff00;">> System Creator v2.0 initialized...</div>
                    <div style="color: #00ffff;">> Firebase connection established...</div>
                    <div style="color: #00ffff;">> Awaiting commands...</div>
                </div>
                <button class="submit-btn" onclick="closeModal('systemCreatorModal')" style="margin-top: 12px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; color: #00ffff;">Close Panel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="playerManagerModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-users-cog" style="color: var(--primary-pink);"></i> Manage Players</div><button class="modal-close" onclick="closeModal('playerManagerModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div id="playerListContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;"></div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                    <h3 style="margin-bottom: 12px; font-size: 16px;">Add New Player</h3>
                    <div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="newPlayerName" style="padding-left: 16px; width: 100%;"></div>
                    <div class="form-group"><label class="form-label">Username</label><input type="text" class="form-input" id="newPlayerUsername" style="padding-left: 16px; width: 100%;"></div>
                    <div class="form-group"><label class="form-label">Initials (2-3 chars)</label><input type="text" class="form-input" id="newPlayerInitials" maxlength="3" style="padding-left: 16px; width: 100%;"></div>
                    <button class="submit-btn" onclick="addNewPlayer()"><i class="fas fa-plus" style="margin-right: 8px;"></i> Add Player</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="roleManagerModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-user-tag" style="color: var(--primary-pink);"></i> Change Player Roles</div><button class="modal-close" onclick="closeModal('roleManagerModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div id="roleChangeList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginInfoModal">
        <div class="modal-container wide">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-history" style="color: var(--primary-pink);"></i> Login History</div><button class="modal-close" onclick="closeModal('loginInfoModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <table class="login-info-table">
                    <thead>
                        <tr><th>Username</th><th>Name</th><th>Role</th><th>Last Login</th><th>IP Address</th><th>Status</th></tr>
                    </thead>
                    <tbody id="loginInfoTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addResultModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-plus-circle" style="color: var(--primary-pink);"></i> Add Match Result</div><button class="modal-close" onclick="closeModal('addResultModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Opponent</label><select class="form-select" id="resultOpponent" style="padding-left: 16px; width: 100%;"></select></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="resultDate" style="padding-left: 16px; width: 100%;"></div>
                    <div class="form-group"><label class="form-label">Venue</label><select class="form-select" id="resultVenue" style="padding-left: 16px; width: 100%;"><option value="home">Home</option><option value="away">Away</option></select></div>
                </div>
                
                <div style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid var(--border-color);">
                    <div style="text-align: center; margin-bottom: 16px; font-weight: 700;">Match Score</div>
                    <div style="display: flex; align-items: center; gap: 16px; justify-content: center;">
                        <div style="text-align: center;"><div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Rack Café</div><input type="number" id="ourScore" min="0" value="0" style="width: 80px; height: 60px; text-align: center; font-size: 32px; font-weight: 800; background: rgba(255,255,255,0.05); border: 2px solid var(--border-color); border-radius: 12px; color: white;"></div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-secondary);">-</div>
                        <div style="text-align: center;"><div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Opponent</div><input type="number" id="theirScore" min="0" value="0" style="width: 80px; height: 60px; text-align: center; font-size: 32px; font-weight: 800; background: rgba(255,255,255,0.05); border: 2px solid var(--border-color); border-radius: 12px; color: white;"></div>
                    </div>
                </div>

                <div style="margin: 20px 0;">
                    <div style="text-align: center; margin-bottom: 12px; font-weight: 700;">Frame Details (10 Frames)</div>
                    <div class="frame-grid" id="frameInputs">
                    </div>
                </div>

                <button class="submit-btn" onclick="submitMatchResult()"><i class="fas fa-save" style="margin-right: 8px;"></i> Save Result</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="scheduleModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-calendar-plus" style="color: var(--primary-pink);"></i> Schedule Match</div><button class="modal-close" onclick="closeModal('scheduleModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Opponent</label><select class="form-select" id="scheduleOpponent" style="padding-left: 16px; width: 100%;"></select></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="scheduleDate" style="padding-left: 16px; width: 100%;"></div>
                    <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="scheduleTime" style="padding-left: 16px; width: 100%;" value="20:00"></div>
                </div>
                <button class="submit-btn" onclick="submitSchedule()"><i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Schedule</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="announcementModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-bullhorn" style="color: var(--primary-pink);"></i> New Announcement</div><button class="modal-close" onclick="closeModal('announcementModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="announcementTitle" style="padding-left: 16px; width: 100%;" placeholder="Enter announcement title..."></div>
                <div class="form-group"><label class="form-label">Message</label><textarea class="form-textarea" id="announcementMessage" placeholder="Enter your message..."></textarea></div>
                <button class="submit-btn" onclick="submitAnnouncement()"><i class="fas fa-paper-plane" style="margin-right: 8px;"></i> Post Announcement</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="scheduleTrainingModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-dumbbell" style="color: var(--primary-pink);"></i> Schedule Training</div><button class="modal-close" onclick="closeModal('scheduleTrainingModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="trainingDate" style="padding-left: 16px; width: 100%;"></div>
                <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="trainingTime" style="padding-left: 16px; width: 100%;" value="19:00"></div>
                <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="trainingLocation" style="padding-left: 16px; width: 100%;" value="Rack Café"></div>
                <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="trainingNotes" style="padding-left: 16px; width: 100%;" placeholder="Optional notes..."></div>
                <button class="submit-btn" onclick="submitTrainingSchedule()"><i class="fas fa-save" style="margin-right: 8px;"></i> Schedule Training</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="frameDetailModal">
        <div class="modal-container">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-eye" style="color: var(--primary-pink);"></i> Frame Details</div><button class="modal-close" onclick="closeModal('frameDetailModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="frameDetailContent"></div>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Success</span></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYQy0hTbsTkAg8_vqnvRVsXDxg_yg2DVY",
            authDomain: "rack-cafe-united-app.firebaseapp.com",
            projectId: "rack-cafe-united-app",
            storageBucket: "rack-cafe-united-app.firebasestorage.app",
            messagingSenderId: "754292454573",
            appId: "1:754292454573:web:188ec818666c77a3ef8224"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence({ experimentalTabSynchronization: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Multiple tabs open, persistence enabled in first tab only");
                } else if (err.code == 'unimplemented') {
                    console.log("Browser doesn't support persistence");
                }
            });

        // Configuration & Data
        const STORAGE_KEY = 'rackCafeData_v4'; // Bumped version for new fields
        const SESSION_KEY = 'rackCafeSession';
        const DOC_ID = 'main';
        
        let teamCredentials = {
            'BDannatt': { password: 'HTAFC26', name: 'Brandon Dannatt', role: 'Captain', isAdmin: true, initials: 'BD', lastLogin: null, loginHistory: [] },
            'THayes-Smith': { password: '071122Mia', name: 'Tom Hayes-Smith', role: 'System Creator + Co-Captain', isAdmin: true, initials: 'THS', isSystemCreator: true, lastLogin: null, loginHistory: [] },
            'CShearon': { password: 'Rack2026', name: 'Chris Shearon', role: 'Co-Captain', isAdmin: true, initials: 'CS', lastLogin: null, loginHistory: [] },
            'TDannatt': { password: 'Rack2026', name: 'Terry Dannatt', role: 'Player', isAdmin: false, initials: 'TD', lastLogin: null, loginHistory: [] },
            'KBurns': { password: 'Rack2026', name: 'Keely Burns', role: 'Player', isAdmin: false, initials: 'KB', lastLogin: null, loginHistory: [] },
            'CSyrat': { password: 'Rack2026', name: 'Chloë Syrat', role: 'Player', isAdmin: false, initials: 'CSy', lastLogin: null, loginHistory: [] }
        };

        let teamData = [];
        let opponentsList = ['Ashfield Massive', 'Carlton Club', 'Longwood BC Wednesday', 'Monkey Club', 'BYE'];
        let leagueData = [{ id: 1, name: 'Rack Café Utd', played: 0, won: 0, lost: 0, points: 0, isUs: true }];
        let fixturesData = [];
        let announcements = [];
        let trainingSessions = [];
        let scorecards = [];
        let currentUser = null;
        let currentFilter = 'all';
        let maintenanceMode = false;
        let isOnline = true;
        let unsubscribe = null;
        let viewingPlayerUsername = null; // For System Creator profile viewing
        let editingField = null; // Track which field is being edited

        // Firebase Sync Functions
        function initFirebaseSync() {
            unsubscribe = db.collection('rackCafe').doc(DOC_ID)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('Firebase sync received');
                        
                        if (data.teamData) teamData = data.teamData;
                        if (data.leagueData) leagueData = data.leagueData;
                        if (data.fixturesData) fixturesData = data.fixturesData;
                        if (data.opponentsList) opponentsList = data.opponentsList;
                        if (data.announcements) announcements = data.announcements;
                        if (data.trainingSessions) trainingSessions = data.trainingSessions;
                        if (data.scorecards) scorecards = data.scorecards;
                        if (data.maintenanceMode !== undefined) maintenanceMode = data.maintenanceMode;
                        if (data.teamCredentials) {
                            Object.assign(teamCredentials, data.teamCredentials);
                        }
                        
                        updateDisplays();
                        setSyncStatus('synced');
                        
                        localStorage.setItem(STORAGE_KEY, JSON.stringify({
                            teamData, leagueData, fixturesData, opponentsList, 
                            announcements, trainingSessions, scorecards, 
                            maintenanceMode, teamCredentials,
                            lastSave: new Date().toISOString()
                        }));
                    } else {
                        saveToFirebase();
                    }
                }, (error) => {
                    console.error('Firebase sync error:', error);
                    setSyncStatus('offline');
                    loadFromLocalStorage();
                });

            db.collection('.info/connected').onSnapshot((snap) => {
                if (snap.data()) {
                    isOnline = true;
                    document.getElementById('connectionStatus').classList.remove('show');
                    setSyncStatus('synced');
                } else {
                    isOnline = false;
                    document.getElementById('connectionStatus').classList.add('show');
                    setSyncStatus('offline');
                }
            });
        }

        async function saveToFirebase() {
            if (!isOnline) {
                console.log('Offline - saving to localStorage only');
                saveToLocalStorage();
                return;
            }
            
            setSyncStatus('syncing');
            
            try {
                const data = {
                    teamData,
                    leagueData,
                    fixturesData,
                    opponentsList,
                    announcements,
                    trainingSessions,
                    scorecards,
                    maintenanceMode,
                    teamCredentials,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                    modifiedBy: currentUser ? currentUser.username : 'anonymous'
                };
                
                await db.collection('rackCafe').doc(DOC_ID).set(data);
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                setSyncStatus('offline');
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            try {
                const data = {
                    teamData,
                    leagueData,
                    fixturesData,
                    opponentsList,
                    announcements,
                    trainingSessions,
                    scorecards,
                    maintenanceMode,
                    teamCredentials,
                    lastSave: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error('LocalStorage save failed:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.teamData) teamData = data.teamData;
                    if (data.leagueData) leagueData = data.leagueData;
                    if (data.fixturesData) fixturesData = data.fixturesData;
                    if (data.opponentsList) opponentsList = data.opponentsList;
                    if (data.announcements) announcements = data.announcements;
                    if (data.trainingSessions) trainingSessions = data.trainingSessions;
                    if (data.scorecards) scorecards = data.scorecards;
                    if (data.maintenanceMode !== undefined) maintenanceMode = data.maintenanceMode;
                    if (data.teamCredentials) {
                        Object.assign(teamCredentials, data.teamCredentials);
                    }
                } else {
                    syncTeamDataWithCredentials();
                }
            } catch (e) {
                console.error('LocalStorage load failed:', e);
            }
        }

        function setSyncStatus(status) {
            const badge = document.getElementById('syncBadge');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncStatus');
            
            badge.className = 'sync-badge';
            
            if (status === 'syncing') {
                badge.classList.add('syncing');
                icon.className = 'fas fa-spinner sync-indicator';
                text.textContent = 'Syncing...';
            } else if (status === 'offline') {
                badge.classList.add('offline');
                icon.className = 'fas fa-cloud';
                text.textContent = 'Offline';
            } else {
                badge.classList.add('synced');
                icon.className = 'fas fa-check-circle';
                text.textContent = 'Synced';
            }
        }

        function saveData() {
            saveToFirebase();
        }

        function loadData() {
            loadFromLocalStorage();
        }

        function syncTeamDataWithCredentials() {
            teamData = Object.keys(teamCredentials).map((username, idx) => {
                const cred = teamCredentials[username];
                const existing = teamData.find(t => t.name === cred.name) || {};
                return {
                    id: idx + 1,
                    username: username,
                    name: cred.name,
                    initials: cred.initials,
                    role: cred.role,
                    email: existing.email || `${username.toLowerCase()}@rackcafe.com`,
                    phone: existing.phone || '07490518455',
                    played: existing.played || 0,
                    won: existing.won || 0,
                    lost: existing.lost || 0,
                    winRate: existing.winRate || 0,
                    gameHistory: existing.gameHistory || [],
                    photoURL: existing.photoURL || null,
                    seasonHistory: existing.seasonHistory || []
                };
            });
        }

        // Initialization
        function init() {
            loadData();
            initFirebaseSync();
            checkSession();
            updateDisplays();
            setupEventListeners();
            
            if (maintenanceMode && (!currentUser || !currentUser.isSystemCreator)) {
                document.getElementById('maintenanceOverlay').classList.add('active');
            }
        }

        function setupEventListeners() {
            document.addEventListener('click', function(e) {
                const profileContainer = document.querySelector('.profile-container');
                if (profileContainer && !profileContainer.contains(e.target)) {
                    document.getElementById('profileDropdown').classList.remove('show');
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && (e.key === 'm' || e.key === 'M')) {
                    e.preventDefault();
                    if (maintenanceMode || (currentUser && currentUser.isSystemCreator)) {
                        attemptMaintenanceLogin();
                    }
                }
            });
        }

        // Authentication
        function showLogin() {
            document.getElementById('loginScreen').classList.add('show');
        }

        function cancelLogin() {
            document.getElementById('loginScreen').classList.remove('show');
            if (maintenanceMode && (!currentUser || !currentUser.isSystemCreator)) {
                document.getElementById('maintenanceOverlay').classList.add('active');
            }
        }

        function doLogin() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            const userData = teamCredentials[username];
            
            if (userData && userData.password === password) {
                if (maintenanceMode && !userData.isSystemCreator) {
                    errorDiv.innerHTML = '<i class="fas fa-ban"></i> System under maintenance - Only System Creator may access';
                    errorDiv.classList.add('show');
                    return;
                }
                
                currentUser = { username, ...userData };
                
                const loginEntry = {
                    timestamp: new Date().toISOString(),
                    ip: '192.168.1.' + Math.floor(Math.random() * 255),
                    userAgent: navigator.userAgent
                };
                teamCredentials[username].loginHistory.unshift(loginEntry);
                teamCredentials[username].lastLogin = loginEntry.timestamp;
                if (teamCredentials[username].loginHistory.length > 10) {
                    teamCredentials[username].loginHistory.pop();
                }
                
                saveData();
                
                localStorage.setItem(SESSION_KEY, JSON.stringify({
                    username: username,
                    password: password,
                    timestamp: new Date().toISOString()
                }));
                
                document.getElementById('loginScreen').classList.remove('show');
                errorDiv.classList.remove('show');
                
                completeLogin();
                showToast(`Welcome ${userData.name}`);
            } else {
                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid credentials';
                errorDiv.classList.add('show');
            }
        }

        function completeLogin() {
            if (!currentUser) return;
            
            document.getElementById('headerLoginBtn').classList.add('hidden');
            document.getElementById('profileContainer').classList.add('show');
            
            // Update avatar with photo if available
            const avatar = document.getElementById('userAvatar');
            const player = teamData.find(p => p.username === currentUser.username);
            if (player && player.photoURL) {
                avatar.innerHTML = `<img src="${player.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                avatar.textContent = currentUser.initials;
            }
            
            document.getElementById('userNameText').textContent = currentUser.name;
            document.getElementById('userBadge').innerHTML = getRoleBadgeHTML(currentUser.role, currentUser.isSystemCreator);
            document.getElementById('roleText').textContent = currentUser.role;
            document.getElementById('welcomeText').textContent = `Welcome back, ${currentUser.name.split(' ')[0]}!`;
            
            if (currentUser.isAdmin) {
                document.getElementById('adminMenuItem').style.display = 'flex';
            }
            
            if (currentUser.isAdmin) {
                document.getElementById('adminTrainingControls').style.display = 'block';
            }
            
            // Show System Creator player selector if applicable
            if (currentUser.isSystemCreator) {
                document.getElementById('systemCreatorPlayerSelector').style.display = 'block';
                populatePlayerSelector();
            } else {
                document.getElementById('systemCreatorPlayerSelector').style.display = 'none';
            }
            
            updateDisplays();
        }

        function populatePlayerSelector() {
            const select = document.getElementById('profilePlayerSelect');
            select.innerHTML = teamData.map(p => 
                `<option value="${p.username}" ${p.username === (viewingPlayerUsername || currentUser.username) ? 'selected' : ''}>${p.name} (${p.username})</option>`
            ).join('');
        }

        function changeProfileView(username) {
            viewingPlayerUsername = username;
            renderProfile();
        }

        function checkSession() {
            const saved = localStorage.getItem(SESSION_KEY);
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    const userData = teamCredentials[session.username];
                    if (userData && userData.password === session.password) {
                        if (maintenanceMode && !userData.isSystemCreator) {
                            localStorage.removeItem(SESSION_KEY);
                            showLoggedOutState();
                            return;
                        }
                        currentUser = { username: session.username, ...userData };
                        completeLogin();
                    } else {
                        showLoggedOutState();
                    }
                } catch (e) {
                    showLoggedOutState();
                }
            } else {
                showLoggedOutState();
            }
        }

        function showLoggedOutState() {
            document.getElementById('headerLoginBtn').classList.remove('hidden');
            document.getElementById('profileContainer').classList.remove('show');
            document.getElementById('adminTrainingControls').style.display = 'none';
            document.getElementById('adminMenuItem').style.display = 'none';
            document.getElementById('systemCreatorPlayerSelector').style.display = 'none';
        }

        function logout() {
            if (!confirm('Logout?')) return;
            currentUser = null;
            viewingPlayerUsername = null;
            localStorage.removeItem(SESSION_KEY);
            showLoggedOutState();
            switchTab('homeTab', document.querySelector('.nav-item'));
            showToast('Logged out');
        }

        function requireAuth(tabId, navElement) {
            if (!currentUser) {
                showLogin();
                showToast('Please login to access this feature', 'error');
                return;
            }
            switchTab(tabId, navElement);
        }

        // UI Functions
        function toggleDropdown(e) {
            if (e) e.stopPropagation();
            document.getElementById('profileDropdown').classList.toggle('show');
        }

        function closeDropdown() {
            document.getElementById('profileDropdown').classList.remove('show');
        }

        function switchTab(tabId, navElement) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (navElement) navElement.classList.add('active');
            
            if (tabId === 'tableTab') renderLeagueTable();
            if (tabId === 'teamTab') renderTeam();
            if (tabId === 'trainingTab') renderTraining();
            if (tabId === 'scorecardTab') renderScorecards();
            if (tabId === 'profileTab') renderProfile();
        }

        function getRoleBadgeHTML(role, isSystemCreator = false) {
            if (isSystemCreator || role.includes('System Creator')) {
                return `<span class="role-badge badge-system-creator"><i class="fas fa-crown"></i> SYS_CREATOR</span>`;
            } else if (role === 'Captain') {
                return `<span class="role-badge badge-captain"><i class="fas fa-star"></i> CAPTAIN</span>`;
            } else if (role.includes('Co-Captain')) {
                return `<span class="role-badge badge-co-captain"><i class="fas fa-star-half-alt"></i> CO-CAPTAIN</span>`;
            } else {
                return `<span class="role-badge badge-player"><i class="fas fa-user"></i> PLAYER</span>`;
            }
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const color = type === 'success' ? '#2ed573' : '#ff4757';
            t.className = 'toast show';
            t.innerHTML = `<i class="fas ${icon}" style="color: ${color};"></i><span>${msg}</span>`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function updateDisplays() {
            renderWWLDW();
            renderAnnouncements();
            
            const us = leagueData[0];
            document.getElementById('statPlayed').textContent = us.played;
            document.getElementById('statWon').textContent = us.won;
            document.getElementById('statWinRate').textContent = us.played > 0 ? Math.round((us.won/us.played)*100) + '%' : '0%';
            
            const sorted = [...leagueData].sort((a,b) => b.points - a.points);
            const pos = sorted.findIndex(t => t.isUs) + 1;
            document.getElementById('statPosition').textContent = pos ? pos + (pos === 1 ? 'st' : pos === 2 ? 'nd' : pos === 3 ? 'rd' : 'th') : '--';
            
            const upcoming = fixturesData.filter(f => !f.played).sort((a,b) => new Date(a.date) - new Date(b.date))[0];
            if (upcoming) {
                document.getElementById('nextMatchOpponent').textContent = upcoming.opponent;
                document.getElementById('nextMatchDate').textContent = new Date(upcoming.date).toLocaleDateString();
                document.getElementById('nextMatchTime').textContent = upcoming.time || '20:00';
                document.getElementById('nextMatchVenue').textContent = upcoming.venue === 'home' ? 'Home' : 'Away';
            } else {
                document.getElementById('nextMatchOpponent').textContent = 'TBD';
                document.getElementById('nextMatchDate').textContent = 'TBC';
                document.getElementById('nextMatchTime').textContent = '--:--';
            }
            
            renderFixtures();
        }

        function renderWWLDW() {
            const panel = document.getElementById('wwldwPanel');
            const last5 = fixturesData
                .filter(f => f.played)
                .sort((a,b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (last5.length === 0) {
                panel.innerHTML = '<div style="color: var(--text-muted); font-size: 14px;">No recent results</div>';
                return;
            }
            
            panel.innerHTML = last5.map(match => {
                let result;
                if (match.ourScore > match.theirScore) result = 'W';
                else if (match.ourScore < match.theirScore) result = 'L';
                else result = 'D';
                
                const className = result === 'W' ? 'form-w' : result === 'L' ? 'form-l' : 'form-d';
                return `<div class="form-badge ${className}">${result}</div>`;
            }).join('');
        }

        function openAdminPanel() {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin access required', 'error');
                return;
            }
            
            const roleBtn = document.getElementById('adminRoleManagerBtn');
            if (currentUser.role === 'Captain' || currentUser.isSystemCreator) {
                roleBtn.style.display = 'flex';
            } else {
                roleBtn.style.display = 'none';
            }
            
            const sysCreatorSection = document.getElementById('adminPanelSystemCreatorSection');
            if (currentUser.isSystemCreator) {
                sysCreatorSection.style.display = 'block';
            } else {
                sysCreatorSection.style.display = 'none';
            }
            
            openModal('adminPanelModal');
        }

        function openSystemCreatorModal() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            openModal('systemCreatorModal');
            logToConsole('System Creator panel accessed by ' + currentUser.name);
        }

        function openAnnouncementModal() {
            openModal('announcementModal');
        }

        function submitAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const message = document.getElementById('announcementMessage').value;
            
            if (!title || !message) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            announcements.unshift({
                id: Date.now(),
                title,
                message,
                author: currentUser.name,
                date: new Date().toISOString()
            });
            
            saveData();
            closeModal('announcementModal');
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementMessage').value = '';
            renderAnnouncements();
            showToast('Announcement posted');
        }

        function renderAnnouncements() {
            const container = document.getElementById('announcementsList');
            const panel = document.getElementById('announcementsPanel');
            
            if (announcements.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            container.innerHTML = announcements.map(a => `
                <div class="announcement-card">
                    ${currentUser && currentUser.isAdmin ? `<button class="announcement-delete" onclick="deleteAnnouncement(${a.id})"><i class="fas fa-times"></i></button>` : ''}
                    <div class="announcement-header">
                        <div style="font-weight: 800; color: var(--primary-pink);">${a.title}</div>
                        <div class="announcement-date">${new Date(a.date).toLocaleDateString()}</div>
                    </div>
                    <div style="font-size: 14px; line-height: 1.5;">${a.message}</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Posted by ${a.author}</div>
                </div>
            `).join('');
        }

        function deleteAnnouncement(id) {
            if (!confirm('Delete this announcement?')) return;
            announcements = announcements.filter(a => a.id !== id);
            saveData();
            renderAnnouncements();
            showToast('Announcement deleted');
        }

        function filterFixtures(type, btn) {
            currentFilter = type;
            const buttons = btn.parentElement.querySelectorAll('.admin-btn');
            buttons.forEach(b => {
                b.style.background = 'rgba(255,255,255,0.05)';
                b.style.color = 'var(--text-secondary)';
                b.style.border = '1px solid var(--border-color)';
            });
            btn.style.background = 'linear-gradient(135deg, #e94560 0%, #d63d56 100%)';
            btn.style.color = 'white';
            btn.style.border = 'none';
            renderFixtures();
        }

        function renderFixtures() {
            const list = document.getElementById('fixturesList');
            let matches = fixturesData.filter(f => {
                if (currentFilter === 'upcoming') return !f.played;
                return true;
            }).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if (matches.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No fixtures found</div>';
                return;
            }
            
            list.innerHTML = matches.map(m => `
                <div class="fixture-card" data-fixture-id="${m.id}" style="position: relative;">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <div class="fixture-date">
                            <div class="date-day">${new Date(m.date).getDate()}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${new Date(m.date).toLocaleString('default', {month: 'short'})}</div>
                        </div>
                        <div style="margin-left: 16px;">
                            <div style="font-weight: 800;">vs ${m.opponent}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${m.played ? 'Completed' : (m.time || '20:00')}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        ${m.played ? `<div style="font-weight: 800; font-size: 20px; color: ${m.result === 'W' ? '#2ed573' : m.result === 'L' ? '#ff4757' : '#ffd700'};">${m.ourScore}-${m.theirScore}</div>` : ''}
                        ${currentUser && currentUser.isSystemCreator ? `
                            <button class="delete-fixture-btn" onclick="deleteFixture(${m.id}); event.stopPropagation();" title="Delete Fixture">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function deleteFixture(fixtureId) {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            const fixture = fixturesData.find(f => f.id === fixtureId);
            if (!fixture) return;
            
            if (!confirm(`Delete ${fixture.played ? 'match result' : 'fixture'} vs ${fixture.opponent}?\n\nThis will also reverse any league table changes if the match was completed.\n\nThis action cannot be undone.`)) return;
            
            if (fixture.played) {
                const us = leagueData[0];
                const opponent = leagueData.find(t => t.name === fixture.opponent);
                
                us.played--;
                us.points -= fixture.ourScore;
                if (fixture.ourScore > fixture.theirScore) us.won--;
                else if (fixture.ourScore < fixture.theirScore) us.lost--;
                
                if (opponent && !opponent.isUs) {
                    opponent.played--;
                    opponent.points -= fixture.theirScore;
                    if (fixture.theirScore > fixture.ourScore) opponent.won--;
                    else if (fixture.theirScore < fixture.ourScore) opponent.lost--;
                    
                    if (opponent.played === 0 && !opponent.isUs) {
                        leagueData = leagueData.filter(t => t.name !== fixture.opponent);
                    }
                }
                
                const scorecard = scorecards.find(s => s.fixtureId === fixtureId);
                if (scorecard && scorecard.frames) {
                    scorecard.frames.forEach(frame => {
                        if (frame.player && frame.result) {
                            const player = teamData.find(p => p.name === frame.player);
                            if (player) {
                                player.played--;
                                if (frame.result === 'W') player.won--;
                                else if (frame.result === 'L') player.lost--;
                                if (player.played > 0) {
                                    player.winRate = Math.round((player.won / player.played) * 100);
                                } else {
                                    player.winRate = 0;
                                }
                                if (player.gameHistory) {
                                    player.gameHistory = player.gameHistory.filter(g => g.date !== fixture.date || g.opponent !== fixture.opponent);
                                }
                            }
                        }
                    });
                }
                
                scorecards = scorecards.filter(s => s.fixtureId !== fixtureId);
            }
            
            fixturesData = fixturesData.filter(f => f.id !== fixtureId);
            
            saveData();
            updateDisplays();
            renderFixtures();
            showToast('Fixture deleted successfully', 'error');
            
            if (typeof logToConsole === 'function') {
                logToConsole(`Fixture deleted: ${fixture.opponent} (${fixture.played ? 'completed' : 'scheduled'}) by ${currentUser.name}`);
            }
        }

        function renderLeagueTable() {
            const container = document.getElementById('leagueTable');
            const sorted = [...leagueData].sort((a,b) => b.points - a.points);
            
            container.innerHTML = `
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: 40px 1fr 60px 60px 60px; padding: 16px; background: rgba(255,255,255,0.03); font-weight: 700; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                        <div>Pos</div><div>Team</div><div style="text-align: center;">P</div><div style="text-align: center;">W</div><div style="text-align: center;">Pts</div>
                    </div>
                    ${sorted.map((team, idx) => `
                        <div style="display: grid; grid-template-columns: 40px 1fr 60px 60px 60px; padding: 16px; border-top: 1px solid var(--border-color); ${team.isUs ? 'background: rgba(233,69,96,0.1);' : ''}">
                            <div style="font-weight: 800; color: ${idx < 3 ? '#ffd700' : 'var(--text-secondary)'};">${idx + 1}</div>
                            <div style="font-weight: ${team.isUs ? '800' : '600'};">${team.name} ${team.isUs ? '<span style="color: var(--primary-pink);">*</span>' : ''}</div>
                            <div style="text-align: center;">${team.played}</div>
                            <div style="text-align: center;">${team.won}</div>
                            <div style="text-align: center; font-weight: 800;">${team.points}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 12px; font-size: 12px; color: var(--text-muted);">* Rack Café Utd</div>
            `;
        }

        function renderTeam() {
            const container = document.getElementById('teamList');
            container.innerHTML = teamData.map(player => `
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-pink), var(--accent-orange)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; overflow: hidden;">
                            ${player.photoURL ? `<img src="${player.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">` : player.initials}
                        </div>
                        <div>
                            <div style="font-weight: 800; font-size: 16px; margin-bottom: 4px; display: flex; align-items: center;">
                                ${player.name}
                                ${getRoleBadgeHTML(player.role, player.role.includes('System Creator'))}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                ${player.played} played · ${player.won} won · ${player.winRate}% win rate
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: 800; color: var(--primary-pink);">${player.winRate}%</div>
                        <div style="font-size: 11px; color: var(--text-muted);">WIN RATE</div>
                    </div>
                </div>
            `).join('');
        }

        function openRoleManagerModal() {
            if (!currentUser || (!currentUser.isSystemCreator && currentUser.role !== 'Captain')) {
                showToast('Only Captain or System Creator can change roles', 'error');
                return;
            }
            
            const list = document.getElementById('roleChangeList');
            list.innerHTML = teamData.map(player => `
                <div class="player-list-item">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-weight: 800;">${player.name}</div>
                        ${getRoleBadgeHTML(player.role, player.role.includes('System Creator'))}
                    </div>
                    <select class="role-select" onchange="changePlayerRole('${player.username}', this.value)" ${player.role.includes('System Creator') && !currentUser.isSystemCreator ? 'disabled' : ''}>
                        <option value="Player" ${player.role === 'Player' ? 'selected' : ''}>Player</option>
                        <option value="Co-Captain" ${player.role === 'Co-Captain' ? 'selected' : ''}>Co-Captain</option>
                        <option value="Captain" ${player.role === 'Captain' ? 'selected' : ''}>Captain</option>
                        ${currentUser.isSystemCreator ? `<option value="System Creator" ${player.role.includes('System Creator') ? 'selected' : ''}>System Creator</option>` : ''}
                    </select>
                </div>
            `).join('');
            
            openModal('roleManagerModal');
        }

        function changePlayerRole(username, newRole) {
            teamCredentials[username].role = newRole;
            teamCredentials[username].isAdmin = newRole !== 'Player';
            if (newRole === 'System Creator') {
                teamCredentials[username].isSystemCreator = true;
                teamCredentials[username].isAdmin = true;
            } else if (newRole === 'Captain' || newRole === 'Co-Captain') {
                teamCredentials[username].isSystemCreator = false;
                teamCredentials[username].isAdmin = true;
            } else {
                teamCredentials[username].isSystemCreator = false;
                teamCredentials[username].isAdmin = false;
            }
            
            const player = teamData.find(t => t.username === username);
            if (player) player.role = newRole;
            
            saveData();
            showToast(`Role updated to ${newRole}`);
            renderTeam();
            
            if (currentUser.username === username) {
                currentUser.role = newRole;
                currentUser.isAdmin = teamCredentials[username].isAdmin;
                currentUser.isSystemCreator = teamCredentials[username].isSystemCreator;
                completeLogin();
            }
        }

        function openPlayerManagerModal() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            renderPlayerList();
            openModal('playerManagerModal');
        }

        function renderPlayerList() {
            const container = document.getElementById('playerListContainer');
            container.innerHTML = teamData.map(player => `
                <div class="player-list-item">
                    <div>
                        <div style="font-weight: 800;">${player.name}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${player.username} · ${player.role}</div>
                    </div>
                    <button onclick="removePlayer('${player.username}')" style="background: rgba(255,71,87,0.2); color: #ff4757; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `).join('');
        }

        function addNewPlayer() {
            const name = document.getElementById('newPlayerName').value;
            const username = document.getElementById('newPlayerUsername').value;
            const initials = document.getElementById('newPlayerInitials').value.toUpperCase();
            
            if (!name || !username || !initials) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            if (teamCredentials[username]) {
                showToast('Username already exists', 'error');
                return;
            }
            
            teamCredentials[username] = {
                password: 'Rack2026',
                name: name,
                role: 'Player',
                isAdmin: false,
                initials: initials,
                lastLogin: null,
                loginHistory: []
            };
            
            syncTeamDataWithCredentials();
            saveData();
            
            document.getElementById('newPlayerName').value = '';
            document.getElementById('newPlayerUsername').value = '';
            document.getElementById('newPlayerInitials').value = '';
            
            renderPlayerList();
            showToast('Player added successfully');
        }

        function removePlayer(username) {
            if (!confirm(`Remove ${teamCredentials[username].name}? This cannot be undone.`)) return;
            if (teamCredentials[username].isSystemCreator) {
                showToast('Cannot remove System Creator', 'error');
                return;
            }
            
            delete teamCredentials[username];
            syncTeamDataWithCredentials();
            saveData();
            renderPlayerList();
            showToast('Player removed');
        }

        function openLoginInfoModal() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            const tbody = document.getElementById('loginInfoTableBody');
            tbody.innerHTML = Object.keys(teamCredentials).map(username => {
                const user = teamCredentials[username];
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
                const isOnline = currentUser && currentUser.username === username;
                return `
                    <tr>
                        <td>${username}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td class="last-login">${lastLogin}</td>
                        <td>${user.loginHistory[0]?.ip || '-'}</td>
                        <td>${isOnline ? '<span style="color: #2ed573;">● Online</span>' : '<span style="color: var(--text-muted);">Offline</span>'}</td>
                    </tr>
                `;
            }).join('');
            
            openModal('loginInfoModal');
        }

        function toggleMaintenanceMode() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            maintenanceMode = !maintenanceMode;
            saveData();
            
            if (maintenanceMode) {
                document.getElementById('maintenanceOverlay').classList.add('active');
                logToConsole('🔒 MAINTENANCE MODE ENABLED');
            } else {
                document.getElementById('maintenanceOverlay').classList.remove('active');
                logToConsole('🔓 MAINTENANCE MODE DISABLED');
            }
            
            showToast(maintenanceMode ? 'Maintenance mode enabled' : 'Maintenance mode disabled', 
                     maintenanceMode ? 'error' : 'success');
        }

        function resetAllStats() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            if (!confirm('⚠️ SYSTEM ALERT: This will irreversibly delete ALL match results, fixture history, player statistics, training records, announcements, and league data.\n\nThis action cannot be undone.\n\nAre you sure you wish to proceed?')) return;
            
            if (!confirm('🔴 FINAL WARNING: All game history, win rates, match records, and player statistics will be permanently erased and reset to zero.\n\nConfirm complete data wipe?')) return;
            
            logToConsole('⚠️ INITIATING SYSTEM WIPE...');
            
            const ourTeamIndex = leagueData.findIndex(t => t.isUs);
            if (ourTeamIndex !== -1) {
                leagueData = [{
                    id: 1,
                    name: 'Rack Café Utd',
                    played: 0,
                    won: 0,
                    lost: 0,
                    points: 0,
                    isUs: true
                }];
            } else {
                leagueData = [{ id: 1, name: 'Rack Café Utd', played: 0, won: 0, lost: 0, points: 0, isUs: true }];
            }
            
            teamData.forEach(player => {
                player.played = 0;
                player.won = 0;
                player.lost = 0;
                player.winRate = 0;
                player.gameHistory = [];
                // Keep season history intact as it's historical record
            });
            
            fixturesData = [];
            scorecards = [];
            announcements = [];
            trainingSessions = [];
            
            saveData();
            updateDisplays();
            
            if (document.getElementById('fixturesTab').classList.contains('active')) renderFixtures();
            if (document.getElementById('tableTab').classList.contains('active')) renderLeagueTable();
            if (document.getElementById('teamTab').classList.contains('active')) renderTeam();
            if (document.getElementById('scorecardTab').classList.contains('active')) renderScorecards();
            if (document.getElementById('trainingTab').classList.contains('active')) renderTraining();
            
            logToConsole('🧹 COMPLETE SYSTEM WIPE EXECUTED');
            logToConsole(`All statistics reset to zero by ${currentUser.name}`);
            logToConsole(`Timestamp: ${new Date().toISOString()}`);
            
            showToast('🗑️ All statistics have been reset to zero', 'error');
        }

        function logToConsole(msg) {
            const console = document.getElementById('systemConsole');
            if (console) {
                const line = document.createElement('div');
                line.textContent = `> ${msg}`;
                console.appendChild(line);
                console.scrollTop = console.scrollHeight;
            }
        }

        function openScheduleTrainingModal() {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin access required', 'error');
                return;
            }
            document.getElementById('trainingDate').valueAsDate = new Date();
            openModal('scheduleTrainingModal');
        }

        function submitTrainingSchedule() {
            const date = document.getElementById('trainingDate').value;
            const time = document.getElementById('trainingTime').value;
            const location = document.getElementById('trainingLocation').value;
            const notes = document.getElementById('trainingNotes').value;
            
            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }
            
            trainingSessions.push({
                id: Date.now(),
                date,
                time,
                location,
                notes,
                createdBy: currentUser.name,
                attendees: [],
                declined: []
            });
            
            saveData();
            closeModal('scheduleTrainingModal');
            renderTraining();
            showToast('Training scheduled');
        }

        function renderTraining() {
            const container = document.getElementById('trainingList');
            const now = new Date();
            const upcoming = trainingSessions.filter(t => new Date(t.date) >= now).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if (upcoming.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No upcoming training sessions</div>';
                return;
            }
            
            container.innerHTML = upcoming.map(session => {
                const isAttending = session.attendees.includes(currentUser?.name);
                const isDeclined = session.declined.includes(currentUser?.name);
                
                return `
                    <div class="training-card">
                        <div class="training-header">
                            <div>
                                <div class="training-date">${new Date(session.date).toLocaleDateString()}</div>
                                <div class="training-time"><i class="fas fa-clock"></i> ${session.time} · <i class="fas fa-map-marker-alt"></i> ${session.location}</div>
                                ${session.notes ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">${session.notes}</div>` : ''}
                            </div>
                            ${currentUser && currentUser.isAdmin ? `
                                <button onclick="deleteTraining(${session.id})" style="background: rgba(255,71,87,0.2); color: #ff4757; border: none; padding: 8px; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                            <div style="font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Attendance</div>
                            
                            ${currentUser ? `
                                <div style="margin-bottom: 12px;">
                                    ${!isAttending ? `<button class="attendance-btn btn-yes" onclick="toggleTrainingAttendance(${session.id}, true)"><i class="fas fa-check"></i> I'll Attend</button>` : ''}
                                    ${!isDeclined ? `<button class="attendance-btn btn-no" onclick="toggleTrainingAttendance(${session.id}, false)"><i class="fas fa-times"></i> Can't Make It</button>` : ''}
                                    ${isAttending ? `<div style="color: #2ed573; font-size: 13px;"><i class="fas fa-check-circle"></i> You confirmed attendance</div>` : ''}
                                    ${isDeclined ? `<div style="color: #ff4757; font-size: 13px;"><i class="fas fa-times-circle"></i> You declined</div>` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="attendance-grid">
                                ${session.attendees.map(name => {
                                    const player = teamData.find(p => p.name === name);
                                    return `<div class="attendee confirmed" title="${name}">${player ? player.initials : name}</div>`;
                                }).join('')}
                                ${session.declined.map(name => {
                                    const player = teamData.find(p => p.name === name);
                                    return `<div class="attendee declined" title="${name} (Declined)">${player ? player.initials : name}</div>`;
                                }).join('')}
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                                ${session.attendees.length} attending · ${session.declined.length} declined
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTrainingAttendance(sessionId, attending) {
            const session = trainingSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            session.attendees = session.attendees.filter(n => n !== currentUser.name);
            session.declined = session.declined.filter(n => n !== currentUser.name);
            
            if (attending) {
                session.attendees.push(currentUser.name);
                showToast('Attendance confirmed');
            } else {
                session.declined.push(currentUser.name);
                showToast('Marked as unavailable');
            }
            
            saveData();
            renderTraining();
        }

        function deleteTraining(id) {
            if (!confirm('Cancel this training session?')) return;
            trainingSessions = trainingSessions.filter(s => s.id !== id);
            saveData();
            renderTraining();
            showToast('Training cancelled');
        }

        function renderScorecards() {
            const container = document.getElementById('scorecardList');
            const playedMatches = fixturesData.filter(f => f.played && f.ourScore !== undefined).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if (playedMatches.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No completed matches yet</div>';
                return;
            }
            
            container.innerHTML = playedMatches.map(match => {
                const scorecard = scorecards.find(s => s.fixtureId === match.id);
                return `
                    <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <div style="font-weight: 800; font-size: 18px;">vs ${match.opponent}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${new Date(match.date).toLocaleDateString()}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: ${match.result === 'W' ? '#2ed573' : match.result === 'L' ? '#ff4757' : '#ffd700'};">
                                ${match.ourScore} - ${match.theirScore}
                            </div>
                        </div>
                        ${scorecard ? `
                            <div class="frame-grid" style="grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                ${scorecard.frames.map((frame, idx) => `
                                    <div class="frame-box ${frame.result === 'W' ? 'won' : frame.result === 'L' ? 'lost' : ''}" onclick="viewFrameDetail(${match.id}, ${idx})">
                                        <div class="frame-number">${idx + 1}</div>
                                        <div class="frame-result">${frame.result || '-'}</div>
                                        <div class="frame-player">${frame.player ? teamData.find(p => p.name === frame.player)?.initials || '?' : '-'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 12px;">No detailed scorecard available</div>'}
                    </div>
                `;
            }).join('');
        }

        function viewFrameDetail(fixtureId, frameIdx) {
            const scorecard = scorecards.find(s => s.fixtureId === fixtureId);
            if (!scorecard) return;
            
            const frame = scorecard.frames[frameIdx];
            const match = fixturesData.find(f => f.id === fixtureId);
            
            document.getElementById('frameDetailContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 24px; font-weight: 800; margin-bottom: 8px;">Frame ${frameIdx + 1}</div>
                    <div style="color: var(--text-muted);">vs ${match.opponent}</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 48px; font-weight: 800; color: ${frame.result === 'W' ? '#2ed573' : frame.result === 'L' ? '#ff4757' : '#ffd700'}; margin-bottom: 8px;">
                        ${frame.result || '-'}
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Result</div>
                </div>
                ${frame.player ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Player</div>
                        <div style="font-weight: 800;">${frame.player}</div>
                    </div>
                ` : ''}
                ${frame.notes ? `
                    <div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Notes</div>
                        <div>${frame.notes}</div>
                    </div>
                ` : ''}
            `;
            
            openModal('frameDetailModal');
        }

        // Profile Functions - Enhanced for System Creator editing
        function renderProfile() {
            if (!currentUser) return;
            
            // Determine which player to view/edit
            const targetUsername = viewingPlayerUsername || currentUser.username;
            const player = teamData.find(p => p.username === targetUsername);
            if (!player) return;
            
            const isSystemCreator = currentUser.isSystemCreator;
            const isOwnProfile = targetUsername === currentUser.username;
            const canEditProfile = isSystemCreator || isOwnProfile;
            
            // Update page title
            document.getElementById('profilePageTitle').textContent = isOwnProfile ? 'My Profile' : `${player.name}'s Profile`;
            document.getElementById('profilePageSubtitle').textContent = isSystemCreator && !isOwnProfile ? 'System Creator Editing Mode' : 'Player Statistics & History';
            
            const container = document.getElementById('profileContent');
            
            // Calculate stats
            const played = player.played || 0;
            const won = player.won || 0;
            const lost = player.lost || 0;
            const winRate = played > 0 ? ((won / played) * 100).toFixed(1) : 0;
            const lostPercent = played > 0 ? ((lost / played) * 100).toFixed(1) : 0;
            
            // Get contact info with fallbacks
            const email = player.email || `${player.username.toLowerCase()}@rackcafe.com`;
            const phone = player.phone || '07490518455';
            
            // Check if user has custom photo
            const photoURL = player.photoURL || null;
            
            // Generate edit buttons HTML if System Creator
            const editBtn = (field, label) => isSystemCreator ? 
                `<button class="edit-field-btn" onclick="openEditProfileField('${field}', '${label}', '${player.username}')" title="Edit ${label}"><i class="fas fa-pencil-alt"></i></button>` : '';
            
            container.innerHTML = `
                <div class="profile-grid">
                    <!-- Left: Profile Card -->
                    <div class="profile-card-main">
                        <div class="profile-avatar-container" onclick="${canEditProfile ? `document.getElementById('profilePicInput').click()` : ''}" title="${canEditProfile ? 'Click to change photo' : ''}">
                            ${photoURL ? 
                                `<img src="${photoURL}" alt="${player.name}">` : 
                                `<div class="initials-avatar">${player.initials}</div>`
                            }
                            ${canEditProfile ? `
                                <div class="avatar-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="profile-name">${player.name} ${isSystemCreator ? editBtn('name', 'Name') : ''}</div>
                        <div class="profile-team">Rack Café Utd</div>
                        
                        <div class="profile-info-rows">
                            <div class="profile-info-row">
                                <span class="profile-info-label">Role</span>
                                <span class="profile-info-value">${player.role}</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Email</span>
                                <span class="profile-info-value" style="font-size: 12px;">${email} ${isSystemCreator ? editBtn('email', 'Email') : ''}</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Telephone</span>
                                <span class="profile-info-value">${phone} ${isSystemCreator ? editBtn('phone', 'Phone') : ''}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Stats & Sections -->
                    <div class="profile-right-section">
                        <!-- Stats Row -->
                        <div class="profile-stats-row">
                            <div class="profile-stat-box">
                                <div class="stat-number-lg">${played}</div>
                                <div class="stat-label-small">Played</div>
                            </div>
                            <div class="profile-stat-box">
                                <div class="stat-number-lg" style="color: var(--success);">${won}</div>
                                <div class="stat-label-small">Won</div>
                                <div class="stat-percentage">(${winRate}%)</div>
                            </div>
                            <div class="profile-stat-box">
                                <div class="stat-number-lg" style="color: var(--danger);">${lost}</div>
                                <div class="stat-label-small">Lost</div>
                                <div class="stat-percentage">(${lostPercent}%)</div>
                            </div>
                        </div>
                        
                        <!-- Frames Section -->
                        <div class="profile-section">
                            <div class="section-header-green">
                                <span><i class="fas fa-layer-group" style="margin-right: 8px;"></i>Frames</span>
                            </div>
                            <div class="section-content">
                                ${player.gameHistory && player.gameHistory.length > 0 ? `
                                    <div class="frame-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;">
                                        ${player.gameHistory.slice(0, 10).map((game, idx) => `
                                            <div class="frame-box ${game.result === 'W' ? 'won' : 'lost'}" style="cursor: default;">
                                                <div class="frame-number">${idx + 1}</div>
                                                <div class="frame-result">${game.result}</div>
                                                <div class="frame-player" style="font-size: 10px; overflow: hidden; text-overflow: ellipsis;">${game.opponent}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="empty-state">
                                        <div class="empty-state-title">No frames</div>
                                        <div style="font-size: 13px;">This player hasn't played any frames this season. Check back here again soon.</div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- History Table (Full Width) -->
                <div class="history-table-wrapper">
                    <div class="section-header-green">
                        <span><i class="fas fa-history" style="margin-right: 8px;"></i>History</span>
                        ${isSystemCreator ? `<button class="add-season-btn" onclick="openEditSeasonModal(-1, '${player.username}')"><i class="fas fa-plus"></i> Add Season</button>` : ''}
                    </div>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Season</th>
                                <th>Ruleset</th>
                                <th class="text-center">Pl</th>
                                <th class="text-center">W</th>
                                <th class="text-center">L</th>
                                ${isSystemCreator ? '<th class="text-center">Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            ${generateHistoryRows(player, isSystemCreator)}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Update file input handler to target correct player if System Creator
            const fileInput = document.getElementById('profilePicInput');
            fileInput.onchange = (e) => handleProfilePicChange(e, targetUsername);
        }

        function generateHistoryRows(player, isSystemCreator = false) {
            // Ensure seasonHistory exists
            if (!player.seasonHistory) {
                player.seasonHistory = [];
            }
            
            // If no season history, create default entries based on current stats or examples
            if (player.seasonHistory.length === 0) {
                // Add current season
                player.seasonHistory.push({
                    season: 'Aug 25',
                    ruleset: 'EPA Rules',
                    played: player.played || 0,
                    won: player.won || 0,
                    lost: player.lost || 0
                });
                
                // Add example historical data only if no real data exists
                if (player.played === 0) {
                    player.seasonHistory.push(
                        { season: 'Feb 25', ruleset: 'EPA Rules', played: 9, won: 3, lost: 6 },
                        { season: 'Aug 24', ruleset: 'EPA Rules', played: 28, won: 5, lost: 23 },
                        { season: 'Feb 24', ruleset: 'EPA Rules', played: 33, won: 12, lost: 21 },
                        { season: 'Aug 23', ruleset: 'EPA Rules', played: 33, won: 6, lost: 27 }
                    );
                }
            }
            
            return player.seasonHistory.map((season, idx) => `
                <tr>
                    <td><strong>${season.season}</strong></td>
                    <td>${season.ruleset}</td>
                    <td class="text-center">${season.played}</td>
                    <td class="text-center">${season.won}</td>
                    <td class="text-center">${season.lost}</td>
                    ${isSystemCreator ? `
                        <td class="text-center">
                            <div class="season-actions">
                                <button class="season-edit-btn" onclick="openEditSeasonModal(${idx}, '${player.username}')" title="Edit Season"><i class="fas fa-pencil-alt"></i></button>
                                <button class="season-delete-btn" onclick="deleteSeason(${idx}, '${player.username}')" title="Delete Season"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    ` : ''}
                </tr>
            `).join('');
        }

        // Profile Editing Functions for System Creator
        let editingPlayerUsername = null;
        let editingSeasonIndex = -1;

        function openEditProfileField(field, label, username) {
            if (!currentUser || !currentUser.isSystemCreator) return;
            
            editingField = field;
            editingPlayerUsername = username;
            
            const player = teamData.find(p => p.username === username);
            if (!player) return;
            
            const currentValue = player[field] || '';
            
            document.getElementById('editFieldName').textContent = label;
            document.getElementById('editFieldLabel').textContent = label;
            document.getElementById('editFieldValue').value = currentValue;
            
            openModal('editProfileFieldModal');
        }

        function saveProfileFieldEdit() {
            if (!currentUser || !currentUser.isSystemCreator || !editingField || !editingPlayerUsername) return;
            
            const newValue = document.getElementById('editFieldValue').value.trim();
            if (!newValue) {
                showToast('Value cannot be empty', 'error');
                return;
            }
            
            const player = teamData.find(p => p.username === editingPlayerUsername);
            if (player) {
                player[editingField] = newValue;
                
                // If editing name, also update in credentials
                if (editingField === 'name') {
                    if (teamCredentials[editingPlayerUsername]) {
                        teamCredentials[editingPlayerUsername].name = newValue;
                    }
                }
                
                saveData();
                renderProfile();
                showToast(`${editingField.charAt(0).toUpperCase() + editingField.slice(1)} updated successfully`);
            }
            
            closeModal('editProfileFieldModal');
            editingField = null;
            editingPlayerUsername = null;
        }

        function openEditSeasonModal(index, username) {
            if (!currentUser || !currentUser.isSystemCreator) return;
            
            editingSeasonIndex = index;
            editingPlayerUsername = username;
            
            const player = teamData.find(p => p.username === username);
            if (!player) return;
            
            const isNew = index === -1;
            const season = isNew ? {} : (player.seasonHistory[index] || {});
            
            document.getElementById('seasonModalTitle').textContent = isNew ? 'Add Season' : 'Edit Season';
            document.getElementById('editSeasonIndex').value = index;
            document.getElementById('editSeasonName').value = season.season || '';
            document.getElementById('editSeasonRuleset').value = season.ruleset || 'EPA Rules';
            document.getElementById('editSeasonPlayed').value = season.played || 0;
            document.getElementById('editSeasonWon').value = season.won || 0;
            document.getElementById('editSeasonLost').value = season.lost || 0;
            
            openModal('editSeasonModal');
        }

        function saveSeasonEdit() {
            if (!currentUser || !currentUser.isSystemCreator || !editingPlayerUsername) return;
            
            const player = teamData.find(p => p.username === editingPlayerUsername);
            if (!player) return;
            
            const seasonData = {
                season: document.getElementById('editSeasonName').value.trim(),
                ruleset: document.getElementById('editSeasonRuleset').value.trim(),
                played: parseInt(document.getElementById('editSeasonPlayed').value) || 0,
                won: parseInt(document.getElementById('editSeasonWon').value) || 0,
                lost: parseInt(document.getElementById('editSeasonLost').value) || 0
            };
            
            if (!seasonData.season) {
                showToast('Season name is required', 'error');
                return;
            }
            
            if (!player.seasonHistory) player.seasonHistory = [];
            
            if (editingSeasonIndex === -1) {
                // Add new
                player.seasonHistory.push(seasonData);
                showToast('Season added successfully');
            } else {
                // Update existing
                player.seasonHistory[editingSeasonIndex] = seasonData;
                showToast('Season updated successfully');
            }
            
            saveData();
            renderProfile();
            closeModal('editSeasonModal');
        }

        function deleteSeason(index, username) {
            if (!currentUser || !currentUser.isSystemCreator) return;
            if (!confirm('Are you sure you want to delete this season record?')) return;
            
            const player = teamData.find(p => p.username === username);
            if (player && player.seasonHistory && player.seasonHistory[index]) {
                player.seasonHistory.splice(index, 1);
                saveData();
                renderProfile();
                showToast('Season deleted');
            }
        }

        function handleProfilePicChange(event, targetUsername = null) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                showToast('Image must be less than 2MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoURL = e.target.result;
                
                // Determine target player
                const username = targetUsername || currentUser.username;
                const player = teamData.find(p => p.username === username);
                
                if (player) {
                    player.photoURL = photoURL;
                    saveData();
                    
                    // Re-render profile
                    renderProfile();
                    
                    // Update header avatar if it's the current user
                    if (username === currentUser.username) {
                        const headerAvatar = document.getElementById('userAvatar');
                        if (headerAvatar) {
                            headerAvatar.innerHTML = `<img src="${photoURL}" style="width: 100%; height: 100%; border-radius: 10px; object-fit: cover;">`;
                        }
                    }
                    
                    showToast('Profile picture updated');
                }
            };
            reader.readAsDataURL(file);
        }

        function openAddResultModal() {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin access required', 'error');
                return;
            }
            
            const frameInputs = document.getElementById('frameInputs');
            frameInputs.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                frameInputs.innerHTML += `
                    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-align: center;">Frame ${i + 1}</div>
                        <select id="frameResult${i}" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 6px; font-size: 13px; margin-bottom: 6px;">
                            <option value="">-</option>
                            <option value="W">Win</option>
                            <option value="L">Loss</option>
                        </select>
                        <select id="framePlayer${i}" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 6px; font-size: 12px;">
                            <option value="">Player</option>
                            ${teamData.map(p => `<option value="${p.name}">${p.initials}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            
            const oppSelect = document.getElementById('resultOpponent');
            oppSelect.innerHTML = '<option value="">Select opponent...</option>';
            opponentsList.forEach(opp => {
                const opt = document.createElement('option');
                opt.value = opp;
                opt.textContent = opp;
                oppSelect.appendChild(opt);
            });
            
            document.getElementById('resultDate').valueAsDate = new Date();
            openModal('addResultModal');
        }

        function submitMatchResult() {
            const opponent = document.getElementById('resultOpponent').value;
            const ourScore = parseInt(document.getElementById('ourScore').value) || 0;
            const theirScore = parseInt(document.getElementById('theirScore').value) || 0;
            const date = document.getElementById('resultDate').value;
            const venue = document.getElementById('resultVenue').value;
            
            if (!opponent || !date) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            let result;
            if (ourScore > theirScore) result = 'W';
            else if (ourScore < theirScore) result = 'L';
            else result = 'D';
            
            const matchId = Date.now();
            
            fixturesData.push({
                id: matchId,
                opponent,
                ourScore,
                theirScore,
                result,
                date,
                venue,
                played: true
            });
            
            const frames = [];
            let calculatedOurScore = 0;
            let calculatedTheirScore = 0;
            
            for (let i = 0; i < 10; i++) {
                const frameResult = document.getElementById(`frameResult${i}`).value;
                const framePlayer = document.getElementById(`framePlayer${i}`).value;
                if (frameResult) {
                    frames.push({
                        result: frameResult,
                        player: framePlayer,
                        notes: ''
                    });
                    if (frameResult === 'W') calculatedOurScore++;
                    else if (frameResult === 'L') calculatedTheirScore++;
                }
            }
            
            const finalOurScore = frames.length > 0 ? calculatedOurScore : ourScore;
            const finalTheirScore = frames.length > 0 ? calculatedTheirScore : theirScore;
            
            scorecards.push({
                fixtureId: matchId,
                frames: frames.length > 0 ? frames : Array(10).fill({result: '', player: '', notes: ''})
            });
            
            leagueData[0].played++;
            leagueData[0].points += finalOurScore;
            if (finalOurScore > finalTheirScore) leagueData[0].won++;
            else if (finalOurScore < finalTheirScore) leagueData[0].lost++;
            
            let opp = leagueData.find(t => t.name === opponent);
            if (!opp) {
                opp = { id: leagueData.length + 1, name: opponent, played: 0, won: 0, lost: 0, points: 0, isUs: false };
                leagueData.push(opp);
            }
            opp.played++;
            opp.points += finalTheirScore;
            if (finalTheirScore > finalOurScore) opp.won++;
            else if (finalTheirScore < finalOurScore) opp.lost++;
            
            frames.forEach(frame => {
                if (frame.player && frame.result) {
                    const player = teamData.find(p => p.name === frame.player);
                    if (player) {
                        player.played++;
                        if (!player.gameHistory) player.gameHistory = [];
                        player.gameHistory.unshift({
                            date: date,
                            opponent: opponent,
                            result: frame.result,
                            frame: player.gameHistory.length + 1
                        });
                        if (player.gameHistory.length > 10) player.gameHistory.pop();
                        
                        if (frame.result === 'W') player.won++;
                        else player.lost++;
                        player.winRate = Math.round((player.won / player.played) * 100);
                    }
                }
            });
            
            saveData();
            closeModal('addResultModal');
            updateDisplays();
            showToast('Result saved successfully');
        }

        function openScheduleModal() {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Admin access required', 'error');
                return;
            }
            
            const select = document.getElementById('scheduleOpponent');
            select.innerHTML = '<option value="">Select opponent...</option>';
            opponentsList.forEach(opp => {
                const opt = document.createElement('option');
                opt.value = opp;
                opt.textContent = opp;
                select.appendChild(opt);
            });
            document.getElementById('scheduleDate').valueAsDate = new Date();
            openModal('scheduleModal');
        }

        function submitSchedule() {
            const opponent = document.getElementById('scheduleOpponent').value;
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!opponent || !date) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            fixturesData.push({
                id: Date.now(),
                opponent,
                date,
                time,
                venue: 'home',
                played: false
            });
            
            saveData();
            closeModal('scheduleModal');
            updateDisplays();
            showToast('Match scheduled');
        }

        function attemptMaintenanceLogin() {
            document.getElementById('maintenanceOverlay').classList.remove('active');
            showLogin();
            showToast('🔓 Maintenance override engaged', 'error');
        }

        function manualSync() {
            loadData();
            updateDisplays();
            showToast('Data refreshed');
        }

        // Startup
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
