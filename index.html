<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rack Caf√© Utd - Pool League</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-dark: #0a0a14; --bg-card: #151520; --primary-pink: #e94560; --primary-pink-dark: #d63d56; --accent-orange: #f39c12; --gold-primary: #ffd700; --text-primary: #ffffff; --text-secondary: #a0a0b8; --text-muted: #606070; --border-color: #2a2a3a; --success: #2ed573; --danger: #ff4757; --info: #00ffff; --reserve-color: #9b59b6; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1420 100%); color: var(--text-primary); min-height: 100vh; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* MAINTENANCE OVERLAY - CRITICAL FIXES */
        .maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a20 100%);
            z-index: 999999; /* Highest possible z-index */
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(20px);
        }
        
        .maintenance-overlay.active {
            display: flex !important; /* Force display */
            animation: fadeIn 0.3s ease;
        }
        
        .maintenance-icon {
            font-size: 80px;
            color: #ff4757;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
            text-shadow: 0 0 30px rgba(255, 71, 87, 0.5);
        }
        
        .maintenance-title {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #ff4757, #ff6348);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .maintenance-message {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 500px;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .maintenance-hint {
            position: fixed;
            bottom: 40px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
            font-family: monospace;
            animation: blink 3s infinite;
        }

        .login-screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: radial-gradient(circle at center, #151525 0%, #0a0a14 100%); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99998; }
        .login-screen.show { display: flex; }
        .logo { width: 110px; height: 110px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #e94560 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(233, 69, 96, 0.4); position: relative; cursor: pointer; }
        .logo::before { content: ''; position: absolute; width: 50%; height: 50%; border: 5px solid rgba(255,255,255,0.95); border-radius: 50%; }
        .logo::after { content: ''; position: absolute; width: 22%; height: 22%; background: white; border-radius: 50%; }
        .login-card { background: rgba(21, 21, 32, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px; width: 100%; max-width: 420px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6); animation: slideUp 0.6s ease; }
        .login-header { text-align: center; margin-bottom: 35px; }
        .login-header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 800; }
        .login-error { background: rgba(233, 69, 96, 0.1); border: 1px solid rgba(233, 69, 96, 0.3); color: #ff4757; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; display: none; align-items: center; gap: 8px; }
        .login-error.show { display: flex; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; font-weight: 700; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }
        .form-input { width: 100%; padding: 16px 16px 16px 48px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: white; font-size: 15px; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: var(--primary-pink); background: rgba(255, 255, 255, 0.08); }
        .login-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; margin-top: 10px; box-shadow: 0 4px 25px rgba(233, 69, 96, 0.4); transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 35px rgba(233, 69, 96, 0.5); }
        
        .dashboard { display: none; min-height: 100vh; padding-bottom: 90px; }
        .dashboard.active { display: block; animation: fadeIn 0.5s; }
        .header { background: rgba(15, 15, 25, 0.98); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 42px; height: 42px; background: linear-gradient(135deg, #ff6b35 0%, #e94560 100%); border-radius: 10px; position: relative; }
        .header-logo::before { content: ''; position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .header-title h2 { font-size: 17px; font-weight: 800; }
        .header-title p { font-size: 12px; color: var(--text-secondary); }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .sync-badge { background: rgba(46, 213, 115, 0.15); color: #2ed573; padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(46, 213, 115, 0.3); cursor: pointer; }
        
        .profile-container { position: relative; display: none; }
        .profile-container.show { display: block; }
        .avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-orange) 0%, var(--primary-pink) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .avatar:hover { transform: scale(1.05); }
        
        .dropdown-menu { position: absolute; top: calc(100% + 12px); right: 0; background: rgba(21, 21, 32, 0.98); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 16px; padding: 8px; min-width: 280px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; }
        .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .admin-panel { background: linear-gradient(135deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.05) 100%); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 20px; padding: 24px; margin-bottom: 24px; position: relative; }
        .admin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
        @media (max-width: 768px) { .admin-grid { grid-template-columns: 1fr; } }
        .admin-btn { background: rgba(212, 175, 55, 0.15); border: 1px solid rgba(212, 175, 55, 0.3); color: var(--gold-primary); padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.3s; font-family: inherit; font-weight: 700; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .admin-btn:hover { background: rgba(212, 175, 55, 0.25); transform: translateY(-2px); }
        
        .next-match-card { background: linear-gradient(135deg, #e94560 0%, #c73e54 100%); border-radius: 20px; padding: 28px; margin-bottom: 24px; position: relative; overflow: hidden; box-shadow: 0 15px 50px rgba(233, 69, 96, 0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px 10px; text-align: center; transition: all 0.3s; }
        .stat-value { font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #e94560, #f39c12); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        
        .main-content { padding: 24px 20px; max-width: 900px; margin: 0 auto; }
        .page-title { margin-bottom: 24px; }
        .page-title h1 { font-size: 32px; margin-bottom: 6px; font-weight: 800; }
        .page-title p { color: var(--text-secondary); font-size: 15px; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.3s ease; }
        .modal-header { background: linear-gradient(135deg, rgba(233,69,96,0.2) 0%, rgba(243,156,18,0.1) 100%); padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: 800; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; }
        .submit-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin-top: 24px; }
        
        #systemCreatorModal .modal-container { max-width: 900px; border: 2px solid rgba(0, 255, 255, 0.3); }
        
        .maintenance-toggle { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(255, 71, 87, 0.1); border: 1px solid rgba(255, 71, 87, 0.3); border-radius: 12px; margin-bottom: 12px; cursor: pointer; }
        .maintenance-toggle.active { background: rgba(0, 255, 255, 0.1); border-color: rgba(0, 255, 255, 0.3); }
        .toggle-switch { width: 50px; height: 26px; background: rgba(255, 255, 255, 0.1); border-radius: 13px; position: relative; transition: all 0.3s; }
        .maintenance-toggle.active .toggle-switch { background: #00ffff; }
        .toggle-switch::after { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s; }
        .maintenance-toggle.active .toggle-switch::after { left: 26px; }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--border-color); padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 12px; z-index: 2000; opacity: 0; transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .fixture-card { background: #151520; border: 1px solid #2a2a3a; border-radius: 16px; padding: 20px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .fixture-date { min-width: 60px; text-align: center; }
        .date-day { font-size: 28px; font-weight: 900; color: #e94560; line-height: 1; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 15, 25, 0.98); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 12px 0 20px; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #606070; text-decoration: none; font-size: 10px; font-weight: 700; padding: 8px; border-radius: 16px; flex: 1; max-width: 90px; cursor: pointer; background: none; border: none; font-family: inherit; }
        .nav-item.active { color: var(--primary-pink); }
        
        .header-login-btn { background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 10px; color: white; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .header-login-btn.hidden { display: none !important; }
        
        .role-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-left: 8px; border: 1px solid; }
        .badge-system-creator { background: rgba(0, 255, 255, 0.15); border-color: #00ffff; color: #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); animation: pulse 2s infinite; }
        .badge-captain { background: rgba(255, 215, 0, 0.15); border-color: #ffd700; color: #ffd700; }
        
        kbd { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <!-- MAINTENANCE OVERLAY - ENSURE THIS IS FIRST IN BODY -->
    <div id="maintenanceOverlay" class="maintenance-overlay">
        <i class="fas fa-radiation maintenance-icon"></i>
        <div class="maintenance-title">SYSTEM MAINTENANCE</div>
        <div id="maintenanceMessageText" class="maintenance-message">
            The server is currently undergoing scheduled maintenance.<br>
            Only authorized System Administrators may access the platform at this time.
        </div>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
            <button onclick="attemptMaintenanceLogin()" class="login-btn" style="width: auto; padding: 12px 32px; background: rgba(0,0,0,0.5); border: 1px solid #00ffff; color: #00ffff;">
                <i class="fas fa-terminal"></i> SYS_ADMIN LOGIN
            </button>
        </div>
        <div class="maintenance-hint">
            Press <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>M</kbd> to reveal login
        </div>
    </div>

    <div class="login-screen" id="loginScreen">
        <div class="logo" id="loginLogo"></div>
        <div class="login-card">
            <div class="login-header">
                <h1>Rack Caf√© Utd</h1>
                <p style="color: var(--text-secondary);">Huddersfield Tuesday Night Pool League</p>
            </div>
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Invalid credentials</span>
            </div>
            <form onsubmit="event.preventDefault(); doLogin();">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-input" id="usernameInput" required autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-input" id="passwordInput" required autocomplete="current-password">
                    </div>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-arrow-right-to-bracket"></i> LOGIN
                </button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: rgba(255,255,255,0.1);" onclick="cancelLogin()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </form>
            <div style="text-align: center; margin-top: 16px; font-size: 11px; color: var(--text-muted);">
                <i class="fas fa-shield-alt" style="color: var(--success);"></i> System Secure
            </div>
        </div>
    </div>

    <div class="dashboard active" id="dashboard">
        <header class="header">
            <div class="header-left">
                <div class="header-logo"></div>
                <div class="header-title">
                    <h2>Rack Caf√© Utd <span id="headerRoleBadge"></span></h2>
                    <p>Huddersfield Tuesday Night Pool League</p>
                </div>
            </div>
            <div class="header-right">
                <div class="sync-badge" id="syncBadge" onclick="manualSync()">
                    <i class="fas fa-check-circle"></i>
                    <span id="syncStatus">Ready</span>
                </div>
                <button id="headerLoginBtn" class="header-login-btn" onclick="showLogin()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <div class="profile-container" id="profileContainer">
                    <div class="avatar" id="userAvatar" style="display: none;">--</div>
                    <div class="dropdown-menu" id="profileDropdown">
                        <div class="user-info" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color);">
                            <div class="user-name" id="userNameDisplay" style="font-weight: 800; margin-bottom: 4px;">User</div>
                            <div class="user-role" id="userRoleDisplay" style="font-size: 12px; color: var(--text-secondary);">Player</div>
                        </div>
                        <div class="dropdown-item" onclick="openSystemCreatorModal(); toggleDropdown();" id="systemCreatorMenuItem" style="display: none; color: #00ffff;">
                            <i class="fas fa-terminal"></i> System Creator
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Log Out
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="tab-content active" id="homeTab">
                <div class="page-title">
                    <h1>Dashboard</h1>
                    <p id="welcomeText">Welcome to Rack Caf√© Utd</p>
                </div>
                <div class="next-match-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 10px; font-weight: 700;">
                            <i class="fas fa-calendar-check"></i> Next Match
                        </div>
                        <span style="background: rgba(255, 255, 255, 0.2); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 800;">Home</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
                        <div style="text-align: center; flex: 1;">
                            <div style="font-size: 20px; font-weight: 800;">Rack Caf√© Utd</div>
                        </div>
                        <div style="font-size: 28px; font-weight: 900; opacity: 0.5; margin: 0 30px;">VS</div>
                        <div style="text-align: center; flex: 1;">
                            <div style="font-size: 20px; font-weight: 800;">TBD</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statPos">1st</div>
                        <div class="stat-label">Position</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPlayed">0</div>
                        <div class="stat-label">Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWon">0</div>
                        <div class="stat-label">Won</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPoints">0</div>
                        <div class="stat-label">Points</div>
                    </div>
                </div>

                <div class="admin-panel" id="adminPanel" style="display: none;">
                    <div style="font-size: 18px; font-weight: 800; margin-bottom: 8px; color: var(--gold-primary);">
                        <i class="fas fa-shield-alt"></i> Captain's Panel
                    </div>
                    <div class="admin-grid">
                        <button class="admin-btn" onclick="toggleMaintenanceMode()">
                            <i class="fas fa-power-off"></i> Toggle Maintenance
                        </button>
                        <button class="admin-btn" onclick="exportData()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                </div>

                <div class="admin-panel" style="border-color: #00ffff; background: rgba(0,255,255,0.05);">
                    <div style="font-size: 18px; font-weight: 800; margin-bottom: 8px; color: #00ffff;">
                        <i class="fas fa-terminal"></i> System Creator
                    </div>
                    <div id="maintenanceStatusDisplay" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        Checking status...
                    </div>
                    <div class="admin-grid">
                        <button class="admin-btn" onclick="toggleMaintenanceMode()" style="border-color: #ff4757; color: #ff4757; background: rgba(255,71,87,0.1);">
                            <i class="fas fa-radiation"></i> <span id="maintBtnText">Enable Lockdown</span>
                        </button>
                        <button class="admin-btn" onclick="clearMaintenanceMode()" style="border-color: #00ff00; color: #00ff00;">
                            <i class="fas fa-unlock"></i> Emergency Unlock
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('homeTab', this)"><i class="fas fa-home"></i><span>Home</span></button>
        </nav>
    </div>

    <!-- System Creator Modal -->
    <div class="modal-overlay" id="systemCreatorModal">
        <div class="modal-container">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0,255,255,0.3);">
                <div class="modal-title" style="color: #00ffff;"><i class="fas fa-terminal"></i> SYSTEM CREATOR PANEL</div>
                <button class="modal-close" onclick="closeSystemCreatorModal()"><i class="fas fa-times" style="color: #fff;"></i></button>
            </div>
            <div class="modal-body">
                <div class="maintenance-toggle" id="maintenanceToggle" onclick="toggleMaintenanceMode()">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-power-off" style="font-size: 20px; color: #ff4757;"></i>
                        <div>
                            <div style="font-weight: 800;">Maintenance Mode</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Lock all users except System Creator</div>
                        </div>
                    </div>
                    <div class="toggle-switch"></div>
                </div>
                <div id="maintenanceActiveText" style="display: none; padding: 12px; background: rgba(255,71,87,0.1); border-radius: 8px; border-left: 3px solid #ff4757; margin-bottom: 16px; font-size: 12px; color: #ff4757;">
                    <i class="fas fa-exclamation-triangle"></i> Maintenance is currently ACTIVE
                </div>
                <button class="submit-btn" onclick="forceSaveMaintenance()">
                    <i class="fas fa-save"></i> Force Save State
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Success</span>
    </div>

    <script>
        // CRITICAL: Define storage key
        const STORAGE_KEY = 'rackCafe_Maintenance_v1';
        let currentUser = null;
        let maintenanceMode = { enabled: false, timestamp: null };
        
        // Admin credentials
        const credentials = {
            'admin': { password: 'admin123', name: 'System Admin', isSystemCreator: true },
            'captain': { password: 'captain', name: 'Captain', isSystemCreator: false }
        };

        // CRITICAL: Check maintenance immediately before anything else
        (function initMaintenanceCheck() {
            console.log('üîç Checking maintenance mode...');
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                console.log('Raw localStorage:', saved);
                
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.maintenanceMode) {
                        maintenanceMode = data.maintenanceMode;
                        console.log('‚úÖ Loaded maintenance state:', maintenanceMode);
                    }
                }
                
                // Apply immediately
                applyMaintenanceState();
            } catch (e) {
                console.error('‚ùå Maintenance check failed:', e);
            }
        })();

        function applyMaintenanceState() {
            const overlay = document.getElementById('maintenanceOverlay');
            const statusText = document.getElementById('maintenanceStatusDisplay');
            const maintText = document.getElementById('maintenanceActiveText');
            const toggle = document.getElementById('maintenanceToggle');
            
            if (maintenanceMode.enabled) {
                console.log('üîí MAINTENANCE IS ENABLED - Showing overlay');
                
                // Show overlay if no system creator logged in
                if (!currentUser || !currentUser.isSystemCreator) {
                    if (overlay) overlay.classList.add('active');
                }
                
                if (statusText) statusText.innerHTML = '<span style="color: #ff4757;"><i class="fas fa-lock"></i> MAINTENANCE MODE ACTIVE</span>';
                if (maintText) maintText.style.display = 'block';
                if (toggle) toggle.classList.add('active');
                
                // Update button text
                const btnText = document.getElementById('maintBtnText');
                if (btnText) btnText.textContent = 'Disable Lockdown';
            } else {
                console.log('üîì Maintenance is disabled');
                if (overlay) overlay.classList.remove('active');
                if (statusText) statusText.innerHTML = '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> System Online</span>';
                if (maintText) maintText.style.display = 'none';
                if (toggle) toggle.classList.remove('active');
                
                const btnText = document.getElementById('maintBtnText');
                if (btnText) btnText.textContent = 'Enable Lockdown';
            }
        }

        function toggleMaintenanceMode() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            // Toggle state
            maintenanceMode.enabled = !maintenanceMode.enabled;
            maintenanceMode.timestamp = new Date().toISOString();
            maintenanceMode.setBy = currentUser.name;
            
            console.log('üîÑ Toggling maintenance to:', maintenanceMode.enabled);
            
            // Save immediately
            saveMaintenanceState();
            
            // Apply UI changes
            applyMaintenanceState();
            
            showToast(maintenanceMode.enabled ? 'üîí Maintenance Mode ENABLED' : 'üîì Maintenance Mode DISABLED', 
                     maintenanceMode.enabled ? 'error' : 'success');
            
            // If enabling, show overlay immediately for testing
            if (maintenanceMode.enabled) {
                setTimeout(() => {
                    const overlay = document.getElementById('maintenanceOverlay');
                    if (overlay) overlay.classList.add('active');
                }, 500);
            }
        }

        function saveMaintenanceState() {
            try {
                const data = {
                    maintenanceMode: maintenanceMode,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                console.log('üíæ Saved to localStorage:', data);
            } catch (e) {
                console.error('‚ùå Failed to save:', e);
                showToast('Failed to save state', 'error');
            }
        }

        function forceSaveMaintenance() {
            saveMaintenanceState();
            showToast('State force-saved', 'success');
        }

        function clearMaintenanceMode() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator required', 'error');
                return;
            }
            
            maintenanceMode = { enabled: false, timestamp: null, setBy: null };
            saveMaintenanceState();
            applyMaintenanceState();
            
            const overlay = document.getElementById('maintenanceOverlay');
            const loginScreen = document.getElementById('loginScreen');
            
            if (overlay) overlay.classList.remove('active');
            if (loginScreen) loginScreen.classList.remove('show');
            
            showToast('üö® Emergency unlock executed', 'success');
        }

        function attemptMaintenanceLogin() {
            const overlay = document.getElementById('maintenanceOverlay');
            const loginScreen = document.getElementById('loginScreen');
            
            if (overlay) overlay.classList.remove('active');
            if (loginScreen) loginScreen.classList.add('show');
            
            // Visual feedback
            const loginCard = document.querySelector('.login-card');
            if (loginCard) {
                loginCard.style.border = '2px solid #00ffff';
                loginCard.style.boxShadow = '0 0 30px rgba(0, 255, 255, 0.3)';
            }
            
            showToast('üîì Maintenance override: Login as System Creator', 'error');
        }

        function cancelLogin() {
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) loginScreen.classList.remove('show');
            
            // Re-check maintenance
            if (maintenanceMode.enabled) {
                const overlay = document.getElementById('maintenanceOverlay');
                if (overlay) overlay.classList.add('active');
            }
        }

        function showLogin() {
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) loginScreen.classList.add('show');
        }

        function doLogin() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            const user = credentials[username];
            
            if (user && user.password === password) {
                // Check maintenance
                if (maintenanceMode.enabled && !user.isSystemCreator) {
                    if (errorDiv) {
                        errorDiv.innerHTML = '<i class="fas fa-ban"></i> System under maintenance - Only System Creator may access';
                        errorDiv.classList.add('show');
                        errorDiv.style.color = '#ff4757';
                    }
                    return;
                }
                
                currentUser = { username, ...user };
                
                // Hide login
                document.getElementById('loginScreen').classList.remove('show');
                document.getElementById('loginError').classList.remove('show');
                
                // Show profile
                document.getElementById('headerLoginBtn').classList.add('hidden');
                document.getElementById('profileContainer').classList.add('show');
                document.getElementById('userAvatar').textContent = user.name.split(' ').map(n => n[0]).join('');
                document.getElementById('userAvatar').style.display = 'flex';
                document.getElementById('userNameDisplay').innerHTML = user.name + (user.isSystemCreator ? ' <span class="role-badge badge-system-creator">SYS_CREATOR</span>' : '');
                document.getElementById('userRoleDisplay').textContent = user.isSystemCreator ? 'System Creator' : 'Captain';
                
                if (user.isSystemCreator) {
                    document.getElementById('systemCreatorMenuItem').style.display = 'flex';
                    document.getElementById('adminPanel').style.display = 'block';
                }
                
                // Re-apply maintenance (removes overlay for system creator)
                applyMaintenanceState();
                
                showToast('Welcome ' + user.name);
            } else {
                if (errorDiv) {
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid credentials';
                    errorDiv.classList.add('show');
                }
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('headerLoginBtn').classList.remove('hidden');
            document.getElementById('profileContainer').classList.remove('show');
            document.getElementById('userAvatar').style.display = 'none';
            document.getElementById('systemCreatorMenuItem').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            
            // Re-check maintenance
            applyMaintenanceState();
        }

        function openSystemCreatorModal() {
            document.getElementById('systemCreatorModal').classList.add('show');
            // Update toggle visual
            const toggle = document.getElementById('maintenanceToggle');
            if (maintenanceMode.enabled && toggle) toggle.classList.add('active');
        }

        function closeSystemCreatorModal() {
            document.getElementById('systemCreatorModal').classList.remove('show');
        }

        function toggleDropdown() {
            document.getElementById('profileDropdown').classList.toggle('show');
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            const text = document.getElementById('toastMessage');
            
            text.textContent = msg;
            icon.className = type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
            icon.style.color = type === 'error' ? '#ff4757' : '#2ed573';
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function exportData() {
            const data = {
                maintenanceMode: maintenanceMode,
                exported: new Date().toISOString()
            };
            console.log('Export:', data);
            showToast('Data exported to console');
        }

        function manualSync() {
            applyMaintenanceState();
            showToast('Status refreshed');
        }

        // Secret key listener
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && (e.key === 'm' || e.key === 'M')) {
                e.preventDefault();
                console.log('üîë Secret key pressed');
                
                if (maintenanceMode.enabled || (currentUser && currentUser.isSystemCreator)) {
                    attemptMaintenanceLogin();
                } else {
                    showToast('Maintenance mode not active', 'error');
                }
            }
        });

        // Check maintenance on visibility change (when user returns to tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÅÔ∏è Tab visible, re-checking maintenance...');
                // Reload from storage to catch changes from other tabs
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.maintenanceMode) {
                        maintenanceMode = data.maintenanceMode;
                        applyMaintenanceState();
                    }
                }
            }
        });

        console.log('üöÄ App initialized');
    </script>
</body>
</html>
