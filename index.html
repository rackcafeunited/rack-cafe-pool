<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rack Café Utd - Pool League</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-dark: #0a0a14; --bg-card: #151520; --primary-pink: #e94560; --primary-pink-dark: #d63d56; --accent-orange: #f39c12; --gold-primary: #ffd700; --text-primary: #ffffff; --text-secondary: #a0a0b8; --text-muted: #606070; --border-color: #2a2a3a; --success: #2ed573; --danger: #ff4757; --info: #00ffff; --reserve-color: #9b59b6; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1420 100%); color: var(--text-primary); min-height: 100vh; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes hackProgress { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: radial-gradient(circle at center, #151525 0%, #0a0a14 100%); }
        .logo { width: 110px; height: 110px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #e94560 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(233, 69, 96, 0.4); position: relative; animation: float 6s ease-in-out infinite; cursor: pointer; }
        .logo::before { content: ''; position: absolute; width: 50%; height: 50%; border: 5px solid rgba(255,255,255,0.95); border-radius: 50%; }
        .logo::after { content: ''; position: absolute; width: 22%; height: 22%; background: white; border-radius: 50%; }
        .login-card { background: rgba(21, 21, 32, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px; width: 100%; max-width: 420px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6); animation: slideUp 0.6s ease; }
        .login-header { text-align: center; margin-bottom: 35px; }
        .login-header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 800; }
        .login-header p { color: var(--text-secondary); font-size: 14px; }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; font-weight: 700; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 16px 16px 16px 48px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: white; font-size: 15px; transition: all 0.3s; font-family: inherit; }
        .form-textarea { min-height: 120px; resize: vertical; padding: 16px; }
        
        /* Enhanced Dropdown Styling for Readability */
        .form-select { 
            cursor: pointer; 
            appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a0a0b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); 
            background-repeat: no-repeat; 
            background-position: right 16px center; 
            padding-right: 40px; 
            font-weight: 600;
        }
        .form-select:focus { 
            outline: none; 
            border-color: var(--primary-pink); 
            background: rgba(255, 255, 255, 0.08); 
        }
        .form-select option { 
            background: var(--bg-card); 
            color: #ffffff; 
            font-size: 15px; 
            padding: 12px; 
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            line-height: 1.5;
        }
        /* Ensure dropdown text is readable on all browsers */
        select.form-select {
            color: #ffffff !important;
            background-color: var(--bg-card) !important;
        }
        select.form-select option {
            background-color: #151520 !important;
            color: #ffffff !important;
            padding: 12px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
        }
        /* Reserve role styling in dropdowns */
        select.form-select option[value="Reserve"] {
            background-color: #9b59b6 !important;
            color: white !important;
        }
        
        input[type="time"].form-input { padding-left: 16px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-pink); background: rgba(255, 255, 255, 0.08); }
        .login-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; box-shadow: 0 4px 25px rgba(233, 69, 96, 0.4); transition: all 0.3s; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 35px rgba(233, 69, 96, 0.5); }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .login-error { background: rgba(233, 69, 96, 0.1); border: 1px solid rgba(233, 69, 96, 0.3); color: #ff4757; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; display: none; align-items: center; gap: 8px; }
        .login-error.show { display: flex; }
        .dashboard { display: none; min-height: 100vh; padding-bottom: 90px; }
        .dashboard.active { display: block; animation: fadeIn 0.5s; }
        .header { background: rgba(15, 15, 25, 0.98); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 42px; height: 42px; background: linear-gradient(135deg, #ff6b35 0%, #e94560 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; }
        .header-logo::before { content: ''; position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; }
        .header-logo::after { content: ''; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; }
        .header-title h2 { font-size: 17px; font-weight: 800; }
        .header-title p { font-size: 12px; color: var(--text-secondary); }
        .header-right { display: flex; align-items: center; gap: 12px; position: relative; }
        .sync-badge { background: rgba(46, 213, 115, 0.15); color: #2ed573; padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(46, 213, 115, 0.3); cursor: pointer; transition: all 0.3s; }
        .sync-badge.syncing { animation: pulse 1.5s infinite; background: rgba(233, 69, 96, 0.15); color: #e94560; border-color: rgba(233, 69, 96, 0.3); }
        .sync-badge.offline { background: rgba(255, 193, 7, 0.15); color: #ffc107; border-color: rgba(255, 193, 7, 0.3); }
        .profile-container { position: relative; }
        .avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-orange) 0%, var(--primary-pink) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; position: relative; user-select: none; }
        .avatar:hover { transform: scale(1.05); border-color: rgba(233, 69, 96, 0.5); box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3); }
        .avatar.active { border-color: var(--primary-pink); box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2); }
        .dropdown-menu { position: absolute; top: calc(100% + 12px); right: 0; background: rgba(21, 21, 32, 0.98); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 16px; padding: 8px; min-width: 240px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; }
        .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-menu::before { content: ''; position: absolute; top: -6px; right: 16px; width: 12px; height: 12px; background: rgba(21, 21, 32, 0.98); border-left: 1px solid var(--border-color); border-top: 1px solid var(--border-color); transform: rotate(45deg); }
        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-decoration: none; color: var(--text-primary); font-size: 14px; font-weight: 600; }
        .dropdown-item:hover { background: rgba(255, 255, 255, 0.05); }
        .dropdown-item.admin-only { color: var(--gold-primary); }
        .dropdown-item.admin-only:hover { background: rgba(212, 175, 55, 0.1); }
        .dropdown-item.system-creator { color: #00ffff; background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.2); margin: 4px 0; }
        .dropdown-item.system-creator:hover { background: rgba(0, 255, 255, 0.15); }
        .dropdown-item.logout:hover { background: rgba(233, 69, 96, 0.1); color: #ff4757; }
        .dropdown-item i { width: 24px; text-align: center; font-size: 16px; }
        .dropdown-divider { height: 1px; background: var(--border-color); margin: 8px 0; }
        .user-info { padding: 12px 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px; }
        .user-name { font-weight: 800; font-size: 15px; margin-bottom: 2px; }
        .user-role { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .user-role.reserve { color: var(--reserve-color); }
        .main-content { padding: 24px 20px; max-width: 900px; margin: 0 auto; }
        .page-title { margin-bottom: 24px; animation: slideUp 0.5s ease; }
        .page-title h1 { font-size: 32px; margin-bottom: 6px; font-weight: 800; }
        .page-title p { color: var(--text-secondary); font-size: 15px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        .admin-panel { background: linear-gradient(135deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.05) 100%); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 20px; padding: 24px; margin-bottom: 24px; position: relative; overflow: hidden; }
        .admin-panel::before { content: '\f132'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: -20px; right: 20px; font-size: 100px; opacity: 0.05; color: var(--gold-primary); }
        .admin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; position: relative; z-index: 1; }
        @media (max-width: 768px) { .admin-grid { grid-template-columns: 1fr; } }
        .admin-btn { background: rgba(212, 175, 55, 0.15); border: 1px solid rgba(212, 175, 55, 0.3); color: var(--gold-primary); padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.3s; font-family: inherit; font-weight: 700; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .admin-btn:hover { background: rgba(212, 175, 55, 0.25); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2); }
        .next-match-card { background: linear-gradient(135deg, #e94560 0%, #c73e54 100%); border-radius: 20px; padding: 28px; margin-bottom: 24px; position: relative; overflow: hidden; box-shadow: 0 15px 50px rgba(233, 69, 96, 0.3); }
        .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .match-label { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 15px; }
        .home-badge { background: rgba(255, 255, 255, 0.2); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .match-teams { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; }
        .team { text-align: center; flex: 1; }
        .team-name { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
        .vs { font-size: 28px; font-weight: 900; opacity: 0.5; margin: 0 30px; font-style: italic; }
        .match-details { display: flex; justify-content: center; gap: 50px; padding-top: 24px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px 10px; text-align: center; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); border-color: rgba(233, 69, 96, 0.3); }
        .stat-value { font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #e94560, #f39c12); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 6px; transition: all 0.3s ease; }
        .stat-value.updated { animation: pulse 0.5s ease; transform: scale(1.2); }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .recent-form { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 24px; margin-bottom: 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); font-weight: 600; }
        .live-dot { width: 8px; height: 8px; background: #2ed573; border-radius: 50%; box-shadow: 0 0 10px #2ed573; animation: blink 2s infinite; }
        .form-list { display: flex; flex-direction: column; gap: 12px; }
        .form-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s; animation: slideUp 0.3s ease; }
        .form-item:hover { background: rgba(255, 255, 255, 0.05); transform: translateX(4px); }
        .result-w { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
        .result-l { background: rgba(233, 69, 96, 0.2); color: #e94560; }
        .result-bye { background: rgba(255, 215, 0, 0.15); color: #ffd700; border: 1px solid rgba(255, 215, 0, 0.3); }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 25px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; white-space: nowrap; font-family: inherit; }
        .filter-btn.active { background: linear-gradient(135deg, #e94560 0%, #d63d56 100%); color: white; border-color: transparent; box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3); }
        .fixture-card { background: #151520; border: 1px solid #2a2a3a; border-radius: 16px; padding: 20px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; animation: slideUp 0.3s ease; }
        .fixture-card:hover { transform: translateY(-2px); border-color: rgba(233, 69, 96, 0.3); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .fixture-card.bye-week { border-left: 3px solid #ffd700; background: rgba(255, 215, 0, 0.05); }
        .fixture-date { min-width: 60px; text-align: center; margin-right: 20px; }
        .date-day { font-size: 28px; font-weight: 900; color: #e94560; line-height: 1; }
        .date-day.bye { color: #ffd700; }
        
        .table-header { display: grid; grid-template-columns: 50px 1fr 60px 60px 60px 60px; gap: 8px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px 12px 0 0; font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; border-bottom: 1px solid var(--border-color); }
        .table-row { display: grid; grid-template-columns: 50px 1fr 60px 60px 60px 60px; gap: 8px; padding: 16px; border-bottom: 1px solid var(--border-color); align-items: center; font-size: 14px; background: var(--bg-card); animation: slideUp 0.3s ease; }
        
        .player-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; transition: all 0.3s; }
        .player-avatar { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; margin-bottom: 16px; }
        .player-role-reserve { color: var(--reserve-color); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 15, 25, 0.98); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 12px 0 20px; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #606070; text-decoration: none; font-size: 10px; font-weight: 700; padding: 8px; border-radius: 16px; flex: 1; max-width: 90px; transition: all 0.3s; cursor: pointer; background: none; border: none; font-family: inherit; }
        .nav-item.active { color: var(--primary-pink); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.3s ease; }
        .modal-header { background: linear-gradient(135deg, rgba(233,69,96,0.2) 0%, rgba(243,156,18,0.1) 100%); padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .submit-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary-pink) 0%, var(--primary-pink-dark) 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin-top: 24px; transition: all 0.3s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .score-input-container { display: flex; align-items: center; gap: 16px; justify-content: center; margin: 24px 0; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid var(--border-color); }
        .score-input { width: 80px; height: 60px; text-align: center; font-size: 32px; font-weight: 900; background: rgba(255,255,255,0.05); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--border-color); padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 12px; z-index: 2000; opacity: 0; transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        #systemCreatorModal .modal-container { max-width: 900px; border: 2px solid rgba(0, 255, 255, 0.3); background: linear-gradient(135deg, #0a0a1a 0%, #1a1020 100%); }
        #systemCreatorModal .modal-title { color: #00ffff; text-shadow: 0 0 10px rgba(0,255,255,0.5); }
        #secretOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 9999; align-items: center; justify-content: center; flex-direction: column; font-family: monospace; }
        
        .opponent-list { max-height: 300px; overflow-y: auto; margin: 16px 0; border: 1px solid rgba(0,255,255,0.2); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.3); }
        .opponent-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; }
        .opponent-item:last-child { border-bottom: none; }
        .opponent-item:hover { background: rgba(0,255,255,0.05); }
        .opponent-name { font-weight: 600; color: #fff; }
        .opponent-delete { background: rgba(255,71,87,0.2); border: 1px solid rgba(255,71,87,0.4); color: #ff4757; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .opponent-delete:hover { background: rgba(255,71,87,0.4); }
        .opponent-add-row { display: flex; gap: 8px; margin-bottom: 16px; }
        .opponent-input { flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; color: #fff; font-family: inherit; }
        .opponent-input:focus { outline: none; border-color: #00ffff; }
        .opponent-add-btn { padding: 12px 20px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; color: #00ffff; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.2s; }
        .opponent-add-btn:hover { background: rgba(0,255,255,0.2); }
        
        #dbConsole::-webkit-scrollbar { width: 8px; }
        #dbConsole::-webkit-scrollbar-track { background: rgba(0,255,255,0.05); }
        #dbConsole::-webkit-scrollbar-thumb { background: rgba(0,255,255,0.3); border-radius: 4px; }
        #dbConsole::-webkit-scrollbar-thumb:hover { background: rgba(0,255,255,0.5); }
        .opponent-list::-webkit-scrollbar { width: 6px; }
        .opponent-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .opponent-list::-webkit-scrollbar-thumb { background: rgba(0,255,255,0.3); border-radius: 3px; }
        
        .last-updated { font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 4px; font-style: italic; }
        .countdown-timer { font-size: 14px; font-weight: 700; color: #fff; background: rgba(0,0,0,0.3); padding: 4px 12px; border-radius: 20px; margin-top: 8px; display: inline-block; }
        .auto-sync-indicator { position: fixed; top: 80px; right: 20px; background: rgba(46, 213, 115, 0.9); color: #000; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; display: none; align-items: center; gap: 8px; z-index: 999; animation: slideUp 0.3s ease; }
        .auto-sync-indicator.show { display: flex; }
        .new-item-badge { background: #e94560; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 8px; animation: pulse 2s infinite; }
        
        .match-time { font-size: 12px; color: #ffd700; font-weight: 700; margin-top: 4px; }
        .fixture-time { font-size: 12px; color: var(--accent-orange); font-weight: 600; margin-top: 4px; }
        .time-badge { background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); color: #ffd700; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 8px; }
        
        .training-type-practice { color: #e94560; border-color: #e94560; }
        .training-type-drills { color: #f39c12; border-color: #f39c12; }
        .training-type-theory { color: #9b59b6; border-color: #9b59b6; }
        .training-type-team { color: #2ed573; border-color: #2ed573; }
        .training-type-fitness { color: #3498db; border-color: #3498db; }
        
        /* Attendance Styles */
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin: 16px 0; }
        .attendance-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .attendance-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(233,69,96,0.3); }
        .attendance-item.selected { background: rgba(46, 213, 115, 0.1); border-color: var(--success); }
        .attendance-item.selected .attendance-check { background: var(--success); border-color: var(--success); }
        .attendance-check { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-muted); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .attendance-check i { opacity: 0; color: white; font-size: 12px; transition: all 0.2s; }
        .attendance-item.selected .attendance-check i { opacity: 1; }
        .attendance-avatar { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, var(--accent-orange), var(--primary-pink)); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; }
        .attendance-name { font-size: 13px; font-weight: 600; }
        .attendance-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .attendance-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--accent-orange)); border-radius: 2px; transition: width 0.5s ease; }
        .attendance-stats { display: flex; gap: 16px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); }
        .attendance-stat { text-align: center; }
        .attendance-stat-value { font-size: 24px; font-weight: 800; color: var(--success); }
        .attendance-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
        .attendance-indicator { display: inline-flex; align-items: center; gap: 6px; background: rgba(46, 213, 115, 0.1); border: 1px solid rgba(46, 213, 115, 0.3); color: var(--success); padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-top: 8px; }
        .attendance-indicator.partial { background: rgba(243, 156, 18, 0.1); border-color: rgba(243, 156, 18, 0.3); color: var(--accent-orange); }
        .attendance-indicator.low { background: rgba(233, 69, 96, 0.1); border-color: rgba(233, 69, 96, 0.3); color: var(--primary-pink); }
        .attendance-avatars { display: flex; margin-left: auto; }
        .attendance-avatars .mini-avatar { width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-orange), var(--primary-pink)); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; border: 2px solid var(--bg-card); margin-left: -8px; }
        .attendance-avatars .mini-avatar:first-child { margin-left: 0; }
        .attendance-avatars .mini-avatar.more { background: var(--border-color); color: var(--text-secondary); }
        
        /* Network Status Indicator */
        .network-status { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            z-index: 9999; 
            opacity: 0; 
            transition: opacity 0.3s; 
            pointer-events: none;
        }
        .network-status.show { opacity: 1; }
        .network-status.online { background: rgba(46, 213, 115, 0.9); color: #000; }
        .network-status.offline { background: rgba(255, 71, 87, 0.9); color: #fff; }
        .network-status.syncing { background: rgba(0, 255, 255, 0.9); color: #000; }
        
        /* Conflict Resolution Dialog */
        .conflict-dialog { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.9); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000; 
            padding: 20px;
        }
        .conflict-dialog.show { display: flex; }
        .conflict-content { 
            background: var(--bg-card); 
            border: 2px solid var(--primary-pink); 
            border-radius: 16px; 
            padding: 24px; 
            max-width: 500px; 
            width: 100%;
        }
        .conflict-item { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 12px; 
            margin: 8px 0; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .conflict-item:hover { border-color: var(--primary-pink); background: rgba(233,69,96,0.1); }
        .conflict-item.selected { border-color: var(--success); background: rgba(46,213,115,0.1); }
    </style>
</head>
<body>

    <!-- Network Status Indicator -->
    <div id="networkStatus" class="network-status">
        <i class="fas fa-circle"></i>
        <span>Online</span>
    </div>

    <div id="autoSyncIndicator" class="auto-sync-indicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>Syncing data...</span>
    </div>

    <!-- Conflict Resolution Dialog -->
    <div id="conflictDialog" class="conflict-dialog">
        <div class="conflict-content">
            <h3 style="color: var(--primary-pink); margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i> Sync Conflict Detected</h3>
            <p style="margin-bottom: 16px; color: var(--text-secondary);">Data was modified on another device while you were offline. Choose which version to keep:</p>
            <div id="conflictOptions"></div>
            <button class="submit-btn" onclick="resolveConflict()" style="margin-top: 16px;">Resolve Conflict</button>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div class="modal-overlay" id="attendanceModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-clipboard-check" style="color: var(--success);"></i> Training Attendance</div>
                <button class="modal-close" onclick="closeAttendanceModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 800; font-size: 16px;" id="attendanceSessionTitle">Session Title</div>
                        <div style="color: var(--text-secondary); font-size: 13px;" id="attendanceSessionDate">Date</div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 13px;" id="attendanceSessionType">Type</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label class="form-label" style="margin: 0;">Mark Attendance</label>
                        <button onclick="toggleSelectAllAttendance()" style="background: none; border: none; color: var(--info); font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase;">Select All</button>
                    </div>
                    <div class="attendance-grid" id="attendanceGrid"></div>
                </div>
                
                <div class="attendance-stats">
                    <div class="attendance-stat">
                        <div class="attendance-stat-value" id="attendanceCount">0</div>
                        <div class="attendance-stat-label">Attending</div>
                    </div>
                    <div class="attendance-stat">
                        <div class="attendance-stat-value" id="attendanceTotal">0</div>
                        <div class="attendance-stat-label">Total Squad</div>
                    </div>
                    <div class="attendance-stat">
                        <div class="attendance-stat-value" id="attendancePercent">0%</div>
                        <div class="attendance-stat-label">Attendance</div>
                    </div>
                </div>
                
                <button type="button" class="submit-btn" onclick="saveAttendance()">
                    <i class="fas fa-save" style="margin-right: 8px;"></i> Save Attendance
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addTrainingModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-dumbbell" style="color: var(--primary-pink);"></i> Schedule Practice Session</div>
                <button class="modal-close" onclick="closeAddTrainingModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="trainingDate" style="padding-left: 16px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-input" id="trainingTime" style="padding-left: 16px;" value="19:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Session Type</label>
                    <select class="form-select" id="trainingType" style="padding-left: 16px;">
                        <option value="Practice Match">Practice Match</option>
                        <option value="Drills & Skills">Drills & Skills</option>
                        <option value="Theory & Tactics">Theory & Tactics</option>
                        <option value="Team Building">Team Building</option>
                        <option value="Fitness">Fitness Training</option>
                        <option value="Open Table">Open Table</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <div class="input-wrapper">
                        <i class="fas fa-location-dot"></i>
                        <input type="text" class="form-input" id="trainingLocation" placeholder="e.g., Rack Café - Table 3" style="padding-left: 48px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes / Focus Points</label>
                    <textarea class="form-textarea" id="trainingNotes" placeholder="What should the team focus on? e.g., Safety play, Breaking, Positional shots..."></textarea>
                </div>
                <button type="button" class="submit-btn" onclick="submitTrainingSession()">
                    <i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Schedule Session
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addResultModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-plus-circle" style="color: var(--primary-pink);"></i> Add Match Result</div>
                <button class="modal-close" onclick="closeAddResultModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Opponent</label>
                        <select class="form-select" id="resultOpponent" style="padding-left: 16px;">
                            <option value="">Select opponent...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Venue</label>
                        <select class="form-select" id="resultVenue" style="padding-left: 16px;">
                            <option value="home">Home</option>
                            <option value="away">Away</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Match Date</label>
                    <input type="date" class="form-input" id="resultDate" style="padding-left: 16px;">
                </div>
                <div class="score-input-container">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Rack Café</div>
                        <input type="number" class="score-input" id="ourScore" min="0" max="9" value="0">
                    </div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-secondary);">-</div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Opponent</div>
                        <input type="number" class="score-input" id="theirScore" min="0" max="9" value="0">
                    </div>
                </div>
                <button type="button" class="submit-btn" onclick="submitMatchResult()"><i class="fas fa-save" style="margin-right: 8px;"></i> Save Result</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="scheduleModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-calendar-plus" style="color: var(--primary-pink);"></i> Schedule Match</div>
                <button class="modal-close" onclick="closeScheduleModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Opponent</label>
                    <select class="form-select" id="scheduleOpponent" style="padding-left: 16px;">
                        <option value="">Select opponent...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="scheduleDate" style="padding-left: 16px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-input" id="scheduleTime" style="padding-left: 16px;" value="20:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Venue</label>
                    <select class="form-select" id="scheduleVenue" style="padding-left: 16px;">
                        <option value="home">Home</option>
                        <option value="away">Away</option>
                    </select>
                </div>
                <button type="button" class="submit-btn" onclick="submitSchedule()"><i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Schedule</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="updateStatsModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-chart-bar" style="color: var(--primary-pink);"></i> Update Stats</div>
                <button class="modal-close" onclick="closeUpdateStatsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="statsEditorGrid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="announcementsModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-bullhorn" style="color: var(--primary-pink);"></i> Announcements</div>
                <button class="modal-close" onclick="closeAnnouncementsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="announcementTitle" style="padding-left: 16px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" id="announcementContent"></textarea>
                </div>
                <button type="button" class="submit-btn" onclick="submitAnnouncement()">Post</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="opponentManagerModal">
        <div class="modal-container" style="max-width: 500px; border: 1px solid #00ffff;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,255,255,0.05) 100%); border-bottom: 1px solid rgba(0,255,255,0.3);">
                <div class="modal-title" style="color: #00ffff;">
                    <i class="fas fa-users"></i> Manage Opponents
                </div>
                <button class="modal-close" onclick="closeOpponentManager()" style="color: #00ffff;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="opponent-add-row">
                    <input type="text" id="newOpponentName" class="opponent-input" placeholder="Enter team name..." onkeypress="if(event.key==='Enter')addOpponent()">
                    <button class="opponent-add-btn" onclick="addOpponent()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;" id="opponentCountHeader">
                    Current Opponents (0)
                </div>
                <div class="opponent-list" id="opponentsListContainer">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">No opponents configured</div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 8px; font-size: 12px; color: #ffc107;">
                    <i class="fas fa-info-circle"></i> Note: Removing an opponent with existing fixtures will mark them as '[Removed]'.
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="roleManagerModal">
        <div class="modal-container" style="max-width: 500px; border: 1px solid #9b59b6;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(155,89,182,0.1) 0%, rgba(155,89,182,0.05) 100%); border-bottom: 1px solid rgba(155,89,182,0.3);">
                <div class="modal-title" style="color: #9b59b6;">
                    <i class="fas fa-users-cog"></i> Manage User Roles
                </div>
                <button class="modal-close" onclick="closeRoleManager()" style="color: #9b59b6;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="opponent-list" id="userRolesList"></div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 8px; font-size: 12px; color: #ffc107;">
                    <i class="fas fa-info-circle"></i> Only Captain and System Creator can access this panel.
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="systemCreatorModal">
        <div class="modal-container" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(147,0,255,0.1) 100%); border-bottom: 1px solid rgba(0,255,255,0.2); position: sticky; top: 0; z-index: 10;">
                <div class="modal-title" style="color: #00ffff;">
                    <i class="fas fa-terminal"></i> SYSTEM_CREATOR_PANEL
                    <span style="font-size: 11px; color: #ff00ff; margin-left: 10px; border: 1px solid #ff00ff; padding: 2px 8px; border-radius: 4px;">ROOT ACCESS</span>
                </div>
                <button class="modal-close" onclick="closeSystemCreatorModal()" style="color: #00ffff;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #00ffff; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; border-bottom: 1px solid rgba(0,255,255,0.2); padding-bottom: 8px;">
                        <i class="fas fa-database"></i> Data Management
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <button class="admin-btn" onclick="exportDatabase()" style="border-color: #00ffff; color: #00ffff; background: rgba(0,255,255,0.05);">
                            <i class="fas fa-file-export"></i> Export JSON
                        </button>
                        <button class="admin-btn" onclick="importDatabase()" style="border-color: #00ff00; color: #00ff00; background: rgba(0,255,0,0.05);">
                            <i class="fas fa-file-import"></i> Import JSON
                        </button>
                        <button class="admin-btn" onclick="exportCSV()" style="border-color: #ffa500; color: #ffa500; background: rgba(255,165,0,0.05);">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #ffd700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; border-bottom: 1px solid rgba(255,215,0,0.2); padding-bottom: 8px;">
                        <i class="fas fa-users-cog"></i> User Administration
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <button class="admin-btn" onclick="resetUserPassword()" style="border-color: #ffd700; color: #ffd700; background: rgba(255,215,0,0.05);">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                        <button class="admin-btn" onclick="toggleAdminRights()" style="border-color: #ff00ff; color: #ff00ff; background: rgba(255,0,255,0.05);">
                            <i class="fas fa-user-shield"></i> Toggle Admin
                        </button>
                        <button class="admin-btn" onclick="addNewUser()" style="border-color: #2ed573; color: #2ed573; background: rgba(46,213,115,0.05);">
                            <i class="fas fa-user-plus"></i> Add New User
                        </button>
                        <button class="admin-btn" onclick="removeUser()" style="border-color: #ff4757; color: #ff4757; background: rgba(255,71,87,0.05);">
                            <i class="fas fa-user-minus"></i> Remove User
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #00ced1; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; border-bottom: 1px solid rgba(0,206,209,0.2); padding-bottom: 8px;">
                        <i class="fas fa-tools"></i> System Tools
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <button class="admin-btn" onclick="seedTestData()" style="border-color: #ffa500; color: #ffa500; background: rgba(255,165,0,0.05);">
                            <i class="fas fa-flask"></i> Seed Test Data
                        </button>
                        <button class="admin-btn" onclick="recalculateStats()" style="border-color: #00ced1; color: #00ced1; background: rgba(0,206,209,0.05);">
                            <i class="fas fa-calculator"></i> Recalc Stats
                        </button>
                        <button class="admin-btn" onclick="verifyIntegrity()" style="border-color: #9370db; color: #9370db; background: rgba(147,112,219,0.05);">
                            <i class="fas fa-check-double"></i> Verify Data
                        </button>
                        <button class="admin-btn" onclick="archiveSeason()" style="border-color: #ff6b6b; color: #ff6b6b; background: rgba(255,107,107,0.05);">
                            <i class="fas fa-archive"></i> Archive Season
                        </button>
                        <button class="admin-btn" onclick="clearFixturesOnly()" style="border-color: #ff4757; color: #ff4757; background: rgba(255,71,87,0.05);">
                            <i class="fas fa-trash"></i> Clear Fixtures
                        </button>
                        <button class="admin-btn" onclick="clearStatsOnly()" style="border-color: #ff6348; color: #ff6348; background: rgba(255,99,72,0.05);">
                            <i class="fas fa-eraser"></i> Zero Stats
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #2ed573; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; border-bottom: 1px solid rgba(46,213,115,0.2); padding-bottom: 8px;">
                        <i class="fas fa-cogs"></i> Configuration
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <button class="admin-btn" onclick="updateTeamConfig()" style="border-color: #2ed573; color: #2ed573; background: rgba(46,213,115,0.05);">
                            <i class="fas fa-edit"></i> Edit Team Info
                        </button>
                        <button class="admin-btn" onclick="openOpponentManager()" style="border-color: #00ffff; color: #00ffff; background: rgba(0,255,255,0.05);">
                            <i class="fas fa-users"></i> Manage Opponents
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #ff4757; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; border-bottom: 1px solid rgba(255,71,87,0.2); padding-bottom: 8px;">
                        <i class="fas fa-radiation"></i> Danger Zone
                    </div>
                    <button class="admin-btn" onclick="nukeDatabase()" style="border-color: #ff0000; color: #ff0000; background: rgba(255,0,0,0.1); width: 100%; border-width: 2px;">
                        <i class="fas fa-bomb"></i> NUKE ENTIRE DATABASE
                    </button>
                </div>
                <div style="background: rgba(0,0,0,0.8); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; color: #00ffff; font-size: 12px; height: 200px; overflow-y: auto;" id="dbConsole">
                    <div style="color: #00ff00;">> System Creator v2.0 initialized...</div>
                    <div style="color: #00ff00;">> Root access granted...</div>
                    <div style="color: #00ffff;">> Awaiting command...</div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button onclick="viewAuditLog()" style="flex: 1; padding: 8px; background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); color: #00ffff; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-history"></i> View Audit Log
                    </button>
                    <button onclick="clearConsole()" style="flex: 1; padding: 8px; background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #ff4757; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-trash"></i> Clear Console
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="secretOverlay">
        <div style="color: #00ffff; font-size: 48px; margin-bottom: 20px;"><i class="fas fa-fingerprint"></i></div>
        <div style="color: #fff; font-size: 24px;">SYSTEM CREATOR ACCESS</div>
        <div style="width: 300px; height: 4px; background: #333; margin-top: 30px; border-radius: 2px; overflow: hidden;">
            <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #00ffff, #ff00ff); animation: hackProgress 2s ease forwards;"></div>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Success</span></div>

    <div class="login-screen" id="loginScreen">
        <div class="logo" id="loginLogo"></div>
        <div class="login-card">
            <div class="login-header"><h1>Rack Café Utd</h1><p>Huddersfield Tuesday Night Pool League</p></div>
            <div class="login-error" id="loginError"><i class="fas fa-exclamation-circle"></i><span id="errorText">Invalid credentials</span></div>
            <form onsubmit="event.preventDefault(); doLogin();">
                <div class="form-group"><label class="form-label">Username</label><div class="input-wrapper"><i class="fas fa-user"></i><input type="text" class="form-input" id="usernameInput" required></div></div>
                <div class="form-group"><label class="form-label">Password</label><div class="input-wrapper"><i class="fas fa-lock"></i><input type="password" class="form-input" id="passwordInput" required></div></div>
                <button type="submit" class="login-btn" id="loginBtn"><i class="fas fa-arrow-right-to-bracket"></i> LOGIN</button>
            </form>
            <div style="text-align: center; margin-top: 16px; font-size: 11px; color: var(--text-muted);">
                <i class="fas fa-wifi"></i> <span id="connectionStatus">Checking connection...</span>
            </div>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <header class="header">
            <div class="header-left">
                <div class="header-logo"></div>
                <div class="header-title"><h2>Rack Café Utd</h2><p>Huddersfield Tuesday Night Pool League</p></div>
            </div>
            <div class="header-right">
                <div class="sync-badge" id="syncBadge" onclick="manualSync()"><i class="fas fa-check-circle"></i><span id="syncStatus">Synced</span></div>
                <div class="profile-container">
                    <div class="avatar" id="userAvatar" onclick="toggleDropdown(event)">--</div>
                    <div class="dropdown-menu" id="profileDropdown">
                        <div class="user-info"><div class="user-name" id="dropdownUserName">User</div><div class="user-role" id="dropdownUserRole">Player</div></div>
                        <div class="dropdown-item" onclick="switchTab('profileTab', document.querySelectorAll('.nav-item')[5]); toggleDropdown();"><i class="fas fa-user"></i><span>My Profile</span></div>
                        <div id="adminMenuItems" style="display: none;">
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item admin-only" onclick="openAdminPanel(); toggleDropdown();"><i class="fas fa-shield-alt"></i><span>Captain's Panel</span></div>
                        </div>
                        <div id="systemCreatorMenuItem" style="display: none;">
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item system-creator" onclick="openSystemCreatorModal(); toggleDropdown();"><i class="fas fa-terminal"></i><span>System Creator</span></div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Log Out</span></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="tab-content active" id="homeTab">
                <div class="page-title"><h1>Dashboard</h1><p id="welcomeText">Welcome back!</p></div>
                <div id="nextMatchCard" class="next-match-card">
                    <div class="match-header">
                        <div class="match-label"><i class="fas fa-calendar-check"></i> Next Match</div>
                        <span class="home-badge" id="nextMatchVenue">Home</span>
                    </div>
                    <div class="match-teams">
                        <div class="team"><div class="team-name">Rack Café Utd</div></div>
                        <div class="vs">VS</div>
                        <div class="team"><div class="team-name" id="nextMatchOpponent">TBD</div></div>
                    </div>
                    <div class="match-details" id="nextMatchDetails">
                        <div style="text-align: center;">
                            <i class="fas fa-calendar" style="font-size: 24px; margin-bottom: 8px; opacity: 0.8;"></i>
                            <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Date</div>
                            <div style="font-weight: 700; margin-top: 4px;" id="nextMatchDate">TBC</div>
                        </div>
                        <div style="text-align: center;">
                            <i class="fas fa-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.8;"></i>
                            <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Kickoff</div>
                            <div style="font-weight: 700; margin-top: 4px; color: #ffd700;" id="nextMatchTime">--:--</div>
                        </div>
                    </div>
                    <div id="countdownContainer" style="text-align: center; margin-top: 16px; display: none;">
                        <div class="countdown-timer" id="countdownTimer">Starting soon...</div>
                    </div>
                    <div class="last-updated" id="lastUpdated">Last updated: Just now</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="statPosition">--</div><div class="stat-label">Position</div></div>
                    <div class="stat-card"><div class="stat-value" id="statPlayed">0</div><div class="stat-label">Played</div></div>
                    <div class="stat-card"><div class="stat-value" id="statWon">0</div><div class="stat-label">Won</div></div>
                    <div class="stat-card"><div class="stat-value" id="statWinRate">0%</div><div class="stat-label">Win Rate</div></div>
                </div>
                <div class="recent-form">
                    <div class="section-header">
                        <div class="section-title"><i class="fas fa-chart-line"></i> Recent Form <span id="newResultBadge" class="new-item-badge" style="display: none;">NEW</span></div>
                        <div class="live-indicator"><div class="live-dot"></div><span>Live</span></div>
                    </div>
                    <div id="recentFormList" class="form-list"><div class="form-item" style="justify-content: center; color: var(--text-muted);">No matches yet</div></div>
                    <div class="last-updated" id="formLastUpdated" style="margin-top: 12px; text-align: right;"></div>
                </div>
            </div>

            <div class="tab-content" id="fixturesTab">
                <div class="page-title"><h1>Fixtures</h1><p id="fixtureSeasonText">2025/26 Season</p></div>
                <div class="filter-tabs">
                    <button class="filter-btn active" onclick="filterFixtures('all', this)">All</button>
                    <button class="filter-btn" onclick="filterFixtures('upcoming', this)">Upcoming</button>
                    <button class="filter-btn" onclick="filterFixtures('played', this)">Results</button>
                </div>
                <div id="fixturesList"></div>
                <div class="last-updated" id="fixturesLastUpdated" style="text-align: center; margin-top: 16px;"></div>
            </div>

            <div class="tab-content" id="tableTab">
                <div class="page-title"><h1>League Table</h1><p>Tuesday Night Pool League</p></div>
                <div class="table-header">
                    <div>Pos</div>
                    <div>Team</div>
                    <div style="text-align: center;">P</div>
                    <div style="text-align: center;">W</div>
                    <div style="text-align: center;">L</div>
                    <div style="text-align: right;">Pts</div>
                </div>
                <div id="leagueTableBody"></div>
                <div class="last-updated" id="tableLastUpdated" style="text-align: center; margin-top: 16px;"></div>
            </div>

            <div class="tab-content" id="teamTab">
                <div class="page-title"><h1>Team</h1><p>Squad Statistics & Training Attendance</p></div>
                <div id="playersGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;"></div>
                <div class="last-updated" id="teamLastUpdated" style="text-align: center; margin-top: 16px;"></div>
            </div>

            <div class="tab-content" id="trainingTab">
                <div class="page-title"><h1>Training & Practice</h1><p>Squad Development Sessions</p></div>
                <div id="adminTrainingPanel" style="display: none;">
                    <div class="admin-panel">
                        <div class="section-title" style="color: var(--gold-primary); margin-bottom: 8px;">
                            <i class="fas fa-dumbbell"></i> Training Management
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">Schedule practice sessions and track attendance</p>
                        <button class="admin-btn" onclick="openAddTrainingModal()">
                            <i class="fas fa-plus-circle"></i> Schedule Practice Session
                        </button>
                    </div>
                </div>
                
                <!-- Training Stats Summary -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTrainingSessions">0</div>
                        <div class="stat-label">Total Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAttendanceRate">0%</div>
                        <div class="stat-label">Avg Attendance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="topAttendee">--</div>
                        <div class="stat-label">Top Attendee</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessionsThisMonth">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>
                
                <div class="filter-tabs">
                    <button class="filter-btn active" onclick="filterTraining('upcoming', this)">Upcoming</button>
                    <button class="filter-btn" onclick="filterTraining('past', this)">History</button>
                    <button class="filter-btn" onclick="filterTraining('all', this)">All</button>
                </div>
                <div id="trainingList"></div>
                <div class="last-updated" id="trainingLastUpdated" style="text-align: center; margin-top: 16px;"></div>
            </div>

            <div class="tab-content" id="profileTab">
                <div class="page-title"><h1>Profile</h1><p>Account Settings & Stats</p></div>
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 16px;">
                    <div id="profileAvatar" style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-orange), var(--primary-pink)); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 800;">--</div>
                    <div id="profileDisplayName" style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">User</div>
                    <div id="profileRoleText" style="color: var(--text-secondary); font-size: 14px;">Player</div>
                </div>
                
                <!-- Personal Training Stats -->
                <div class="recent-form">
                    <div class="section-title" style="margin-bottom: 16px;"><i class="fas fa-chart-pie"></i> Your Training Stats</div>
                    <div id="personalTrainingStats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                        <div>
                            <div class="stat-value" id="personalSessionsAttended" style="font-size: 28px;">0</div>
                            <div class="stat-label">Sessions Attended</div>
                        </div>
                        <div>
                            <div class="stat-value" id="personalAttendanceRate" style="font-size: 28px;">0%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                        <div>
                            <div class="stat-value" id="personalStreak" style="font-size: 28px;">0</div>
                            <div class="stat-label">Current Streak</div>
                        </div>
                    </div>
                    <div class="attendance-bar" style="margin-top: 20px;">
                        <div class="attendance-fill" id="personalAttendanceBar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="adminTab">
                <div class="page-title"><h1>Captain's Panel</h1><p>Team Administration</p></div>
                <div class="admin-panel">
                    <div class="section-title" style="color: var(--gold-primary); margin-bottom: 8px;"><i class="fas fa-shield-alt"></i> Quick Actions</div>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">Manage fixtures, results, and team administration</p>
                    <div class="admin-grid">
                        <button class="admin-btn" onclick="openAddResultModal()"><i class="fas fa-plus-circle"></i> Add Result</button>
                        <button class="admin-btn" onclick="openScheduleModal()"><i class="fas fa-calendar-plus"></i> Schedule</button>
                        <button class="admin-btn" onclick="openUpdateStatsModal()"><i class="fas fa-chart-bar"></i> Edit Stats</button>
                        <button class="admin-btn" onclick="openAnnouncementsModal()"><i class="fas fa-bullhorn"></i> Announce</button>
                        <button class="admin-btn" id="manageRolesBtn" onclick="openRoleManager()" style="display: none; border-color: #9b59b6; color: #9b59b6; background: rgba(155,89,182,0.05);">
                            <i class="fas fa-users-cog"></i> Manage Roles
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('homeTab', this)"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-item" onclick="switchTab('fixturesTab', this)"><i class="fas fa-calendar-days"></i><span>Fixtures</span></button>
            <button class="nav-item" onclick="switchTab('tableTab', this)"><i class="fas fa-table"></i><span>Table</span></button>
            <button class="nav-item" onclick="switchTab('teamTab', this)"><i class="fas fa-users"></i><span>Team</span></button>
            <button class="nav-item" onclick="switchTab('trainingTab', this)"><i class="fas fa-dumbbell"></i><span>Training</span></button>
            <button class="nav-item" onclick="switchTab('profileTab', this)"><i class="fas fa-user"></i><span>Profile</span></button>
        </nav>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        // Replace with your Firebase config from Firebase Console
       const firebaseConfig = {
  apiKey: "AIzaSyAYQy0hTbsTkAg8_vqnvRVsXDxg_yg2DVY",
  authDomain: "rack-cafe-united-app.firebaseapp.com",
  projectId: "rack-cafe-united-app",
  storageBucket: "rack-cafe-united-app.firebasestorage.app",
  messagingSenderId: "754292454573",
  appId: "1:754292454573:web:188ec818666c77a3ef8224"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence({synchronizeTabs: true})
            .then(() => console.log("Offline persistence enabled"))
            .catch(err => {
                if (err.code == 'failed-precondition') {
                    console.log("Multiple tabs open, persistence can only be enabled in one tab at a time.");
                } else if (err.code == 'unimplemented') {
                    console.log("Browser doesn't support offline persistence");
                }
            });

        const STORAGE_KEY = 'rackCafeData_v2';
        const LAST_SYNC_KEY = 'rackCafeLastSync';
        const DEVICE_ID = 'device_' + Math.random().toString(36).substr(2, 9);
        
        const teamCredentials = {
            'BDannatt': { password: 'HTAFC26', name: 'Brandon Dannatt', role: 'Captain', isAdmin: true, initials: 'BD' },
            'THayes-Smith': { password: '071122Mia', name: 'Tom Hayes-Smith', role: 'System Creator + Co-Captain', isAdmin: true, initials: 'THS', isSystemCreator: true },
            'CShearon': { password: 'Rack2026', name: 'Chris Shearon', role: 'Co-Captain', isAdmin: true, initials: 'CS' },
            'JReserve': { password: 'Reserve01', name: 'John Reserve', role: 'Reserve', isAdmin: false, initials: 'JR' }
        };

        let teamData = [
            { id: 1, name: 'Brandon Dannatt', initials: 'BD', role: 'Captain', played: 0, won: 0, lost: 0, winRate: 0, trainingAttended: 0 },
            { id: 2, name: 'Tom Hayes-Smith', initials: 'THS', role: 'System Creator + Co-Captain', played: 0, won: 0, lost: 0, winRate: 0, trainingAttended: 0 },
            { id: 3, name: 'Chris Shearon', initials: 'CS', role: 'Co-Captain', played: 0, won: 0, lost: 0, winRate: 0, trainingAttended: 0 },
            { id: 4, name: 'John Reserve', initials: 'JR', role: 'Reserve', played: 0, won: 0, lost: 0, winRate: 0, trainingAttended: 0 }
        ];

        let opponentsList = [
            'Ashfield Massive',
            'Carlton Club', 
            'Longwood BC Wednesday',
            'Monkey Club',
            'BYE'
        ];

        let leagueData = [
            { id: 1, name: 'Rack Café Utd', played: 0, won: 0, lost: 0, points: 0, isUs: true }
        ];

        let fixturesData = [];
        let announcements = [];
        let trainingSessions = [];
        let currentUser = null;
        let currentFilter = 'all';
        let currentTrainingFilter = 'upcoming';
        let autoSyncInterval = null;
        let countdownInterval = null;
        let lastDataHash = '';
        let currentEditingSessionId = null;
        let isOnline = navigator.onLine;
        let unsubscribeFirestore = null;
        let pendingChanges = false;

        // ==================== NETWORK STATUS ====================
        function updateNetworkStatus(online) {
            isOnline = online;
            const statusEl = document.getElementById('connectionStatus');
            const syncBadge = document.getElementById('syncBadge');
            
            if (statusEl) {
                statusEl.textContent = online ? 'Connected to cloud' : 'Offline mode';
                statusEl.style.color = online ? 'var(--success)' : '#ffc107';
            }
            
            if (syncBadge) {
                if (!online) {
                    syncBadge.classList.add('offline');
                    syncBadge.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
                } else {
                    syncBadge.classList.remove('offline');
                    syncBadge.innerHTML = '<i class="fas fa-check-circle"></i><span>Synced</span>';
                }
            }
            
            showNetworkToast(online ? 'online' : 'offline');
        }

        window.addEventListener('online', () => updateNetworkStatus(true));
        window.addEventListener('offline', () => updateNetworkStatus(false));

        function showNetworkToast(status) {
            const toast = document.getElementById('networkStatus');
            const icon = toast.querySelector('i');
            const text = toast.querySelector('span');
            
            toast.className = `network-status show ${status}`;
            
            if (status === 'online') {
                icon.className = 'fas fa-wifi';
                text.textContent = 'Back Online - Syncing...';
                setTimeout(() => {
                    syncToFirestore();
                }, 1000);
            } else if (status === 'offline') {
                icon.className = 'fas fa-wifi-slash';
                text.textContent = 'Offline Mode - Changes saved locally';
            } else if (status === 'syncing') {
                icon.className = 'fas fa-sync fa-spin';
                text.textContent = 'Syncing to cloud...';
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==================== FIRESTORE SYNC ====================
        function subscribeToFirestore() {
            if (unsubscribeFirestore) unsubscribeFirestore();
            
            unsubscribeFirestore = db.collection('rackCafe').doc('main')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data && data.lastDevice !== DEVICE_ID) {
                            // Data changed from another device
                            showAutoSyncIndicator();
                            loadFromFirestoreData(data);
                            showToast('Data synced from cloud');
                        }
                    }
                }, err => {
                    console.error("Firestore subscription error:", err);
                });
        }

        async function syncToFirestore() {
            if (!isOnline) return;
            
            showNetworkToast('syncing');
            document.getElementById('syncBadge').classList.add('syncing');
            document.getElementById('syncStatus').textContent = 'Syncing...';
            
            try {
                const data = {
                    teamData,
                    leagueData,
                    fixturesData,
                    announcements,
                    opponentsList,
                    trainingSessions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    lastDevice: DEVICE_ID,
                    version: '2.1'
                };
                
                await db.collection('rackCafe').doc('main').set(data);
                pendingChanges = false;
                
                document.getElementById('syncBadge').classList.remove('syncing');
                document.getElementById('syncStatus').textContent = 'Synced';
            } catch (error) {
                console.error("Sync error:", error);
                showToast('Sync failed - changes saved locally', 'error');
            }
        }

        function loadFromFirestoreData(data) {
            if (data.teamData) teamData = data.teamData.map(p => ({...p, trainingAttended: p.trainingAttended || 0}));
            if (data.leagueData) leagueData = data.leagueData;
            if (data.fixturesData) fixturesData = data.fixturesData;
            if (data.announcements) announcements = data.announcements;
            if (data.opponentsList) opponentsList = data.opponentsList;
            if (data.trainingSessions) trainingSessions = data.trainingSessions.map(s => ({...s, attendance: s.attendance || []}));
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updateAllDisplays();
        }

        // ==================== DATA PERSISTENCE ====================
        function getDataHash() {
            return JSON.stringify({ fixturesData, leagueData, teamData, opponentsList, trainingSessions }).length.toString(36);
        }

        async function persistData() {
            const data = {
                teamData,
                leagueData,
                fixturesData,
                announcements,
                opponentsList,
                trainingSessions,
                timestamp: new Date().toISOString(),
                version: '2.1'
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            localStorage.setItem(LAST_SYNC_KEY, new Date().toISOString());
            lastDataHash = getDataHash();
            pendingChanges = true;
            updateLastUpdatedTimes();
            
            // Auto sync to Firebase if online
            if (isOnline) {
                await syncToFirestore();
            }
        }

        function loadPersistedData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.teamData) teamData = data.teamData.map(p => ({...p, trainingAttended: p.trainingAttended || 0}));
                    if (data.leagueData) leagueData = data.leagueData;
                    if (data.fixturesData) fixturesData = data.fixturesData;
                    if (data.announcements) announcements = data.announcements;
                    if (data.opponentsList) opponentsList = data.opponentsList;
                    if (data.trainingSessions) trainingSessions = data.trainingSessions.map(s => ({...s, attendance: s.attendance || []}));
                    lastDataHash = getDataHash();
                    return true;
                }
            } catch (e) {
                console.error('Failed to load data', e);
            }
            return false;
        }

        function initAutoSync() {
            // Check for external changes
            autoSyncInterval = setInterval(() => {
                const currentHash = getDataHash();
                if (currentHash !== lastDataHash && !pendingChanges) {
                    persistData();
                }
            }, 3000);
            
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                updateNextMatchCountdown();
            }, 1000);
            
            // Subscribe to Firestore changes
            subscribeToFirestore();
            
            // Listen for localStorage changes (from other tabs)
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    showAutoSyncIndicator();
                    loadPersistedData();
                    updateAllDisplays();
                    showToast('Data synced from another tab');
                }
            });
        }

        function showAutoSyncIndicator() {
            const indicator = document.getElementById('autoSyncIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        async function manualSync() {
            if (!isOnline) {
                showToast('Cannot sync - you are offline', 'error');
                return;
            }
            
            await syncToFirestore();
            showToast('Manual sync completed');
        }

        // ==================== EXISTING FUNCTIONS ====================
        // (All existing functions remain unchanged below this point)
        
        function updateLastUpdatedTimes() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const elements = ['lastUpdated', 'fixturesLastUpdated', 'tableLastUpdated', 'teamLastUpdated', 'formLastUpdated', 'trainingLastUpdated'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = `Last updated: ${timeString}`;
            });
        }

        function updateNextMatchCountdown() {
            const upcoming = fixturesData.filter(f => !f.played).sort((a,b) => {
                const dateA = new Date(a.date + 'T' + (a.time || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.time || '00:00'));
                return dateA - dateB;
            })[0];
            
            const container = document.getElementById('countdownContainer');
            const timer = document.getElementById('countdownTimer');
            
            if (!container || !timer) return;
            
            if (upcoming && upcoming.date) {
                const matchDateTime = new Date(upcoming.date + 'T' + (upcoming.time || '20:00'));
                const now = new Date();
                const diff = matchDateTime - now;
                
                if (diff > 0) {
                    container.style.display = 'block';
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    if (days > 0) {
                        timer.textContent = `${days}d ${hours}h ${minutes}m until match`;
                    } else {
                        timer.textContent = `${hours}h ${minutes}m ${seconds}s until kickoff`;
                    }
                } else {
                    timer.textContent = 'Match day!';
                }
            } else if (container) {
                container.style.display = 'none';
            }
        }

        let konamiCode = [];
        const secretCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
        let clickCount = 0;

        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.key);
            konamiCode = konamiCode.slice(-10);
            if (konamiCode.join(',') === secretCode.join(',')) {
                if (currentUser && currentUser.isSystemCreator) activateSystemCreator();
                else showToast('System Creator access required', 'error');
            }
            if (e.shiftKey && e.key === '~') {
                e.preventDefault();
                if (currentUser && currentUser.isSystemCreator) activateSystemCreator();
            }
        });

        document.getElementById('loginLogo').addEventListener('click', function() {
            clickCount++;
            if (clickCount === 3) {
                if (currentUser && currentUser.isSystemCreator) activateSystemCreator();
                clickCount = 0;
            }
            setTimeout(() => clickCount = 0, 1000);
        });

        function activateSystemCreator() {
            const overlay = document.getElementById('secretOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.display = 'none';
                openSystemCreatorModal();
            }, 2000);
        }

        function initializeLeagueData() {
            leagueData = leagueData.filter(t => t.isUs);
            if (leagueData.length === 0) {
                leagueData = [{ id: 1, name: 'Rack Café Utd', played: 0, won: 0, lost: 0, points: 0, isUs: true }];
            }
            
            opponentsList.forEach((opp, index) => {
                if (opp !== 'BYE' && !leagueData.find(t => t.name === opp)) {
                    leagueData.push({
                        id: index + 2,
                        name: opp,
                        played: 0,
                        won: 0,
                        lost: 0,
                        points: 0,
                        isUs: false
                    });
                }
            });
        }

        function doLogin() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const userData = teamCredentials[username];
            
            if (!userData || userData.password !== password) {
                document.getElementById('loginError').classList.add('show');
                return;
            }
            
            currentUser = { username, ...userData };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            document.getElementById('userAvatar').textContent = userData.initials;
            document.getElementById('dropdownUserName').textContent = userData.name;
            
            // Apply Reserve styling if needed
            const roleEl = document.getElementById('dropdownUserRole');
            roleEl.textContent = userData.role;
            if (userData.role === 'Reserve') {
                roleEl.classList.add('reserve');
            } else {
                roleEl.classList.remove('reserve');
            }
            
            document.getElementById('welcomeText').textContent = `Welcome back, ${userData.name.split(' ')[0]}!`;
            
            document.getElementById('profileAvatar').textContent = userData.initials;
            document.getElementById('profileDisplayName').textContent = userData.name;
            
            const profileRoleEl = document.getElementById('profileRoleText');
            profileRoleEl.textContent = userData.role;
            if (userData.role === 'Reserve') {
                profileRoleEl.style.color = 'var(--reserve-color)';
            }
            
            if (userData.isAdmin) document.getElementById('adminMenuItems').style.display = 'block';
            if (userData.isSystemCreator) document.getElementById('systemCreatorMenuItem').style.display = 'block';
            
            if (!loadPersistedData()) {
                initializeLeagueData();
            }
            
            updateOpponentDropdowns();
            updateAdminPanelVisibility();
            initAutoSync();
            updateAllDisplays();
            updatePersonalTrainingStats();
            
            // Initial sync
            if (isOnline) {
                syncToFirestore();
            }
        }

        function logout() {
            if(confirm('Logout?')) {
                if (autoSyncInterval) clearInterval(autoSyncInterval);
                if (countdownInterval) clearInterval(countdownInterval);
                if (unsubscribeFirestore) unsubscribeFirestore();
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('usernameInput').value = '';
                document.getElementById('passwordInput').value = '';
                currentUser = null;
                document.getElementById('adminMenuItems').style.display = 'none';
                document.getElementById('systemCreatorMenuItem').style.display = 'none';
                switchTab('homeTab', document.querySelectorAll('.nav-item')[0]);
            }
        }

        function switchTab(tabId, navElement) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (navElement) navElement.classList.add('active');
            
            if (tabId === 'adminTab') {
                updateAdminPanelVisibility();
            } else if (tabId === 'trainingTab') {
                const adminPanel = document.getElementById('adminTrainingPanel');
                if (adminPanel) {
                    adminPanel.style.display = (currentUser && currentUser.isAdmin) ? 'block' : 'none';
                }
                updateTrainingStats();
                renderTraining();
            } else if (tabId === 'profileTab') {
                updatePersonalTrainingStats();
            } else if (tabId === 'teamTab') {
                renderPlayersWithTraining();
            }
        }

        function openAdminPanel() {
            switchTab('adminTab', null);
        }

        function updateOpponentDropdowns() {
            const resultSelect = document.getElementById('resultOpponent');
            const scheduleSelect = document.getElementById('scheduleOpponent');
            
            if (resultSelect) {
                resultSelect.innerHTML = '<option value="">Select opponent...</option>';
                opponentsList.forEach(opp => {
                    const option = document.createElement('option');
                    option.value = opp;
                    option.textContent = opp;
                    resultSelect.appendChild(option);
                });
            }
            
            if (scheduleSelect) {
                scheduleSelect.innerHTML = '<option value="">Select opponent...</option>';
                opponentsList.forEach(opp => {
                    const option = document.createElement('option');
                    option.value = opp;
                    option.textContent = opp;
                    scheduleSelect.appendChild(option);
                });
            }
        }

        function toggleDropdown(e) {
            if (e) e.stopPropagation();
            document.getElementById('profileDropdown').classList.toggle('show');
            document.getElementById('userAvatar').classList.toggle('active');
        }

        document.addEventListener('click', function(e) {
            const profileContainer = document.querySelector('.profile-container');
            if (profileContainer && !profileContainer.contains(e.target)) {
                document.getElementById('profileDropdown').classList.remove('show');
                document.getElementById('userAvatar').classList.remove('active');
            }
        });

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const color = type === 'success' ? '#2ed573' : '#ff4757';
            
            t.className = `toast show`;
            t.innerHTML = `<i class="fas ${icon}" style="color: ${color};"></i><span>${msg}</span>`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function openAddResultModal() { 
            document.getElementById('addResultModal').classList.add('show'); 
            document.getElementById('resultDate').valueAsDate = new Date(); 
        }
        function closeAddResultModal() { document.getElementById('addResultModal').classList.remove('show'); }
        
        function openScheduleModal() { 
            document.getElementById('scheduleModal').classList.add('show'); 
            document.getElementById('scheduleDate').valueAsDate = new Date();
            document.getElementById('scheduleTime').value = '20:00';
        }
        function closeScheduleModal() { document.getElementById('scheduleModal').classList.remove('show'); }
        
        function openUpdateStatsModal() { 
            document.getElementById('updateStatsModal').classList.add('show'); 
            document.getElementById('statsEditorGrid').innerHTML = teamData.map(p => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <span>${p.name}</span>
                    <input type="number" value="${p.won}" onchange="updatePlayerStat(${p.id}, 'won', this.value)" style="width: 60px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); color: white; padding: 8px; border-radius: 6px;">
                </div>
            `).join('');
        }
        function closeUpdateStatsModal() { document.getElementById('updateStatsModal').classList.remove('show'); }
        
        function openAnnouncementsModal() { document.getElementById('announcementsModal').classList.add('show'); }
        function closeAnnouncementsModal() { document.getElementById('announcementsModal').classList.remove('show'); }
        
        function openSystemCreatorModal() { document.getElementById('systemCreatorModal').classList.add('show'); }
        function closeSystemCreatorModal() { document.getElementById('systemCreatorModal').classList.remove('show'); }

        function openAddTrainingModal() {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Only Captains can schedule training', 'error');
                return;
            }
            document.getElementById('addTrainingModal').classList.add('show');
            document.getElementById('trainingDate').valueAsDate = new Date();
            document.getElementById('trainingTime').value = '19:00';
            document.getElementById('trainingLocation').value = '';
            document.getElementById('trainingNotes').value = '';
            document.getElementById('trainingType').value = 'Practice Match';
        }

        function closeAddTrainingModal() {
            document.getElementById('addTrainingModal').classList.remove('show');
        }

        // Attendance Functions
        function openAttendanceModal(sessionId) {
            if (!currentUser || !currentUser.isAdmin) {
                showToast('Only Captains can mark attendance', 'error');
                return;
            }
            
            currentEditingSessionId = sessionId;
            const session = trainingSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            document.getElementById('attendanceSessionTitle').textContent = session.type;
            document.getElementById('attendanceSessionDate').textContent = new Date(session.date).toLocaleDateString();
            document.getElementById('attendanceSessionType').textContent = session.location + (session.time ? ` • ${session.time}` : '');
            
            renderAttendanceGrid(session);
            updateAttendanceStats();
            
            document.getElementById('attendanceModal').classList.add('show');
        }

        function closeAttendanceModal() {
            document.getElementById('attendanceModal').classList.remove('show');
            currentEditingSessionId = null;
        }

        function renderAttendanceGrid(session) {
            const grid = document.getElementById('attendanceGrid');
            const attendance = session.attendance || [];
            
            grid.innerHTML = teamData.map(player => {
                const isSelected = attendance.includes(player.id);
                return `
                    <div class="attendance-item ${isSelected ? 'selected' : ''}" onclick="togglePlayerAttendance(${player.id})">
                        <div class="attendance-check"><i class="fas fa-check"></i></div>
                        <div class="attendance-avatar">${player.initials}</div>
                        <div class="attendance-name">${player.name.split(' ')[0]}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('attendanceTotal').textContent = teamData.length;
        }

        function togglePlayerAttendance(playerId) {
            const items = document.querySelectorAll('.attendance-item');
            const index = teamData.findIndex(p => p.id === playerId);
            if (items[index]) {
                items[index].classList.toggle('selected');
                updateAttendanceStats();
            }
        }

        function toggleSelectAllAttendance() {
            const items = document.querySelectorAll('.attendance-item');
            const allSelected = Array.from(items).every(item => item.classList.contains('selected'));
            
            items.forEach(item => {
                if (allSelected) {
                    item.classList.remove('selected');
                } else {
                    item.classList.add('selected');
                }
            });
            updateAttendanceStats();
        }

        function updateAttendanceStats() {
            const selectedCount = document.querySelectorAll('.attendance-item.selected').length;
            const total = teamData.length;
            const percent = total > 0 ? Math.round((selectedCount / total) * 100) : 0;
            
            document.getElementById('attendanceCount').textContent = selectedCount;
            document.getElementById('attendancePercent').textContent = percent + '%';
        }

        async function saveAttendance() {
            const session = trainingSessions.find(s => s.id === currentEditingSessionId);
            if (!session) return;
            
            const selectedIds = [];
            const items = document.querySelectorAll('.attendance-item');
            
            items.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    selectedIds.push(teamData[index].id);
                }
            });
            
            session.attendance = selectedIds;
            
            // Update player training stats
            teamData.forEach(player => {
                const attended = trainingSessions.filter(s => s.attendance && s.attendance.includes(player.id)).length;
                player.trainingAttended = attended;
            });
            
            await persistData();
            closeAttendanceModal();
            renderTraining();
            showToast(`Attendance saved: ${selectedIds.length}/${teamData.length} players`);
        }

        function updateTrainingStats() {
            const now = new Date();
            const pastSessions = trainingSessions.filter(s => new Date(s.date + 'T' + (s.time || '23:59')) < now);
            const totalSessions = pastSessions.length;
            
            document.getElementById('totalTrainingSessions').textContent = trainingSessions.length;
            document.getElementById('sessionsThisMonth').textContent = trainingSessions.filter(s => {
                const date = new Date(s.date);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            
            let totalAttendance = 0;
            pastSessions.forEach(session => {
                totalAttendance += (session.attendance || []).length;
            });
            
            const avgRate = totalSessions > 0 ? Math.round((totalAttendance / (totalSessions * teamData.length)) * 100) : 0;
            document.getElementById('avgAttendanceRate').textContent = avgRate + '%';
            
            // Find top attendee
            let maxAttended = 0;
            let topPlayer = '--';
            teamData.forEach(player => {
                const attended = pastSessions.filter(s => s.attendance && s.attendance.includes(player.id)).length;
                if (attended > maxAttended) {
                    maxAttended = attended;
                    topPlayer = player.initials;
                }
            });
            document.getElementById('topAttendee').textContent = topPlayer;
        }

        function updatePersonalTrainingStats() {
            if (!currentUser) return;
            
            const player = teamData.find(p => p.name === currentUser.name);
            if (!player) return;
            
            const now = new Date();
            const pastSessions = trainingSessions.filter(s => new Date(s.date + 'T' + (s.time || '23:59')) < now);
            const attended = pastSessions.filter(s => s.attendance && s.attendance.includes(player.id)).length;
            const rate = pastSessions.length > 0 ? Math.round((attended / pastSessions.length) * 100) : 0;
            
            // Calculate streak
            let streak = 0;
            const sortedSessions = [...pastSessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            for (let session of sortedSessions) {
                if (session.attendance && session.attendance.includes(player.id)) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('personalSessionsAttended').textContent = attended;
            document.getElementById('personalAttendanceRate').textContent = rate + '%';
            document.getElementById('personalStreak').textContent = streak;
            document.getElementById('personalAttendanceBar').style.width = rate + '%';
        }

        function renderPlayersWithTraining() {
            const grid = document.getElementById('playersGrid');
            if (!grid) return;
            
            const now = new Date();
            const pastSessions = trainingSessions.filter(s => new Date(s.date + 'T' + (s.time || '23:59')) < now);
            
            grid.innerHTML = teamData.map(p => {
                const attended = pastSessions.filter(s => s.attendance && s.attendance.includes(p.id)).length;
                const rate = pastSessions.length > 0 ? Math.round((attended / pastSessions.length) * 100) : 0;
                const isReserve = p.role === 'Reserve';
                
                return `
                    <div class="player-card">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div class="player-avatar" style="background: ${isReserve ? 'linear-gradient(135deg, #9b59b6, #8e44ad)' : 'linear-gradient(135deg, var(--accent-orange), var(--primary-pink))'}; margin: 0;">
                                ${p.initials}
                            </div>
                            <div>
                                <div style="font-weight: 800;">${p.name}</div>
                                <div style="font-size: 12px; ${isReserve ? 'color: var(--reserve-color); text-transform: uppercase; letter-spacing: 1px; font-weight: 700;' : 'color: var(--text-muted);'}">
                                    ${isReserve ? '<i class="fas fa-user-clock"></i> ' + p.role : p.role}
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span style="color: var(--text-muted);">Training Attendance</span>
                                <span style="font-weight: 700; color: ${rate >= 80 ? 'var(--success)' : (rate >= 50 ? 'var(--accent-orange)' : 'var(--danger)')};">${rate}%</span>
                            </div>
                            <div class="attendance-bar">
                                <div class="attendance-fill" style="width: ${rate}%; background: ${rate >= 80 ? 'var(--success)' : (rate >= 50 ? 'var(--accent-orange)' : 'var(--danger)')}"></div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-around; text-align: center; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div>
                                <div style="font-size: 20px; font-weight: 800;">${p.played}</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Played</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: 800; color: #2ed573;">${p.won}</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Won</div>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: 800;">${attended}</div>
                                <div style="font-size: 10px; color: var(--text-muted);">Sessions</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function submitTrainingSession() {
            const date = document.getElementById('trainingDate').value;
            const time = document.getElementById('trainingTime').value;
            const type = document.getElementById('trainingType').value;
            const location = document.getElementById('trainingLocation').value.trim();
            const notes = document.getElementById('trainingNotes').value.trim();
            
            if (!date) return showToast('Select a date', 'error');
            if (!location) return showToast('Enter location', 'error');
            
            const newSession = {
                id: Date.now(),
                date,
                time: time || '19:00',
                type,
                location,
                notes,
                createdBy: currentUser.name,
                timestamp: new Date().toISOString(),
                attendance: []
            };
            
            trainingSessions.push(newSession);
            closeAddTrainingModal();
            await persistData();
            renderTraining();
            showToast('Practice session scheduled', 'success');
        }

        function renderTraining() {
            const now = new Date();
            let sessions = trainingSessions.filter(s => {
                const sessionDate = new Date(s.date + 'T' + s.time);
                if (currentTrainingFilter === 'upcoming') return sessionDate >= now;
                if (currentTrainingFilter === 'past') return sessionDate < now;
                return true;
            }).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            
            const container = document.getElementById('trainingList');
            const isAdmin = currentUser && currentUser.isAdmin;
            
            if (!container) return;
            
            if (sessions.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border-color);">
                    <i class="fas fa-dumbbell" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No ${currentTrainingFilter} sessions</div>
                    <div style="font-size: 13px;">${currentTrainingFilter === 'upcoming' ? 'Schedule a practice session to get started' : 'No historical sessions recorded yet'}</div>
                </div>`;
            } else {
                container.innerHTML = sessions.map((s, idx) => {
                    const sessionDate = new Date(s.date + 'T' + s.time);
                    const isPast = sessionDate < now;
                    const attendance = s.attendance || [];
                    const attendanceCount = attendance.length;
                    const attendanceRate = teamData.length > 0 ? Math.round((attendanceCount / teamData.length) * 100) : 0;
                    
                    let typeColor = '#e94560';
                    let typeIcon = 'fa-dumbbell';
                    let bgGradient = 'rgba(233,69,96,0.1)';
                    
                    switch(s.type) {
                        case 'Theory & Tactics': typeColor = '#9b59b6'; typeIcon = 'fa-chess'; bgGradient = 'rgba(155,89,182,0.1)'; break;
                        case 'Practice Match': typeColor = '#e94560'; typeIcon = 'fa-trophy'; bgGradient = 'rgba(233,69,96,0.1)'; break;
                        case 'Team Building': typeColor = '#2ed573'; typeIcon = 'fa-users'; bgGradient = 'rgba(46,213,115,0.1)'; break;
                        case 'Fitness': typeColor = '#3498db'; typeIcon = 'fa-heart-pulse'; bgGradient = 'rgba(52,152,219,0.1)'; break;
                        case 'Open Table': typeColor = '#f39c12'; typeIcon = 'fa-table'; bgGradient = 'rgba(243,156,18,0.1)'; break;
                        case 'Drills & Skills': typeColor = '#e67e22'; typeIcon = 'fa-bullseye'; bgGradient = 'rgba(230,126,34,0.1)'; break;
                    }
                    
                    // Build attendance avatars
                    let avatarsHtml = '';
                    if (attendanceCount > 0) {
                        const maxDisplay = 3;
                        const displayAttendees = attendance.slice(0, maxDisplay);
                        avatarsHtml = `<div class="attendance-avatars" style="margin-right: 12px;">`;
                        displayAttendees.forEach(playerId => {
                            const player = teamData.find(p => p.id === playerId);
                            if (player) {
                                avatarsHtml += `<div class="mini-avatar" style="background: ${player.role === 'Reserve' ? 'linear-gradient(135deg, #9b59b6, #8e44ad)' : 'linear-gradient(135deg, var(--accent-orange), var(--primary-pink))'};">${player.initials}</div>`;
                            }
                        });
                        if (attendanceCount > maxDisplay) {
                            avatarsHtml += `<div class="mini-avatar more">+${attendanceCount - maxDisplay}</div>`;
                        }
                        avatarsHtml += `</div>`;
                    }
                    
                    return `
                    <div class="fixture-card" style="animation-delay: ${idx * 0.05}s; ${isPast ? 'opacity: 0.8;' : ''} border-left: 3px solid ${typeColor}; background: linear-gradient(135deg, ${bgGradient} 0%, transparent 100%);">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <div class="fixture-date" style="min-width: 60px; text-align: center; margin-right: 16px;">
                                <div class="date-day" style="color: ${typeColor};">${new Date(s.date).getDate()}</div>
                                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">${new Date(s.date).toLocaleString('default', {month: 'short'})}</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 800; font-size: 16px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    <i class="fas ${typeIcon}" style="color: ${typeColor};"></i> ${s.type}
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 2px;">
                                    <i class="fas fa-clock" style="margin-right: 4px;"></i> ${s.time}
                                </div>
                                <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 4px;">
                                    <i class="fas fa-location-dot" style="margin-right: 4px; color: var(--primary-pink);"></i> ${s.location}
                                </div>
                                ${s.notes ? `<div style="font-size: 12px; color: var(--text-secondary); font-style: italic; background: rgba(255,255,255,0.03); padding: 6px 8px; border-radius: 6px; margin-top: 4px;"><i class="fas fa-note-sticky" style="margin-right: 4px;"></i> ${s.notes}</div>` : ''}
                                
                                ${isPast ? `
                                <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    <div class="attendance-indicator ${attendanceRate >= 80 ? '' : (attendanceRate >= 50 ? 'partial' : 'low')}" style="margin: 0;">
                                        <i class="fas fa-users"></i> ${attendanceCount}/${teamData.length} attended (${attendanceRate}%)
                                    </div>
                                    ${isAdmin ? `<button onclick="openAttendanceModal(${s.id})" style="background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); color: #00ffff; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 700;">
                                        <i class="fas fa-edit"></i> Edit Attendance
                                    </button>` : ''}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                            ${!isPast ? `
                                <div style="color: ${typeColor}; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Upcoming</div>
                                ${isAdmin ? `
                                <button onclick="openAttendanceModal(${s.id})" style="background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); color: #00ffff; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 700;">
                                    <i class="fas fa-clipboard-check"></i> Attendance
                                </button>
                                <button onclick="deleteTrainingSession(${s.id})" style="background: rgba(255,71,87,0.1); border: 1px solid rgba(255,71,87,0.3); color: #ff4757; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" title="Delete Session">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            ` : avatarsHtml}
                        </div>
                    </div>`;
                }).join('');
            }
            
            updateTrainingStats();
            
            const lastUpdated = document.getElementById('trainingLastUpdated');
            if (lastUpdated) {
                lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            }
        }

        function filterTraining(type, btn) {
            currentTrainingFilter = type;
            document.querySelectorAll('#trainingTab .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTraining();
        }

        async function deleteTrainingSession(id) {
            if (!confirm('Delete this practice session?')) return;
            trainingSessions = trainingSessions.filter(s => s.id !== id);
            await persistData();
            renderTraining();
            showToast('Session deleted');
        }

        function openOpponentManager() {
            renderOpponentsList();
            document.getElementById('opponentManagerModal').classList.add('show');
        }
        
        function closeOpponentManager() {
            document.getElementById('opponentManagerModal').classList.remove('show');
        }
        
        function renderOpponentsList() {
            const container = document.getElementById('opponentsListContainer');
            const count = opponentsList.length;
            
            document.getElementById('opponentCountHeader').textContent = `Current Opponents (${count})`;
            
            if (opponentsList.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">No opponents configured</div>';
                return;
            }
            
            container.innerHTML = opponentsList.map((opp) => `
                <div class="opponent-item">
                    <span class="opponent-name">${opp}</span>
                    <button class="opponent-delete" onclick="removeOpponent('${opp}')" title="Remove ${opp}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }
        
        async function addOpponent() {
            const input = document.getElementById('newOpponentName');
            const name = input.value.trim();
            
            if (!name) {
                showToast('Enter opponent name', 'error');
                return;
            }
            
            if (opponentsList.includes(name)) {
                showToast('Opponent already exists', 'error');
                return;
            }
            
            opponentsList.push(name);
            
            if (name !== 'BYE') {
                leagueData.push({
                    id: leagueData.length + 1,
                    name: name,
                    played: 0,
                    won: 0,
                    lost: 0,
                    points: 0,
                    isUs: false
                });
            }
            
            input.value = '';
            renderOpponentsList();
            await persistData();
            updateAllDisplays();
        }
        
        async function removeOpponent(name) {
            if (!confirm(`Remove "${name}" from opponents?\n\nExisting fixtures will remain but marked as [Removed].`)) {
                return;
            }
            
            opponentsList = opponentsList.filter(opp => opp !== name);
            
            const leagueIndex = leagueData.findIndex(t => t.name === name);
            if (leagueIndex > -1) {
                const hasFixtures = fixturesData.some(f => f.opponent === name);
                if (hasFixtures) {
                    leagueData[leagueIndex].name = '[Removed Team]';
                    leagueData[leagueIndex].isRemoved = true;
                } else {
                    leagueData.splice(leagueIndex, 1);
                }
            }
            
            renderOpponentsList();
            await persistData();
            updateAllDisplays();
        }

        async function addNewUser() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            const username = prompt('Enter new username (no spaces):');
            if (!username) return;
            
            if (teamCredentials[username]) {
                return showToast('Username already exists', 'error');
            }
            
            const name = prompt('Enter full name:');
            if (!name) return;
            
            const role = prompt('Select role:\n1. Player\n2. Co-Captain\n3. Captain\n4. Reserve', 'Player');
            if (!role) return;
            
            let normalizedRole = 'Player';
            let isAdmin = false;
            
            if (role === '2' || role.toLowerCase().includes('co')) {
                normalizedRole = 'Co-Captain';
                isAdmin = true;
            } else if (role === '3' || role.toLowerCase().includes('captain')) {
                normalizedRole = 'Captain';
                isAdmin = true;
            } else if (role === '4' || role.toLowerCase().includes('reserve')) {
                normalizedRole = 'Reserve';
                isAdmin = false;
            }
            
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 3);
            const tempPassword = Math.random().toString(36).slice(-8);
            
            teamCredentials[username] = {
                password: tempPassword,
                name: name,
                role: normalizedRole,
                isAdmin: isAdmin,
                initials: initials,
                isSystemCreator: false
            };
            
            teamData.push({
                id: teamData.length + 1,
                name: name,
                initials: initials,
                role: normalizedRole,
                played: 0,
                won: 0,
                lost: 0,
                winRate: 0,
                trainingAttended: 0
            });
            
            await persistData();
            updateAllDisplays();
            alert(`User created successfully!\n\nUsername: ${username}\nPassword: ${tempPassword}\nRole: ${normalizedRole}`);
        }

        async function removeUser() {
            if (!currentUser || !currentUser.isSystemCreator) {
                showToast('System Creator access required', 'error');
                return;
            }
            
            const username = prompt('Enter username to REMOVE:');
            if (!username) return;
            
            if (!teamCredentials[username]) {
                return showToast('User not found', 'error');
            }
            
            if (teamCredentials[username].isSystemCreator) {
                return showToast('Cannot remove System Creator account', 'error');
            }
            
            if (username === currentUser.username) {
                return showToast('Cannot remove yourself', 'error');
            }
            
            const userName = teamCredentials[username].name;
            
            if (!confirm(`Are you sure you want to permanently delete:\n\nUsername: ${username}\nName: ${userName}\n\nThis action cannot be undone!`)) {
                return;
            }
            
            delete teamCredentials[username];
            
            teamData = teamData.filter(p => p.name !== userName);
            
            await persistData();
            updateAllDisplays();
            showToast(`User ${username} removed`);
        }

        function openRoleManager() {
            const canAccess = currentUser && (currentUser.username === 'BDannatt' || currentUser.isSystemCreator);
            if (!canAccess) {
                showToast('Only Captain and System Creator can manage roles', 'error');
                return;
            }
            
            renderUserRoles();
            document.getElementById('roleManagerModal').classList.add('show');
        }

        function closeRoleManager() {
            document.getElementById('roleManagerModal').classList.remove('show');
        }

        function renderUserRoles() {
            const container = document.getElementById('userRolesList');
            
            const users = Object.entries(teamCredentials).map(([username, data]) => ({
                username,
                ...data
            }));
            
            container.innerHTML = users.map(u => {
                const isReserve = u.role === 'Reserve';
                const roleColor = u.isSystemCreator ? '#00ffff' : (u.isAdmin ? '#ffd700' : (isReserve ? '#9b59b6' : '#a0a0b8'));
                
                return `
                <div class="opponent-item" style="padding: 12px; display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center;">
                    <div>
                        <div style="font-weight: 800;">${u.name}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">@${u.username}</div>
                    </div>
                    <div style="font-size: 11px; color: ${roleColor}; text-transform: uppercase; letter-spacing: 1px;">
                        ${u.role}
                    </div>
                    <select onchange="updateUserRole('${u.username}', this.value)" 
                            style="background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; padding: 6px; border-radius: 6px; font-size: 12px; cursor: pointer;"
                            ${u.isSystemCreator ? 'disabled title="Cannot modify System Creator"' : ''}>
                        <option value="Player" ${u.role === 'Player' ? 'selected' : ''}>Player</option>
                        <option value="Co-Captain" ${u.role.includes('Co-Captain') && !u.role.includes('System') ? 'selected' : ''}>Co-Captain</option>
                        <option value="Captain" ${u.role === 'Captain' ? 'selected' : ''}>Captain</option>
                        <option value="Reserve" ${u.role === 'Reserve' ? 'selected' : ''}>Reserve</option>
                        <option value="System Creator + Co-Captain" ${u.isSystemCreator ? 'selected' : ''} disabled>System Creator</option>
                    </select>
                </div>
            `}).join('');
        }

        async function updateUserRole(username, newRole) {
            if (!teamCredentials[username]) return;
            
            const user = teamCredentials[username];
            
            if (user.isSystemCreator && !currentUser.isSystemCreator) {
                showToast('Only System Creator can modify other System Creators', 'error');
                renderUserRoles();
                return;
            }
            
            user.role = newRole;
            user.isAdmin = newRole.includes('Captain');
            
            const player = teamData.find(p => p.name === user.name);
            if (player) {
                player.role = newRole;
            }
            
            if (currentUser.username === username) {
                currentUser.role = newRole;
                currentUser.isAdmin = user.isAdmin;
                document.getElementById('dropdownUserRole').textContent = newRole;
                document.getElementById('profileRoleText').textContent = newRole;
                
                // Apply Reserve color if needed
                if (newRole === 'Reserve') {
                    document.getElementById('dropdownUserRole').classList.add('reserve');
                    document.getElementById('profileRoleText').style.color = 'var(--reserve-color)';
                } else {
                    document.getElementById('dropdownUserRole').classList.remove('reserve');
                    document.getElementById('profileRoleText').style.color = '';
                }
            }
            
            await persistData();
            renderUserRoles();
            updateAllDisplays();
            showToast(`Updated ${username} to ${newRole}`);
        }

        function updateAdminPanelVisibility() {
            const canManageRoles = currentUser && (currentUser.username === 'BDannatt' || currentUser.isSystemCreator);
            const btn = document.getElementById('manageRolesBtn');
            if (btn) {
                btn.style.display = canManageRoles ? 'flex' : 'none';
            }
        }

        async function submitMatchResult() {
            const opponent = document.getElementById('resultOpponent').value;
            const venue = document.getElementById('resultVenue').value;
            
            if (!opponent) return showToast('Select opponent', 'error');
            
            const isBye = opponent === 'BYE';
            const ourScore = isBye ? 0 : parseInt(document.getElementById('ourScore').value);
            const theirScore = isBye ? 0 : parseInt(document.getElementById('theirScore').value);
            
            const newMatch = { 
                id: Date.now(),
                opponent, 
                ourScore, 
                theirScore, 
                result: isBye ? 'BYE' : (ourScore > theirScore ? 'W' : 'L'), 
                date: document.getElementById('resultDate').value,
                venue: isBye ? 'home' : venue,
                played: true,
                isBye: isBye,
                timestamp: new Date().toISOString()
            };
            
            fixturesData.push(newMatch);
            
            leagueData[0].played++;
            if (!isBye && ourScore > theirScore) { 
                leagueData[0].won++; 
                leagueData[0].points += 2; 
            } else if (!isBye && ourScore < theirScore) {
                leagueData[0].lost++;
            }
            
            if (!isBye) {
                const oppTeam = leagueData.find(t => t.name === opponent);
                if (oppTeam) {
                    oppTeam.played++;
                    if (theirScore > ourScore) {
                        oppTeam.won++;
                        oppTeam.points += 2;
                    } else {
                        oppTeam.lost++;
                    }
                }
            }
            
            closeAddResultModal();
            await persistData();
            updateAllDisplays();
            
            document.getElementById('newResultBadge').style.display = 'inline-block';
            setTimeout(() => {
                document.getElementById('newResultBadge').style.display = 'none';
            }, 5000);
            
            showToast(isBye ? 'BYE recorded (0 points)' : 'Result saved & synced', 'success');
        }

        async function submitSchedule() {
            const opponent = document.getElementById('scheduleOpponent').value;
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value || '20:00';
            
            if (!opponent) return showToast('Select opponent', 'error');
            if (!date) return showToast('Select date', 'error');
            
            const isBye = opponent === 'BYE';
            
            fixturesData.push({ 
                id: Date.now(),
                opponent: opponent, 
                date: date, 
                time: isBye ? null : time,
                venue: isBye ? 'home' : document.getElementById('scheduleVenue').value,
                played: false,
                isBye: isBye,
                timestamp: new Date().toISOString()
            });
            
            closeScheduleModal();
            await persistData();
            updateAllDisplays();
            showToast(isBye ? 'BYE week scheduled' : `Match scheduled for ${time}`, 'success');
        }

        async function updatePlayerStat(id, stat, val) {
            const player = teamData.find(p => p.id === id);
            if (player) { 
                player[stat] = parseInt(val) || 0; 
                player.played = player.won + player.lost;
                player.winRate = player.played > 0 ? Math.round((player.won/player.played)*100) : 0; 
            }
            await persistData();
        }

        async function submitAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            
            if (!title || !content) return showToast('Fill all fields', 'error');
            
            announcements.unshift({ 
                id: Date.now(),
                title, 
                content, 
                date: new Date(),
                author: currentUser.name
            });
            closeAnnouncementsModal();
            await persistData();
            showToast('Announcement posted', 'success');
        }

        function logToConsole(msg, type = 'info') {
            const c = document.getElementById('dbConsole');
            if (!c) return;
            
            const timestamp = new Date().toLocaleTimeString();
            let color = '#00ffff';
            if (type === 'error') color = '#ff4757';
            if (type === 'success') color = '#2ed573';
            if (type === 'warning') color = '#ffa500';
            
            c.innerHTML += `<div style="margin-top: 4px; color: ${color};">[${timestamp}] ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        function clearConsole() {
            const c = document.getElementById('dbConsole');
            c.innerHTML = '<div style="color: #00ff00;">> Console cleared...</div>';
        }

        function exportDatabase() {
            const data = {
                teamData,
                leagueData,
                fixturesData,
                announcements,
                opponentsList,
                trainingSessions,
                exportedAt: new Date().toISOString(),
                version: '2.1'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rack_cafe_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('JSON exported');
        }

        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = async event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.teamData || !data.leagueData || !data.fixturesData) {
                            throw new Error('Invalid database structure');
                        }
                        
                        if (!confirm('This will overwrite ALL current data. Continue?')) return;
                        
                        teamData = data.teamData.map(p => ({...p, trainingAttended: p.trainingAttended || 0}));
                        leagueData = data.leagueData;
                        fixturesData = data.fixturesData;
                        if (data.announcements) announcements = data.announcements;
                        if (data.opponentsList) opponentsList = data.opponentsList;
                        if (data.trainingSessions) trainingSessions = data.trainingSessions.map(s => ({...s, attendance: s.attendance || []}));
                        
                        await persistData();
                        updateAllDisplays();
                        showToast('Database restored');
                    } catch(err) {
                        showToast('Import failed', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportCSV() {
            let csv = 'Player,Role,Played,Won,Lost,Win Rate,Training Attended\n';
            teamData.forEach(p => {
                csv += `${p.name},${p.role},${p.played},${p.won},${p.lost},${p.winRate}%,${p.trainingAttended || 0}\n`;
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rack_cafe_stats_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('CSV exported');
        }

        function resetUserPassword() {
            const username = prompt('Enter username to reset:');
            if (!username || !teamCredentials[username]) {
                return showToast('User not found', 'error');
            }
            
            const newPass = prompt(`Enter new password for ${username}:`);
            if (!newPass || newPass.trim() === '') {
                return showToast('Password reset cancelled', 'error');
            }
            
            teamCredentials[username].password = newPass;
            showToast(`Password updated for ${username}`);
        }

        function toggleAdminRights() {
            const username = prompt('Enter username to modify:');
            if (!username || !teamCredentials[username]) {
                return showToast('User not found', 'error');
            }
            
            const user = teamCredentials[username];
            const currentlyAdmin = user.isAdmin;
            
            if (confirm(`${username} is currently ${currentlyAdmin ? 'ADMIN' : 'STANDARD USER'}\n\nToggle?`)) {
                user.isAdmin = !currentlyAdmin;
                showToast('Rights updated');
            }
        }

        async function seedTestData() {
            if (!confirm('Generate 5 random test matches?')) return;
            
            for(let i=0; i<5; i++) {
                const ourScore = Math.floor(Math.random() * 6);
                const theirScore = Math.floor(Math.random() * 6);
                const opponent = opponentsList.filter(o => o !== 'BYE')[Math.floor(Math.random() * (opponentsList.length - 1))];
                const date = new Date(Date.now() - Math.random() * 1000000000);
                
                fixturesData.push({
                    id: Date.now() + i,
                    opponent: opponent,
                    ourScore: ourScore,
                    theirScore: theirScore,
                    result: ourScore > theirScore ? 'W' : (ourScore < theirScore ? 'L' : 'D'),
                    date: date.toISOString().split('T')[0],
                    time: '20:00',
                    played: true,
                    timestamp: new Date().toISOString()
                });
                
                leagueData[0].played++;
                if (ourScore > theirScore) {
                    leagueData[0].won++;
                    leagueData[0].points += 2;
                } else if (ourScore < theirScore) {
                    leagueData[0].lost++;
                }
            }
            
            // Add some test training sessions with attendance
            for(let i=0; i<3; i++) {
                const date = new Date(Date.now() - (i * 7 * 24 * 60 * 60 * 1000));
                const attendance = teamData.map(p => p.id).filter(() => Math.random() > 0.3);
                
                trainingSessions.push({
                    id: Date.now() + i + 1000,
                    date: date.toISOString().split('T')[0],
                    time: '19:00',
                    type: 'Practice Match',
                    location: 'Rack Café - Table 3',
                    notes: 'Test session',
                    createdBy: 'System',
                    timestamp: new Date().toISOString(),
                    attendance: attendance
                });
            }
            
            await persistData();
            updateAllDisplays();
            showToast('Test data added');
        }

        async function recalculateStats() {
            leagueData.forEach(team => {
                if (!team.isUs) {
                    team.played = 0;
                    team.won = 0;
                    team.lost = 0;
                    team.points = 0;
                }
            });
            
            leagueData[0].played = 0;
            leagueData[0].won = 0;
            leagueData[0].lost = 0;
            leagueData[0].points = 0;
            
            fixturesData.forEach(match => {
                if (!match.played) return;
                
                leagueData[0].played++;
                if (!match.isBye && match.ourScore > match.theirScore) {
                    leagueData[0].won++;
                    leagueData[0].points += 2;
                } else if (!match.isBye && match.ourScore < match.theirScore) {
                    leagueData[0].lost++;
                }
                
                const opp = leagueData.find(t => t.name === match.opponent);
                if (opp && !match.isBye) {
                    opp.played++;
                    if (match.theirScore > match.ourScore) {
                        opp.won++;
                        opp.points += 2;
                    } else if (match.theirScore < match.ourScore) {
                        opp.lost++;
                    }
                }
            });
            
            // Recalculate training attendance
            teamData.forEach(player => {
                const attended = trainingSessions.filter(s => s.attendance && s.attendance.includes(player.id)).length;
                player.trainingAttended = attended;
            });
            
            await persistData();
            updateAllDisplays();
            showToast('Stats recalculated');
        }

        function verifyIntegrity() {
            const issues = [];
            
            teamData.forEach(p => {
                if (p.played !== p.won + p.lost) {
                    issues.push(`${p.name}: Stats mismatch`);
                }
            });
            
            fixturesData.forEach((f, idx) => {
                if (!f.isBye && (f.ourScore > 9 || f.theirScore > 9)) {
                    issues.push(`Match ${idx}: Invalid score`);
                }
            });
            
            const ourTeam = leagueData[0];
            const playedMatches = fixturesData.filter(f => f.played).length;
            if (ourTeam.played !== playedMatches) {
                issues.push(`Count mismatch: ${ourTeam.played} vs ${playedMatches}`);
            }
            
            if (issues.length === 0) {
                showToast('Data verified');
            } else {
                showToast(`${issues.length} issues found`, 'error');
            }
        }

        async function archiveSeason() {
            const seasonName = prompt('Enter season name (e.g., "2024/25"):');
            if (!seasonName) return;
            
            const archive = {
                season: seasonName,
                archivedAt: new Date().toISOString(),
                data: {
                    teamData: JSON.parse(JSON.stringify(teamData)),
                    leagueData: JSON.parse(JSON.stringify(leagueData)),
                    fixturesData: JSON.parse(JSON.stringify(fixturesData)),
                    announcements: JSON.parse(JSON.stringify(announcements)),
                    opponentsList: [...opponentsList],
                    trainingSessions: JSON.parse(JSON.stringify(trainingSessions))
                }
            };
            
            let archives = JSON.parse(localStorage.getItem('rackCafe_archives') || '[]');
            archives.push(archive);
            localStorage.setItem('rackCafe_archives', JSON.stringify(archives));
            
            // Also save to Firestore archive collection
            if (isOnline) {
                try {
                    await db.collection('rackCafe_archives').add(archive);
                    showToast('Season archived to cloud');
                } catch (e) {
                    showToast('Saved locally (cloud backup failed)');
                }
            } else {
                showToast('Season archived locally');
            }
        }

        async function clearFixturesOnly() {
            if (!confirm('Delete ALL fixtures?')) return;
            if (prompt('Type DELETE to confirm:') !== 'DELETE') return;
            
            fixturesData = [];
            await persistData();
            updateAllDisplays();
            showToast('Fixtures cleared');
        }

        async function clearStatsOnly() {
            if (!confirm('Reset ALL statistics to zero?')) return;
            
            teamData.forEach(p => {
                p.played = 0;
                p.won = 0;
                p.lost = 0;
                p.winRate = 0;
                p.trainingAttended = 0;
            });
            
            leagueData.forEach(t => {
                t.played = 0;
                t.won = 0;
                t.lost = 0;
                t.points = 0;
            });
            
            trainingSessions.forEach(s => {
                s.attendance = [];
            });
            
            await persistData();
            updateAllDisplays();
            showToast('Stats reset');
        }

        async function updateTeamConfig() {
            const newName = prompt('Team name:', leagueData[0].name);
            const newSeason = prompt('Season:', '2025/26');
            
            if (newName) {
                leagueData[0].name = newName;
                document.querySelectorAll('.header-title h2').forEach(el => el.textContent = newName);
                document.querySelector('.login-header h1').textContent = newName;
                document.title = `${newName} - Pool League`;
            }
            
            if (newSeason) {
                document.getElementById('fixtureSeasonText').textContent = `${newSeason} Season`;
            }
            
            await persistData();
            updateAllDisplays();
        }

        async function viewAuditLog() {
            const lastSync = localStorage.getItem(LAST_SYNC_KEY);
            const logs = [
                `Last backup: ${lastSync ? new Date(lastSync).toLocaleString() : 'Never'}`,
                `Total fixtures: ${fixturesData.length}`,
                `Training sessions: ${trainingSessions.length}`,
                `Database size: ${(JSON.stringify({teamData, leagueData, fixturesData, trainingSessions}).length / 1024).toFixed(2)} KB`,
                `Active opponents: ${opponentsList.length}`,
                `Current session: ${currentUser ? currentUser.name : 'None'}`,
                `Device ID: ${DEVICE_ID}`,
                `Online status: ${isOnline ? 'Online' : 'Offline'}`
            ];
            
            logs.forEach(log => logToConsole(log, 'info'));
        }

        async function nukeDatabase() {
            if (prompt('Type NUKE to confirm total destruction:') !== 'NUKE') {
                return;
            }
            
            fixturesData = [];
            trainingSessions = [];
            announcements = [];
            opponentsList = [];
            teamData.forEach(p => {
                p.played = 0;
                p.won = 0;
                p.lost = 0;
                p.winRate = 0;
                p.trainingAttended = 0;
            });
            leagueData.forEach(t => {
                t.played = 0;
                t.won = 0;
                t.lost = 0;
                t.points = 0;
            });
            
            await persistData();
            updateAllDisplays();
            showToast('Database nuked');
        }

        function updateAllDisplays() {
            const us = leagueData[0];
            
            const playedEl = document.getElementById('statPlayed');
            const wonEl = document.getElementById('statWon');
            
            if (playedEl) animateValue('statPlayed', parseInt(playedEl.textContent), us.played);
            if (wonEl) animateValue('statWon', parseInt(wonEl.textContent), us.won);
            
            const winRate = us.played > 0 ? Math.round((us.won/us.played)*100) : 0;
            const winRateEl = document.getElementById('statWinRate');
            if (winRateEl) winRateEl.textContent = winRate + '%';
            
            const sorted = [...leagueData].filter(t => !t.isRemoved).sort((a,b) => b.points - a.points || b.won - a.won);
            const pos = sorted.findIndex(t => t.isUs) + 1;
            const posEl = document.getElementById('statPosition');
            if (posEl) animateValue('statPosition', parseInt(posEl.textContent) || 0, pos || 1);
            
            const upcoming = fixturesData.filter(f => !f.played).sort((a,b) => {
                const dateA = new Date(a.date + 'T' + (a.time || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.time || '00:00'));
                return dateA - dateB;
            })[0];
            
            const nextOppEl = document.getElementById('nextMatchOpponent');
            const nextDateEl = document.getElementById('nextMatchDate');
            const nextTimeEl = document.getElementById('nextMatchTime');
            const nextVenueEl = document.getElementById('nextMatchVenue');
            
            if (upcoming) {
                if (upcoming.isBye) {
                    if (nextOppEl) nextOppEl.innerHTML = '<span style="color: #ffd700;"><i class="fas fa-umbrella-beach"></i> BYE WEEK</span>';
                    if (nextDateEl) nextDateEl.textContent = new Date(upcoming.date).toLocaleDateString();
                    if (nextTimeEl) nextTimeEl.textContent = 'Rest Week';
                    if (nextVenueEl) nextVenueEl.textContent = 'N/A';
                    document.getElementById('countdownContainer').style.display = 'none';
                } else {
                    if (nextOppEl) nextOppEl.textContent = upcoming.opponent;
                    if (nextDateEl) nextDateEl.textContent = new Date(upcoming.date).toLocaleDateString();
                    if (nextTimeEl) nextTimeEl.textContent = upcoming.time || '20:00';
                    if (nextVenueEl) nextVenueEl.textContent = upcoming.venue === 'home' ? 'Home' : 'Away';
                    updateNextMatchCountdown();
                }
            } else {
                if (nextOppEl) nextOppEl.textContent = 'TBD';
                if (nextDateEl) nextDateEl.textContent = 'No matches scheduled';
                if (nextTimeEl) nextTimeEl.textContent = '--:--';
                document.getElementById('countdownContainer').style.display = 'none';
            }
            
            const tableBody = document.getElementById('leagueTableBody');
            if (tableBody) {
                if (sorted.length === 0) {
                    tableBody.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No teams in league</div>';
                } else {
                    tableBody.innerHTML = sorted.map((t, i) => `
                        <div class="table-row" style="${t.isUs ? 'border-left: 2px solid var(--primary-pink); background: rgba(233,69,96,0.05);' : ''}">
                            <div>${i+1}</div>
                            <div style="font-weight: ${t.isUs ? '800' : 'normal'};">${t.name}</div>
                            <div style="text-align: center;">${t.played}</div>
                            <div style="text-align: center;">${t.won}</div>
                            <div style="text-align: center;">${t.lost}</div>
                            <div style="text-align: right; font-weight: 800;">${t.points}</div>
                        </div>
                    `).join('');
                }
            }
            
            const playersGrid = document.getElementById('playersGrid');
            if (playersGrid && document.getElementById('teamTab').classList.contains('active')) {
                renderPlayersWithTraining();
            }
            
            const recent = fixturesData.filter(f => f.played).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const formList = document.getElementById('recentFormList');
            
            if (formList) {
                if (recent.length === 0) {
                    formList.innerHTML = '<div class="form-item" style="justify-content: center; color: var(--text-muted);">No matches yet</div>';
                } else {
                    formList.innerHTML = recent.map((m, idx) => `
                        <div class="form-item" style="animation-delay: ${idx * 0.1}s;">
                            <div>
                                <div style="font-weight: 700;">${m.isBye ? '<span style="color: #ffd700;"><i class="fas fa-umbrella-beach"></i> BYE WEEK</span>' : 'vs ' + m.opponent}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${new Date(m.date).toLocaleDateString()}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${m.isBye ? 
                                    '<span style="font-size: 18px; font-weight: 800; color: #ffd700;">BYE</span>' :
                                    `<span style="font-size: 18px; font-weight: 800;">${m.ourScore}-${m.theirScore}</span>
                                    <span class="${m.result === 'W' ? 'result-w' : 'result-l'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 800;">${m.result}</span>`
                                }
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            renderFixtures();
            updateLastUpdatedTimes();
            
            if (document.getElementById('trainingTab') && document.getElementById('trainingTab').classList.contains('active')) {
                renderTraining();
            }
        }

        function animateValue(id, start, end) {
            if (start === end) return;
            const obj = document.getElementById(id);
            if (!obj) return;
            obj.classList.add('updated');
            obj.textContent = end;
            setTimeout(() => obj.classList.remove('updated'), 500);
        }

        function filterFixtures(type, btn) {
            currentFilter = type;
            document.querySelectorAll('#fixturesTab .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderFixtures();
        }

        function renderFixtures() {
            const list = document.getElementById('fixturesList');
            if (!list) return;
            
            let matches = fixturesData.filter(f => {
                if (currentFilter === 'played') return f.played;
                if (currentFilter === 'upcoming') return !f.played;
                return true;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = matches.length ? matches.map((m, idx) => `
                <div class="fixture-card ${m.isBye ? 'bye-week' : ''}" style="animation-delay: ${idx * 0.05}s;">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <div class="fixture-date">
                            <div class="date-day ${m.isBye ? 'bye' : ''}">${new Date(m.date).getDate()}</div>
                            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">${new Date(m.date).toLocaleString('default', {month: 'short'})}</div>
                        </div>
                        <div style="margin-left: 16px;">
                            <div style="font-weight: 800; font-size: 16px; ${m.isBye ? 'color: #ffd700;' : ''}">
                                ${m.isBye ? '<i class="fas fa-umbrella-beach" style="margin-right: 8px;"></i>BYE WEEK' : 'vs ' + m.opponent}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                                ${m.isBye ? 
                                    '<span style="color: #ffd700;"><i class="fas fa-bed" style="margin-right: 4px;"></i>Rest week (0 pts)</span>' :
                                    `<span>${m.venue === 'home' ? '<i class="fas fa-home" style="margin-right: 4px;"></i>Home' : '<i class="fas fa-bus" style="margin-right: 4px;"></i>Away'}</span>
                                    ${m.time ? `<span class="time-badge"><i class="fas fa-clock" style="margin-right: 4px;"></i>${m.time}</span>` : ''}`
                                }
                            </div>
                        </div>
                    </div>
                    ${m.played ? 
                        `<div style="font-weight: 800; font-size: 20px; color: ${m.isBye ? '#ffd700' : (m.result === 'W' ? '#2ed573' : '#e94560')};">
                            ${m.isBye ? '<span style="font-size: 14px;">BYE</span>' : m.ourScore + '-' + m.theirScore}
                        </div>` : 
                        `<div style="color: ${m.isBye ? '#ffd700' : 'var(--accent-orange)'}; font-size: 12px; font-weight: 700;">
                            ${m.isBye ? '<i class="fas fa-star"></i> Rest Week' : '<i class="fas fa-clock"></i> Upcoming'}
                        </div>`
                    }
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No matches found</div>';
        }

        // Check connection status on load
        updateNetworkStatus(navigator.onLine);
        
        window.onload = function() { 
            updateOpponentDropdowns();
        };
    </script>
</body>
</html>
