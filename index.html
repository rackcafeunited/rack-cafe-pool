<script>
/*************************************************
 * FIREBASE INITIALISATION (COMPAT ONLY)
 *************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyAiRXtpn52GM2Rqi-FpdXvWxBjebAjd6_I",
  authDomain: "rackcafepool.firebaseapp.com",
  databaseURL: "https://rackcafepool-default-rtdb.firebaseio.com",
  projectId: "rackcafepool"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/*************************************************
 * NAV / TABS (ORIGINAL UI)
 *************************************************/
window.showSection = function (sectionId) {
  document.querySelectorAll(".section").forEach(sec => {
    sec.style.display = "none";
    sec.classList.remove("active");
  });

  const target = document.getElementById(sectionId);
  if (target) {
    target.style.display = "block";
    target.classList.add("active");
  }

  document.querySelectorAll(".nav-item").forEach(btn => {
    btn.classList.remove("active");
  });
};

/*************************************************
 * LOGIN (onclick="login()")
 *************************************************/
window.login = function () {
  const emailEl =
    document.getElementById("loginEmail") ||
    document.getElementById("loginUsername");

  const passEl = document.getElementById("loginPassword");
  const errorEl = document.getElementById("loginError");
  const btn = document.getElementById("loginBtn");

  if (!emailEl || !passEl || !errorEl) return;

  errorEl.style.display = "none";

  const email = emailEl.value.trim();
  const password = passEl.value.trim();

  if (!email || !password) {
    errorEl.textContent = "Email and password required";
    errorEl.style.display = "block";
    return;
  }

  if (btn) {
    btn.disabled = true;
    btn.innerText = "Authenticatingâ€¦";
  }

  auth.signInWithEmailAndPassword(email, password)
    .catch(err => {
      errorEl.textContent = err.message;
      errorEl.style.display = "block";
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.innerText = "Login";
      }
    });
};

/*************************************************
 * LOGOUT
 *************************************************/
window.logout = function () {
  auth.signOut().then(() => location.reload());
};

/*************************************************
 * AUTH STATE HANDLER
 *************************************************/
auth.onAuthStateChanged(async user => {
  if (!user) return;

  // Hide login / show app
  const loginScreen = document.getElementById("loginScreen");
  const appContainer = document.getElementById("appContainer");

  if (loginScreen) loginScreen.style.display = "none";
  if (appContainer) appContainer.style.display = "block";

  const username = user.email.split("@")[0];

  // Identity (only if elements exist)
  const welcome = document.getElementById("welcomeName");
  const avatar = document.getElementById("userAvatar");
  const dropdown = document.getElementById("dropdownUsername");

  if (welcome) welcome.textContent = username;
  if (avatar) avatar.textContent = username[0].toUpperCase();
  if (dropdown) dropdown.textContent = user.email;

  /*************************************************
   * USER PROFILE / ROLE
   *************************************************/
  const userRef = db.ref("users/" + user.uid);
  const snap = await userRef.get();

  if (!snap.exists()) {
    await userRef.set({
      email: user.email,
      name: username,
      role: user.email === "thayessmith@rackcafeutd.com"
        ? "system-creator"
        : "player"
    });
  }

  const profile = (await userRef.get()).val();

  // Role-based tabs
  if (["captain", "co-captain", "system-creator"].includes(profile.role)) {
    const adminTab = document.getElementById("adminTab");
    if (adminTab) adminTab.style.display = "block";
  }

  if (profile.role === "system-creator") {
    const systemTab = document.getElementById("systemTab");
    if (systemTab) systemTab.style.display = "block";
  }

  /*************************************************
   * PLAYERS LIST
   *************************************************/
  db.ref("users").on("value", snap => {
    const list = document.getElementById("playersList");
    if (!list) return;

    list.innerHTML = "";
    const users = snap.val() || {};

    Object.values(users).forEach(u => {
      const div = document.createElement("div");
      div.textContent = `${u.name} (${u.role})`;
      list.appendChild(div);
    });
  });

  // Default landing section
  showSection("dashboard");
});
</script>
